<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Celestial Consultation</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <style>
    :root {
      --primary: #047857;
      --secondary: #6EE7B7;
      --bg-body: #F0FDF4;
      --accent-gold: #D4AF37;
      --surface: #FFFFFF;
      --border: #A7F3D0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      height: 100vh;
      overflow: hidden;
      background: var(--bg-body);
    }

    input,
    button {
      font-family: inherit;
      outline: none;
    }

    .hidden {
      display: none !important;
    }

    .flex {
      display: flex;
    }

    .w-full {
      width: 100%;
    }

    #screen-login {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #065F46, #059669, #34D399);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding-bottom: 80px;
      /* Space for fixed app-footer */
      color: white;
    }

    .form-box {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .cosmic-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
    }

    .cosmic-btn {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(to right, #059669, #047857);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      color: white;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .admin-notification-popup {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background: white;
      border-left: 5px solid #10b981;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      border-radius: 8px;
      animation: slideIn 0.3s ease-out;
      min-width: 300px;
    }

    .admin-notification-popup button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 5px 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .admin-notification-popup button.approve {
      background: #10b981;
      color: white;
    }

    .admin-notification-popup button.close {
      background: #e5e7eb;
      color: #374151;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
      }

      to {
        transform: translateX(0);
      }
    }

    .dashboard-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg-body);
      position: relative;
    }

    .app-header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: none;
      color: var(--primary);
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      padding-bottom: 80px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      overflow-x: auto;
    }

    /* --- High-Conversion Astro Card --- */
    .astro-card {
      background: #FFFFFF;
      border: 1px solid #E2E8F0;
      border-left: 4px solid var(--accent-gold);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.05);
      position: relative;
      transition: transform 0.2s;
    }

    .astro-card:active {
      transform: scale(0.99);
    }

    .card-top-row {
      display: flex;
      gap: 15px;
    }

    /* Profile Image with Pulsing Status */
    .astro-img-wrapper {
      position: relative;
      width: 65px;
      height: 65px;
    }

    .astro-img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #F59E0B;
    }

    .status-badge {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 14px;
      height: 14px;
      background: #9CA3AF;
      /* Default Grey (Offline) */
      border: 2px solid white;
      border-radius: 50%;
    }

    /* Online: Green & Pulsing */
    .status-badge.online {
      background: #059669;
      /* Darker Green as requested */
      box-shadow: 0 0 0 2px white;
      /* Clean separator */
    }

    /* Active Profile Image Ring */
    .astro-img.online-active {
      border: 2px solid #059669;
      animation: pulse-border 2s infinite;
    }

    /* Busy/Offline: Red & Static */
    .status-badge.busy {
      background: #EF4444;
      box-shadow: 0 0 0 2px white;
    }

    /* Pulse Animation for Border */
    @keyframes pulse-border {
      0% {
        box-shadow: 0 0 0 0 rgba(5, 150, 105, 0.7);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(5, 150, 105, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(5, 150, 105, 0);
      }
    }

    /* Info Section */
    .astro-details {
      flex: 1;
    }

    .astro-name {
      color: #111827;
      font-family: 'Cinzel', serif;
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 2px;
    }

    .astro-expertise {
      color: #6B7280;
      font-size: 0.8rem;
      margin-bottom: 6px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .rating-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #4B5563;
    }

    .star-rating {
      color: #F59E0B;
      font-weight: bold;
    }

    /* Price Tag */
    .price-tag {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #ECFDF5;
      color: #059669;
      font-weight: 700;
      font-size: 0.85rem;
      padding: 4px 10px;
      border-radius: 20px;
    }

    /* Action Buttons Row */
    .card-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 5px;
    }

    .cta-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #E5E7EB;
      background: #F9FAFB;
      color: #6B7280;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: not-allowed;
      transition: 0.2s;
    }

    .cta-btn i {
      font-size: 1rem;
      margin-bottom: 2px;
    }

    /* Active Button Styles */
    .cta-btn.active-chat {
      background: #EFF6FF;
      border-color: #BFDBFE;
      color: #2563EB;
      cursor: pointer;
    }

    .cta-btn.active-chat:hover {
      background: #DBEAFE;
    }

    .cta-btn.active-audio {
      background: #ECFDF5;
      border-color: #A7F3D0;
      color: #059669;
      cursor: pointer;
    }

    .cta-btn.active-audio:hover {
      background: #D1FAE5;
    }

    .cta-btn.active-video {
      background: #FFFBEB;
      border-color: #FDE68A;
      color: #D97706;
      cursor: pointer;
    }

    .cta-btn.active-video:hover {
      background: #FEF3C7;
    }

    .astro-dash-header {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-row {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .toggle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .toggle-switch {
      width: 40px;
      height: 22px;
      background: #E5E7EB;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: 0.3s;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch.active {
      background: #22C55E;
    }

    .toggle-switch.active::after {
      left: 20px;
    }

    .emergency-banner {
      background: #B91C1C;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .progress-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .grid-menu {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .grid-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      font-size: 0.8rem;
      color: #555;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .grid-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #F3F4F6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #333;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .call-popup {
      background: white;
      width: 85%;
      max-width: 320px;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      animation: popUp 0.3s ease-out;
    }

    @keyframes popUp {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .caller-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: block;
    }

    .btn-accept {
      background: #22C55E;
      padding: 10px 30px;
      border-radius: 30px;
      color: white;
      font-size: 1.1rem;
      margin: 10px;
      border: none;
    }

    .btn-reject {
      background: #EF4444;
      padding: 10px 30px;
      border-radius: 30px;
      color: white;
      font-size: 1.1rem;
      margin: 10px;
      border: none;
    }

    #screen-session {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 3000;
      display: flex;
      flex-direction: column;
    }

    .video-area {
      flex: 1;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #localVideo {
      position: absolute;
      right: 20px;
      bottom: 140px;
      width: 90px;
      height: 120px;
      background: #333;
      border-radius: 12px;
      border: 2px solid white;
    }

    .controls {
      position: absolute;
      bottom: 50px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .circle-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .controls.hidden {
      display: none !important;
    }

    .admin-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .admin-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-admin {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
      flex: 1;
    }

    .btn-block {
      background: #EF4444;
    }

    .btn-wallet {
      background: #22C55E;
    }

    .btn-role {
      background: #3B82F6;
    }

    .user-pill {
      background: #F3F4F6;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      color: #555;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .chart-modal-content {
      background: #F3F4F6;
      width: 100%;
      height: 90vh;
      border-top-left-radius: 25px;
      border-top-right-radius: 25px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease-out;
    }

    .chart-header {
      padding: 20px;
      background: white;
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e5e5;
      color: #1F2937;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: #6B7280;
      cursor: pointer;
    }

    .chart-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }

    .input-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .input-row {
      display: flex;
      gap: 15px;
    }

    .input-row label {
      display: block;
      font-size: 0.85rem;
      color: #4B5563;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .app-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #D1D5DB;
      border-radius: 10px;
      font-size: 1rem;
      color: #111827;
      background: #F9FAFB;
      transition: 0.2s;
    }

    .app-input:focus {
      border-color: var(--primary);
      background: white;
    }

    .generate-btn {
      font-size: 1.1rem;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(4, 120, 87, 0.2);
    }

    .chart-tabs {
      display: flex;
      gap: 5px;
      background: white;
      padding: 5px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .c-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #6B7280;
      border-radius: 8px;
      cursor: pointer;
    }

    .c-tab.active {
      background: var(--border);
      color: #064E3B;
    }

    .rasi-container {
      position: relative;
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
    }

    .south-indian-chart {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 0;
      border: 2px solid #D97706;
      background: #FEF3C7;
      width: 100%;
      aspect-ratio: 1/1;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .center-god-icon {
      width: 60%;
      height: 60%;
      object-fit: contain;
      opacity: 0.9;
    }

    /* --- Low Balance Alert Modal --- */
    .low-balance-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    .low-balance-overlay.active {
      opacity: 1;
      pointer-events: auto;
    }

    .low-balance-card {
      background: rgba(255, 255, 255, 0.95);
      width: 85%;
      max-width: 340px;
      padding: 30px 20px;
      border-radius: 24px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: 1px solid rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
    }

    .low-balance-overlay.active .low-balance-card {
      transform: scale(1);
    }

    .alert-icon-wrapper {
      width: 70px;
      height: 70px;
      background: #FEF2F2;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 15px;
      position: relative;
    }

    .alert-icon-wrapper i {
      font-size: 32px;
      color: #EF4444;
      animation: bell-shake 1s infinite;
    }

    @keyframes bell-shake {
      0% {
        transform: rotate(0);
      }

      15% {
        transform: rotate(5deg);
      }

      30% {
        transform: rotate(-5deg);
      }

      45% {
        transform: rotate(4deg);
      }

      60% {
        transform: rotate(-4deg);
      }

      75% {
        transform: rotate(2deg);
      }

      85% {
        transform: rotate(-2deg);
      }

      100% {
        transform: rotate(0);
      }
    }

    .lb-title {
      font-size: 1.4rem;
      font-weight: 700;
      color: #1F2937;
      margin-bottom: 8px;
    }

    .lb-message {
      color: #6B7280;
      font-size: 0.95rem;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .current-bal-box {
      background: #F3F4F6;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 25px;
      display: flex;
      justify-content: center;
      align-items: baseline;
      gap: 5px;
    }

    .bal-label {
      font-size: 0.9rem;
      color: #4B5563;
    }

    .bal-amount {
      font-size: 1.5rem;
      font-weight: 700;
      color: #059669;
    }

    .btn-recharge {
      background: linear-gradient(135deg, #059669, #10B981);
      color: white;
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      margin-bottom: 12px;
      transition: transform 0.2s;
    }

    .btn-recharge:active {
      transform: scale(0.98);
    }

    .btn-dismiss {
      background: transparent;
      color: #6B7280;
      border: none;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      padding: 5px;
    }

    .SouthChartBox {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      border: 1px solid #D97706;
      overflow: hidden;
    }

    .SouthChartBox[data-center="true"] {
      background: white;
      border: none;
    }

    .s-sign-label {
      position: absolute;
      top: 1px;
      left: 2px;
      font-size: 0.6rem;
      font-weight: bold;
      color: #D97706;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .s-planet-text {
      font-size: 0.75rem;
      font-weight: 700;
      color: #111;
      line-height: 1.2;
      z-index: 2;
    }

    .asc-badge {
      color: #DC2626 !important;
    }

    .chart-center-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 900;
      color: #F59E0B;
      opacity: 0.2;
      font-size: 2rem;
      pointer-events: none;
    }

    .planet-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .planet-item {
      background: white;
      padding: 12px;
      border-radius: 10px;
      border-left: 4px solid var(--secondary);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .panchangam-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
    }

    .panchangam-grid>div {
      background: white;
      padding: 8px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 70px;
    }

    .dasha-card-highlight {
      background: white;
      padding: 20px;
      border-radius: 15px;
      border-left: 5px solid var(--primary);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .dasha-list>div {
      background: white;
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }

    .spinner-astro {
      width: 50px;
      height: 50px;
      border: 5px solid var(--border);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    .text-muted {
      color: #6c757d;
    }

    @media (max-width: 600px) {
      .panchangam-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .panchangam-grid>div:last-child:nth-child(odd) {
        grid-column: span 2;
      }
    }

    .chat-overlay {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }

    /* Horoscope UI */
    .zodiac-scroller {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 10px 0;
      scrollbar-width: none;
      /* Firefox */
      margin-bottom: 15px;
    }

    .zodiac-scroller::-webkit-scrollbar {
      display: none;
      /* Chrome/Safari */
    }

    .zodiac-item {
      flex: 0 0 auto;
      width: 70px;
      text-align: center;
      padding: 10px 5px;
      border-radius: 12px;
      background: white;
      border: 1px solid #eee;
      cursor: pointer;
      transition: all 0.2s;
    }

    .zodiac-item.active {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      color: white;
      border-color: #D97706;
      transform: scale(1.05);
      box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
    }

    .zodiac-icon {
      font-size: 1.4rem;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      color: #D97706;
    }

    .zodiac-name {
      font-size: 0.75rem;
      font-weight: 600;
    }

    .horoscope-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid #f3f4f6;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .horoscope-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #F59E0B, #ec4899);
    }

    #messagesList {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f9fafb;
      position: relative;
    }

    #birthChartColumn {
      flex: 0 0 400px;
      display: none;
      flex-direction: column;
      background: #f9fafb;
      border-left: 1px solid #eee;
      overflow-y: auto;
      max-height: 100%;
      position: relative;
    }

    /* ===== ADMIN DASHBOARD STYLES ===== */
    .admin-content-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 100px;
      background: #f8fafc;
      width: 100%;
    }

    .admin-tab-section {
      display: none;
      animation: fadeIn 0.3s ease-in;
      width: 100%;
    }

    .admin-tab-section.active {
      display: block;
      width: 100%;
    }

    .admin-tab-section h2 {
      width: 100%;
    }

    .admin-tab-section>div {
      width: 100%;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .stat-card-modern {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #f0f0f0;
      transition: all 0.3s ease;
    }

    .stat-card-modern:hover {
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }

    .admin-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: none;
      justify-content: space-around;
      padding: 12px 0;
      z-index: 100;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      max-width: 480px;
      margin: 0 auto;
      width: 100%;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }

    .admin-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      color: #9ca3af;
      font-size: 0.75rem;
      cursor: pointer;
      flex: 1;
      transition: all 0.3s ease;
      padding: 8px 0;
    }

    .admin-nav-item i {
      font-size: 1.3rem;
    }

    .admin-nav-item.active {
      color: #1e3a8a;
      font-weight: 600;
    }

    .admin-nav-item.active i {
      font-size: 1.5rem;
    }

    /* ===== ADMIN FOOTER ===== */
    .admin-footer {
      background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 0.85rem;
      border-radius: 16px;
      margin-top: 20px;
      margin-bottom: 20px;
    }

    .admin-footer.show {
      display: block;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }

    .admin-footer-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .admin-footer-section {
      display: flex;
      justify-content: space-around;
      gap: 15px;
      flex-wrap: wrap;
    }

    .admin-footer-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      opacity: 0.9;
      transition: opacity 0.3s;
    }

    .admin-footer-item:hover {
      opacity: 1;
    }

    .admin-footer-item i {
      font-size: 1.2rem;
    }

    .admin-footer-divider {
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
      margin: 8px 0;
    }

    .admin-footer-bottom {
      font-size: 0.75rem;
      opacity: 0.8;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding-top: 10px;
      margin-top: 10px;
    }

    /* ===== RESPONSIVE DESIGN ===== */
    @media (max-width: 768px) {
      .dashboard-container {
        max-width: 100%;
      }

      .admin-content-area {
        padding: 15px;
        padding-bottom: 120px;
      }

      .stat-card-modern {
        padding: 16px;
      }

      .admin-nav {
        padding: 10px 0;
      }

      .admin-nav-item span {
        font-size: 0.7rem;
      }

      .admin-nav-item i {
        font-size: 1.2rem;
      }
    }

    @media (max-width: 768px) {

      /* Dashboard grid responsive */
      .admin-tab-section>div>div[style*="grid"] {
        grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)) !important;
        gap: 10px !important;
        padding: 0 5px !important;
      }
    }

    @media (max-width: 480px) {
      .admin-content-area {
        padding: 12px;
        padding-bottom: 130px;
      }

      .stat-card-modern {
        padding: 12px;
        min-height: auto;
      }

      /* Dashboard grid on mobile - single column */
      .admin-tab-section>div>div[style*="grid"] {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        max-width: 100% !important;
        padding: 0 !important;
      }

      .admin-nav {
        padding: 8px 0;
      }

      .admin-nav-item {
        gap: 4px;
      }

      .admin-nav-item span {
        font-size: 0.65rem;
      }

      .admin-nav-item i {
        font-size: 1.1rem;
      }

      .admin-footer {
        padding: 15px;
      }

      .admin-footer-section {
        gap: 10px;
      }

      .admin-footer-item {
        font-size: 0.75rem;
      }

      .admin-footer-item i {
        font-size: 1rem;
      }
    }

    /* ===== ADMIN CARDS ===== */
    .admin-user-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #f0f0f0;
      transition: all 0.3s ease;
    }

    .admin-user-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .admin-user-name {
      font-weight: 600;
      color: #1f2937;
      font-size: 0.95rem;
    }

    .admin-user-role {
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      color: #6b7280;
      font-weight: 500;
    }

    .admin-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-admin {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-admin:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-block {
      background: #ef4444;
    }

    .btn-wallet {
      background: #22c55e;
    }

    .btn-role {
      background: #3b82f6;
    }

    .btn-delete {
      background: #dc2626;
    }

    /* ===== LEDGER TABLE ===== */
    .admin-ledger-table {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      border: 1px solid #f0f0f0;
    }

    .admin-ledger-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .admin-ledger-table thead {
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }

    .admin-ledger-table th {
      padding: 12px 15px;
      text-align: left;
      color: #6b7280;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .admin-ledger-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #f0f0f0;
      color: #374151;
    }

    .admin-ledger-table tbody tr:hover {
      background: #f9fafb;
    }

    /* ===== WITHDRAWAL SECTION ===== */
    .withdrawal-card {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #fcd34d;
    }

    .withdrawal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .withdrawal-amount {
      font-size: 1.3rem;
      font-weight: 700;
      color: #92400e;
    }

    .withdrawal-actions {
      display: flex;
      gap: 8px;
    }

    .btn-approve {
      background: #22c55e;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .btn-reject {
      background: #ef4444;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* ===== RESPONSIVE TABLE ===== */
    @media (max-width: 768px) {
      table {
        font-size: 0.85rem;
      }

      table thead {
        display: none;
      }

      table tbody tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
        background: white;
      }

      table tbody td {
        display: block;
        padding: 12px 15px;
        text-align: right;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
        padding-left: 50%;
      }

      table tbody td:before {
        content: attr(data-label);
        position: absolute;
        left: 15px;
        font-weight: 700;
        color: #374151;
        text-align: left;
      }

      table tbody td:last-child {
        border-bottom: none;
      }
    }

    @media (max-width: 480px) {
      table {
        font-size: 0.8rem;
      }

      table tbody td {
        padding: 10px 12px;
        padding-left: 45%;
      }

      table tbody td:before {
        left: 12px;
        font-size: 0.75rem;
      }
    }

    .chip-btn {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      padding: 6px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #374151;
      font-weight: 500;
      transition: all 0.2s;
    }

    .chip-btn:hover,
    .chip-btn:active {
      background: #d1fae5;
      color: #047857;
      border-color: #10b981;
    }
  </style>
</head>

<body>

  <!-- Screen: Login -->
  <div id="screen-login">
    <div class="form-box">
      <h2>‚ú®Astro5 Login</h2>
      <div id="step-phone">
        <input id="inputPhone" class="cosmic-input" placeholder="Mobile Number" value="">
        <button id="btnSendOtp" class="cosmic-btn">Get OTP</button>

      </div>
      <div id="step-otp" class="hidden">
        <input id="inputOtp" class="cosmic-input" placeholder="OTP" value="">
        <button id="btnVerifyOtp" class="cosmic-btn">Verify</button>
      </div>
    </div>

  </div>

  <div class="app-footer">
    <div class="footer-links">
      <a href="https://astro5star.com/terms-condition" target="_blank">Terms</a>
      <span class="sep">|</span>
      <a href="https://astro5star.com/refund-cancellation-policy" target="_blank">Refunds</a>
      <span class="sep">|</span>
      <a href="https://astro5star.com/shipping-policy" target="_blank">Shipping</a>
      <span class="sep">|</span>
      <a href="https://astro5star.com/return-policy" target="_blank">Returns</a>
    </div>
    <div class="footer-copy">&copy; 2024 Astro5Star</div>
  </div>
  </div>

  <style>
    /* App Footer Styling */
    .app-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(5px);
      padding: 15px 10px;
      text-align: center;
      border-top: 1px solid rgba(0, 0, 0, 0.05);
      z-index: 50;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      font-size: 0.75rem;
      color: #6B7280;
      margin-bottom: 5px;
    }

    .footer-links a {
      color: #6B7280;
      text-decoration: none;
      font-weight: 500;
      transition: color 0.2s;
    }

    .footer-links a:hover {
      color: #F59E0B;
    }

    .footer-links .sep {
      color: #E5E7EB;
    }

    .footer-copy {
      font-size: 0.7rem;
      color: #9CA3AF;
    }
  </style>

  <!-- Screen: Client Dashboard -->
  <div id="screen-client" class="dashboard-container hidden">
    <div class="app-header">
      <div style="font-weight: bold; font-size: 1.2rem;">Astro 5 Star</div>
      <div>
        <i class="fas fa-wallet"></i> ‚Çπ<span id="clientWallet">369</span>
        <i class="fas fa-sign-out-alt" style="margin-left: 10px; cursor: pointer;" onclick="clearSession()"></i>
      </div>
    </div>
    <div class="content-area">
      <!-- Section: Home -->
      <div id="section-home">


        <!-- Horoscope Section -->
        <div id="dailyHoroscopeSection" style="margin-bottom: 20px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="margin:0; font-size:1.1rem; color:#374151;">‡Æ§‡Æø‡Æ©‡Æö‡Æ∞‡Æø ‡Æ∞‡Ææ‡Æö‡Æø‡Æ™‡Æ≤‡Æ©‡Øç</h3>
            <span id="horoscopeDate"
              style="font-size:0.8rem; color:#6b7280; background:#f3f4f6; padding:2px 8px; border-radius:10px;">Today</span>
          </div>

          <div class="zodiac-scroller" id="zodiacScroller">
            <!-- Dynamic Zodiac Signs -->
          </div>

          <div class="horoscope-card" id="horoscopeDisplay">
            <div id="horoscopeLoading" style="text-align:center; padding:20px; color:#d97706;">
              <i class="fas fa-circle-notch fa-spin"></i> Loading...
            </div>
            <div id="horoscopeContent" class="hidden">
              <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <div id="activeSignIcon"
                  style="font-size:1.5rem; background:#fff7ed; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                  ‚ôà</div>
                <div style="font-weight:bold; font-size:1.1rem; color:#1f2937;" id="activeSignName">Aries</div>
              </div>
              <p id="horoscopeText" style="font-size:0.95rem; line-height:1.6; color:#4b5563; margin:0;">
                Select a sign to see your daily prediction.
              </p>
            </div>
          </div>
        </div>

        <div class="filter-tabs" id="topFilterTabs">
          <div class="tab" onclick="filterAstros('all')">All</div>
          <div class="tab" onclick="filterAstros('love')">Love</div>
          <div class="tab" onclick="filterAstros('career')">Career</div>
        </div>
        <div id="astroList">
          <!-- Dynamic Content -->
        </div>
      </div>

      <!-- Section: Dash -->
      <div id="section-dash" class="hidden">
        <div
          style="background:linear-gradient(135deg, #F59E0B 0%, #D97706 100%); padding:25px; border-radius:15px; color:white; margin-bottom:20px; text-align:center; box-shadow:0 10px 15px -3px rgba(245, 158, 11, 0.3);">
          <div style="opacity:0.9; font-size:0.9rem; margin-bottom:5px;">Available Wallet Balance</div>
          <div style="font-size:2.8rem; font-weight:bold; margin-bottom:15px;">‚Çπ<span id="dashWalletBalance">0</span>
          </div>
          <button
            style="background:white; color:#e07e0c; border:none; padding:10px 25px; border-radius:25px; font-weight:bold; font-size:1rem; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.1);"
            onclick="initiateRecharge()">
            <i class="fas fa-plus-circle"></i> Add Money
          </button>
        </div>

        <!-- Transaction History Section -->
        <div style="margin-bottom: 20px;">
          <div
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding: 0 5px;">
            <h3 style="margin:0; font-size:1.1rem; color:#1F2937;">Recent Transactions</h3>
            <button onclick="fetchTransactionHistory()"
              style="background:none; border:none; color:#F59E0B; font-weight:600; cursor:pointer;">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
          <div id="transactionList" style="display:flex; flex-direction:column; gap:10px;">
            <!-- Transactions will result here -->
            <div style="text-align:center; padding:20px; color:#6B7280; font-size:0.9rem;">Loading...</div>
          </div>
        </div>


      </div>
    </div>
  </div>

  <!-- Screen: Universal Chart Modal (For Dashboard) -->
  <div id="universalChartModal" class="modal-overlay hidden"
    style="align-items: center; justify-content: center; z-index: 10000;">
    <!-- Chart Form for Dashboard -->
    <div id="dashboardChartPanel"
      style="background:#F3F4F6; width:100%; height:90vh; border-top-left-radius:25px; border-top-right-radius:25px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 -5px 20px rgba(0,0,0,0.2); animation:slideUp 0.3s ease-out; max-width:500px;">
      <div
        style="padding:20px; background:white; font-weight:700; font-size:1.2rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e5e5e5; color:#1F2937;">
        <span>üîÆ Birth Chart </span>
        <button onclick="document.getElementById('universalChartModal').classList.add('hidden')"
          style="background:none; border:none; font-size:1.4rem; color:#6B7280; cursor:pointer;"><i
            class="fas fa-times"></i></button>
      </div>
      <div style="flex:1; overflow-y:auto; padding:20px;">
        <div
          style="background:white; border-radius:16px; padding:20px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom:20px;">
          <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div style="flex:1;">
              <label style="display:block; font-size:0.85rem; color:#4B5563; margin-bottom:6px; font-weight:500;">Date
                of Birth</label>
              <input type="date" id="dashboardChartDate" class="app-input"
                style="width:100%; padding:12px; border:1px solid #D1D5DB; border-radius:10px; font-size:1rem; color:#111827; background:#F9FAFB;">
            </div>
            <div style="flex:1;">
              <label style="display:block; font-size:0.85rem; color:#4B5563; margin-bottom:6px; font-weight:500;">Time
                of Birth</label>
              <input type="time" id="dashboardChartTime" class="app-input"
                style="width:100%; padding:12px; border:1px solid #D1D5DB; border-radius:10px; font-size:1rem; color:#111827; background:#F9FAFB;">
            </div>
          </div>
          <div style="display:flex; gap:15px; margin-bottom:15px;">
            <div style="flex:1;">
              <label
                style="display:block; font-size:0.85rem; color:#4B5563; margin-bottom:6px; font-weight:500;">Latitude</label>
              <input type="text" id="dashboardChartLat" class="app-input" placeholder="e.g., 13.0827"
                style="width:100%; padding:12px; border:1px solid #D1D5DB; border-radius:10px; font-size:1rem; color:#111827; background:#F9FAFB;">
            </div>
            <div style="flex:1;">
              <label
                style="display:block; font-size:0.85rem; color:#4B5563; margin-bottom:6px; font-weight:500;">Longitude</label>
              <input type="text" id="dashboardChartLon" class="app-input" placeholder="e.g., 80.2707"
                style="width:100%; padding:12px; border:1px solid #D1D5DB; border-radius:10px; font-size:1rem; color:#111827; background:#F9FAFB;">
            </div>
          </div>
          <div style="display:flex; gap:15px;">
            <div style="flex:1;">
              <label
                style="display:block; font-size:0.85rem; color:#4B5563; margin-bottom:6px; font-weight:500;">Timezone
                (IST = 5.5)</label>
              <input type="number" id="dashboardChartTz" class="app-input" value="5.5" step="0.5"
                style="width:100%; padding:12px; border:1px solid #D1D5DB; border-radius:10px; font-size:1rem; color:#111827; background:#F9FAFB;">
            </div>
          </div>
        </div>
        <button class="cosmic-btn" onclick="fetchDashboardChart()"
          style="font-size:1.1rem; padding:15px; border-radius:12px; box-shadow:0 10px 15px -3px rgba(4,120,87,0.2); width:100%; border:none; background:linear-gradient(to right, #059669, #047857); color:white; cursor:pointer; font-weight:600;">
          <i class="fas fa-calculator"></i> Get Birth Chart
        </button>
      </div>
    </div>
  </div>
  </div>

  <!-- Mobile Footer -->
  <div class="doc-bottom-nav">
    <div class="nav-item active" id="nav-home" onclick="navSwitch('home')">
      <i class="fas fa-home"></i><span>Home</span>
    </div>
    <div class="nav-item" id="nav-dash" onclick="navSwitch('dash')">
      <i class="fas fa-th-large"></i><span>Dash</span>
    </div>
    <div class="nav-item" id="nav-call" onclick="navSwitch('call')">
      <i class="fas fa-phone-alt"></i><span>Call</span>
    </div>
    <div class="nav-item" id="nav-chat" onclick="navSwitch('chat')">
      <i class="fas fa-comment-dots"></i><span>Chat</span>
    </div>
    <div class="nav-item" id="nav-profile" onclick="navSwitch('profile')">
      <i class="fas fa-user-circle"></i><span>Profile</span>
    </div>
  </div>
  </div>

  <style>
    .doc-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      z-index: 1000;
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
      padding-bottom: max(10px, env(safe-area-inset-bottom));
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #999;
      font-size: 0.75rem;
      cursor: pointer;
      flex: 1;
    }

    .nav-item.active {
      color: #d97706;
      font-weight: bold;
    }

    .nav-item i {
      font-size: 1.2rem;
      margin-bottom: 4px;
    }
  </style>

  <!-- Screen: Astrologer Dashboard -->
  <div id="screen-astro" class="dashboard-container hidden">
    <div class="app-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <img src="" id="astroAvatar" style="width: 35px; height: 35px; border-radius: 50%;">
        <div>
          <div style="font-weight: bold;" id="astroName">Astrologer</div>
          <div style="font-size: 0.7rem; color: #666;">ID: <span id="astroId">...</span></div>
        </div>
      </div>
      <div>
        <i class="fas fa-bell"></i>
        <i class="fas fa-sign-out-alt" style="margin-left: 10px; cursor: pointer;" onclick="clearSession()"></i>
      </div>
    </div>

    <div class="content-area">
      <!-- Toggles -->
      <div class="toggle-row">
        <div class="toggle-item">
          <span>Chat </span>
          <div class="toggle-switch" id="toggleChat"></div>
        </div>
        <div class="toggle-item">
          <span>Call </span>
          <div class="toggle-switch" id="toggleCall"></div>
        </div>
        <div class="toggle-item">
          <span>Video Call </span>
          <div class="toggle-switch" id="toggleVideo"></div>
        </div>
      </div>

      <div class="emergency-banner">
        <div style="font-weight: bold; margin-bottom: 5px;">Online for Emergency!</div>
        <div style="font-size: 0.8rem; opacity: 0.9;">Boost your earnings with emergency sessions.</div>
      </div>

      <!-- Astro Earnings Card -->
      <div class="progress-card"
        style="margin-bottom: 0px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border: none;">
        <div>
          <div style="font-weight: bold; font-size: 1.1rem;">Total Earnings</div>

          <div id="astroEarningsContainer" style="display:none; font-size: 1.8rem; font-weight: bold; margin-top: 5px;">
            ‚Çπ<span id="astroLifetimeDisplay">0.00</span>
          </div>

          <button id="btnShowEarnings" onclick="toggleEarnings()"
            style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 6px 15px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; margin-top: 5px; transition: all 0.2s;">
            <i class="fas fa-eye"></i> View Earnings
          </button>
          <!-- Removed Wallet Balance secondary line -->
          <div style="font-size: 0.75rem; opacity: 0.8; margin-top:2px;">Min. ‚Çπ500 to Withdraw</div>
        </div>
        <div>
          <button id="btnAstroWithdraw" onclick="astroRequestWithdrawal()"
            style="background: white; color: #059669; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 0.8rem; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            Withdraw
          </button>
        </div>
      </div>
      <div id="astroPendingWithdrawals" style="margin: 10px 15px; font-size: 0.8rem; color: #666; display: none;">
        <!-- Pending status here -->
      </div>

      <div class="progress-card">
        <div>
          <div style="font-weight: bold; font-size: 1.1rem;">Today's Progress</div>
          <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">0 hours left to complete target</div>
        </div>
        <div
          style="width: 60px; height: 60px; border-radius: 50%; border: 4px solid #eee; display: flex; align-items: center; justify-content: center;">
          0m
        </div>
      </div>

      <div class="grid-menu">
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-phone"></i></div> Call
        </div>
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-comment"></i></div> Chat
        </div>
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-rupee-sign"></i></div> Earnings
        </div>
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-star"></i></div> Reviews
        </div>
        <div class="grid-item" onclick="showHistory()" style="cursor: pointer;">
          <div class="grid-icon"><i class="fas fa-clock"></i></div> History
        </div>
        <div class="grid-item" onclick="showProfile()" style="cursor: pointer;">
          <div class="grid-icon"><i class="fas fa-user"></i></div> Profile
        </div>
        <!-- <div class="grid-item" onclick="showChartHelper()" style="cursor: pointer;">
          <div class="grid-icon"><i class="fas fa-chart-pie"></i></div> Birth Chart
        </div> -->
      </div>
    </div>
  </div>

  <!-- Screen: Client Birth Chart Form Modal -->
  <div id="screen-client-birth-chart" class="modal-overlay hidden" style="align-items: center; z-index: 99999;">
    <div class="chart-modal-content" style="height: auto; max-height: 90vh; max-width: 500px;">
      <div class="chart-header">
        <span>üìä Send Your Birth Details</span>
        <button onclick="document.getElementById('screen-client-birth-chart').classList.add('hidden')"
          class="close-btn"><i class="fas fa-times"></i></button>
      </div>

      <div class="chart-body" style="padding: 20px;">
        <div class="input-card" style="padding: 15px;">
          <!-- Name & Phone -->
          <div class="input-row">
            <div style="flex:1">
              <label>Name</label>
              <input type="text" id="clientChartName" class="app-input" placeholder="Your Name">
            </div>
          </div>
          <div class="input-row" style="margin-top:10px;">
            <div style="flex:1">
              <label>Phone Number</label>
              <input type="tel" id="clientChartPhone" class="app-input" placeholder="+91 99XXXXXX90" readonly
                style="background:#f0f0f0;">
            </div>
          </div>

          <!-- Gender -->
          <div style="margin-top:15px; display:flex; gap:20px; align-items:center;">
            <label style="margin:0; font-weight:500;">Gender:</label>
            <label><input type="radio" name="clientGender" value="Male" checked> Male</label>
            <label><input type="radio" name="clientGender" value="Female"> Female</label>
          </div>

          <!-- DOB & Time -->
          <div class="input-row" style="margin-top:10px;">
            <div style="flex:1">
              <label>Date of Birth</label>
              <input type="date" id="clientChartDate" class="app-input">
            </div>
            <div style="flex:1">
              <label>Time of Birth</label>
              <input type="time" id="clientChartTime" class="app-input">
            </div>
          </div>
          <div style="margin-top:5px;">
            <label><input type="checkbox" id="clientNoTime"> Don't know time</label>
          </div>

          <!-- City -->
          <div class="input-row" style="margin-top:15px; position:relative;">
            <div style="flex:1">
              <label>Place of Birth</label>
              <div style="position:relative;">
                <input type="text" id="clientCitySearch" class="app-input" placeholder="Enter City" autocomplete="off"
                  oninput="handleCityInput(this.value)">
                <div id="clientCityResults"
                  style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; z-index:9999; max-height:200px; overflow-y:auto; border-radius:6px; box-shadow:0 4px 15px rgba(0,0,0,0.2); margin-top:5px;">
                </div>
              </div>
            </div>
          </div>
          <!-- Hidden Lat/Lon/Tz for Logic -->
          <input type="hidden" id="clientChartLat">
          <input type="hidden" id="clientChartLon">
          <input type="hidden" id="clientChartTz" value="5.5">

          <!-- Extra Fields -->
          <div class="input-row" style="margin-top:10px;">
            <div style="flex:1">
              <label>Marital Status (Optional)</label>
              <select id="clientMarital" class="app-input">
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Divorced">Divorced</option>
                <option value="Widowed">Widowed</option>
              </select>
            </div>
            <div style="flex:1">
              <label>Occupation (Optional)</label>
              <input type="text" id="clientOccupation" class="app-input" placeholder="e.g. Engineer">
            </div>
          </div>

          <!-- Topic -->
          <div class="input-row" style="margin-top:10px;">
            <div style="flex:1">
              <label>Topic of Concern</label>
              <select id="clientTopic" class="app-input">
                <option value="Career">Career / Job</option>
                <option value="Marriage">Marriage / Relationship</option>
                <option value="Health">Health</option>
                <option value="Education">Education</option>
                <option value="Finance">Finance / Wealth</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <!-- Partner Details Toggle -->
          <div style="margin-top:15px; padding-top:10px; border-top:1px solid #eee;">
            <label><input type="checkbox" id="togglePartnerDetails"
                onchange="document.getElementById('partnerFields').style.display = this.checked ? 'block' : 'none'">
              Enter Partner's Details</label>
          </div>

          <div id="partnerFields"
            style="display:none; margin-top:10px; padding:10px; background:#f9f9f9; border-radius:8px;">
            <div class="input-row">
              <div style="flex:1">
                <label>Partner Name</label>
                <input type="text" id="partnerName" class="app-input">
              </div>
              <div style="flex:1">
                <label>Partner DOB</label>
                <input type="date" id="partnerDob" class="app-input">
              </div>
            </div>
            <div class="input-row" style="margin-top:10px;">
              <div style="flex:1">
                <label>Partner Time</label>
                <input type="time" id="partnerTob" class="app-input">
              </div>
              <div style="flex:1">
                <label>Partner Place</label>
                <input type="text" id="partnerPob" class="app-input">
              </div>
            </div>
          </div>

        </div>

        <button class="cosmic-btn" onclick="sendChatWithBirthChart()" style="margin-top:20px;">
          <i class="fas fa-comments"></i> Start Chat with Birth Details
        </button>
      </div>
    </div>
  </div>

  <!-- Screen: Recharge Wallet Modal -->
  <div id="screen-recharge" class="modal-overlay hidden"
    style="align-items: center; justify-content: center; z-index: 20000;">
    <div class="call-popup" style="width: 90%; max-width: 350px; text-align: left; position: relative; padding: 25px;">
      <button onclick="closeRechargeModal()" class="close-btn" style="position: absolute; right: 15px; top: 15px;"><i
          class="fas fa-times"></i></button>

      <div style="text-align: center; margin-bottom: 20px;">
        <div
          style="width: 50px; height: 50px; background: #ECFDF5; border-radius: 50%; color: #047857; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; font-size: 1.5rem;">
          <i class="fas fa-wallet"></i>
        </div>
        <h3 style="margin: 0; color: #1F2937; font-size: 1.2rem;">Add Money to Wallet</h3>
        <p style="font-size: 0.85rem; color: #6B7280; margin-top: 5px;">Secure payment for cosmic consultation</p>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="font-size: 0.85rem; font-weight: 600; color: #374151; display: block; margin-bottom: 8px;">Enter
          Amount</label>
        <div style="position: relative;">
          <span
            style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-weight: bold; color: #374151; font-size: 1.2rem;">‚Çπ</span>
          <input type="number" id="rechargeInput" class="app-input"
            style="padding-left: 35px; font-size: 1.3rem; font-weight: bold; color: #047857;" placeholder="100">
        </div>
      </div>

      <div style="display: flex; gap: 8px; margin-bottom: 25px; flex-wrap: wrap;">
        <button onclick="setRechargeAmount(100)" class="chip-btn">‚Çπ100</button>
        <button onclick="setRechargeAmount(200)" class="chip-btn">‚Çπ200</button>
        <button onclick="setRechargeAmount(500)" class="chip-btn">‚Çπ500</button>
        <button onclick="setRechargeAmount(1000)" class="chip-btn">‚Çπ1000</button>
      </div>

      <button class="cosmic-btn" onclick="submitRecharge()"
        style="width: 100%; border-radius: 12px; font-size: 1rem; padding: 14px;">
        Proceed to Pay <i class="fas fa-arrow-right" style="margin-left: 8px;"></i>
      </button>

      <div style="text-align: center; margin-top: 15px; font-size: 0.75rem; color: #9CA3AF;">
        <i class="fas fa-lock"></i> 100% Secure Payment via PhonePe/UPI
      </div>
    </div>
  </div>

  <!-- Screen: Chart Helper Modal -->
  <div id="screen-chart-helper" class="modal-overlay hidden" style="align-items: flex-end;">
    <div class="chart-modal-content">
      <div class="chart-header">
        <span>üîÆ Birth Chart</span>
        <button onclick="document.getElementById('screen-chart-helper').classList.add('hidden')" class="close-btn"><i
            class="fas fa-times"></i></button>
      </div>

      <div class="chart-body">
        <!-- Input Form -->
        <div id="chartInputSection">
          <div class="input-card">
            <div class="input-row">
              <div style="flex:1">
                <label>Date of Birth</label>
                <input type="date" id="chartDate" class="app-input">
              </div>
              <div style="flex:1">
                <label>Time of Birth</label>
                <input type="time" id="chartTime" class="app-input">
              </div>
            </div>
            <!-- City Search Row -->
            <div class="input-row" style="margin-top:15px; position:relative;">
              <div style="flex:1">
                <label>City / Place</label>
                <div style="display: flex; gap: 10px;">
                  <div style="flex:1; position:relative;">
                    <input type="text" id="citySearch" class="app-input" placeholder="Type City Name (e.g. Chennai)..."
                      autocomplete="off">
                    <div id="cityResults"
                      style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; z-index:9999; max-height:200px; overflow-y:auto; border-radius:6px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
                    </div>
                  </div>
                  <!-- Geo-Location Button -->
                  <button type="button" onclick="useCurrentLocation()" title="Use Current Location"
                    style="padding: 0 15px; background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; border-radius: 10px; cursor: pointer;">
                    <i class="fas fa-crosshairs"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Auto-Filled Coordinates -->
            <div class="input-row" style="margin-top:10px;">
              <div style="flex:1; display:flex; gap:10px;">
                <div style="flex:1">
                  <label style="font-size:0.75rem; color:#666;">Latitude</label>
                  <input type="text" id="chartLat" value="13.0827" class="app-input" readonly
                    style="background:#f9fafb; color:#555;">
                </div>
                <div style="flex:1">
                  <label style="font-size:0.75rem; color:#666;">Longitude</label>
                  <input type="text" id="chartLon" value="80.2707" class="app-input" readonly
                    style="background:#f9fafb; color:#555;">
                </div>
              </div>
            </div>

            <!-- Timezone Field -->
            <div class="input-row" style="margin-top:10px;">
              <div style="flex:1">
                <label style="font-size:0.75rem; color:#666;">Timezone (IST = 5.5)</label>
                <input type="number" id="chartTz" value="5.5" class="app-input" step="0.5" readonly
                  style="background:#f9fafb; color:#555;">
              </div>
            </div>
          </div>

          <button class="cosmic-btn generate-btn" onclick="fetchChart()">
            <i class="fas fa-calculator"></i> Get Horoscope
          </button>
        </div>

        <div id="chartLoading" style="display:none; text-align:center; padding:40px; color: var(--primary);">
          <div class="spinner-astro"></div>
          <div style="margin-top:15px; font-weight:500;">Analyzing Planets...</div>
        </div>

        <!-- Results Area -->
        <div id="chartResults" style="display: none; height:100%; display:flex; flex-direction:column;">

          <div class="chart-tabs">
            <button onclick="switchChartTab('rasi')" class="c-tab active" id="tab-rasi">Rasi Chart</button>
            <button onclick="switchChartTab('basic')" class="c-tab" id="tab-basic">Planets</button>
            <button onclick="switchChartTab('dasha')" class="c-tab" id="tab-dasha">Dasha</button>
            <button id="btnShareChart" onclick="shareChartInChat()" class="c-tab"
              style="color:#22C55E; display:none;"><i class="fas fa-share-alt"></i> Share</button>
            <button onclick="resetChart()" class="c-tab" style="color:red;"><i class="fas fa-redo"></i></button>
          </div>

          <!-- Content: Rasi Chart (Traditional Box) -->
          <div id="content-rasi" class="chart-tab-content" style="flex:1; overflow-y:auto; padding-bottom:20px;">
            <div class="rasi-container">
              <div class="south-indian-chart" id="southChart">
                <!-- 12 Boxes generated by JS -->
              </div>
              <div class="chart-center-label">Rasi Chart (D1)</div>
            </div>

            <!-- Panchangam Container -->
            <div class="panchangam-container"
              style="margin-top:20px; background:#fff; border:1px solid #eee; padding:10px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
              <div
                style="text-align:center; margin-bottom:10px; font-weight:bold; color:#d97706; text-transform:uppercase; letter-spacing:1px; font-size:0.9rem;">
                Panchangam</div>
              <div id="panchangamList"
                style="display:flex; flex-direction:column; gap:8px; font-size:0.9rem; color:#444;">
              </div>
            </div>

            <div class="navamsa-container" style="margin-top:20px;">
              <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">Navamsa (D9)</div>
              <div class="south-indian-chart" id="navamsaChart"></div>
            </div>
          </div>

          <!-- Content: Basic -->
          <div id="content-basic" class="chart-tab-content hidden" style="overflow-y:auto;">
            <div id="planetList" class="planet-grid"></div>
          </div>

          <!-- Content: Dasha -->
          <div id="content-dasha" class="chart-tab-content hidden" style="overflow-y:auto;">
            <div id="currentDashaInfo" class="dasha-card-highlight"></div>
            <div style="margin-top:15px; font-weight:bold; color:#444; padding-left:5px;">Vimshottari Sequence</div>
            <div id="dashaList" class="dasha-list"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Screen: Super Admin Dashboard -->
  <div id="screen-admin" class="dashboard-container hidden">
    <!-- Admin Edit User Modal -->
    <div id="adminEditModal" class="modal-overlay hidden"
      style="align-items: center; justify-content: center; z-index: 10001;">
      <div
        style="background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; position:relative;">
        <h3 style="margin-top:0; color:#1e3a8a;">Edit Profile</h3>
        <input type="hidden" id="adminEditUserId">

        <div style="margin-bottom:15px;">
          <label style="display:block; font-size:0.8rem; color:#666; margin-bottom:5px;">Display Name</label>
          <input type="text" id="adminEditName" class="app-input" placeholder="User Name">
        </div>

        <!-- Astrologer Specific Fields -->
        <div id="adminEditAstroFields"
          style="display:none; background:#ecfdf5; padding:10px; border-radius:8px; margin-bottom:15px;">
          <div style="font-size:0.8rem; color:#065f46; font-weight:bold; margin-bottom:10px;">Astrologer Settings</div>

          <div style="margin-bottom:10px;">
            <label style="display:block; font-size:0.8rem; color:#666; margin-bottom:5px;">Call Rate (‚Çπ/min)</label>
            <input type="number" id="adminEditPrice" class="app-input" placeholder="20">
          </div>

          <div style="margin-bottom:10px; display:flex; align-items:center; gap:10px;">
            <label style="font-size:0.9rem; color:#333;">Verified (Blue Tick)</label>
            <input type="checkbox" id="adminEditVerified" style="width:20px; height:20px;">
          </div>

          <div>
            <label style="display:block; font-size:0.8rem; color:#666; margin-bottom:5px;">Document Verification</label>
            <select id="adminEditDocStatus" class="app-input">
              <option value="none">Without Doc</option>
              <option value="processing">Processing</option>
              <option value="verified">Verified (Green Badge)</option>
            </select>
          </div>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button class="btn-admin" style="background:#e5e7eb; color:#333;"
            onclick="document.getElementById('adminEditModal').classList.add('hidden')">Cancel</button>
          <button class="btn-admin" style="background:#1e40af;" onclick="saveAdminEditUser()">Save Changes</button>
        </div>
      </div>
    </div>

    <div class="app-header"
      style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); color:white; box-shadow: 0 4px 12px rgba(30, 58, 138, 0.2);">
      <div style="font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-shield-alt"></i> Super Admin
      </div>
      <div style="display: flex; gap: 15px; align-items: center;">
        <i class="fas fa-bell" style="cursor: pointer; opacity: 0.8;"></i>
        <button onclick="clearSession()"
          style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
          <i class="fas fa-power-off"></i> Logout
        </button>
      </div>
    </div>
    <!-- Content Area (Scrollable) -->
    <div class="admin-content-area">

      <!-- Tab 1: Dashboard (Home) -->

      <div id="admin-sect-home" class="admin-tab-section active">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
          <h2 class="dashboard-title">
            <i class="fas fa-chart-line"></i> Dashboard Overview
          </h2>
          <div class="date-selector">
            <span class="date-text">Today</span>
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>

        <!-- Stats Cards Grid -->
        <div class="stats-grid">
          <!-- Total Revenue Card -->
          <div class="stat-card revenue-card">
            <div class="card-header">
              <div class="card-icon revenue-icon">
                <i class="fas fa-rupee-sign"></i>
              </div>
              <div class="trend-indicator positive">
                <i class="fas fa-arrow-up"></i>
                <span>12%</span>
              </div>
            </div>
            <div class="card-content">
              <div class="stat-label">Total Revenue</div>
              <div id="quickRev" class="stat-value">‚Çπ0</div>
              <div class="stat-subtext">
                <i class="fas fa-calendar-alt"></i>
                <span>This month</span>
              </div>
            </div>
            <div class="card-wave"></div>
          </div>

          <!-- Net Profit Card -->
          <div class="stat-card profit-card">
            <div class="card-header">
              <div class="card-icon profit-icon">
                <i class="fas fa-chart-line"></i>
              </div>
              <div class="trend-indicator positive">
                <i class="fas fa-arrow-up"></i>
                <span>8%</span>
              </div>
            </div>
            <div class="card-content">
              <div class="stat-label">Net Profit</div>
              <div id="quickProfit" class="stat-value">‚Çπ0</div>
              <div class="stat-subtext">
                <i class="fas fa-percentage"></i>
                <span>After expenses</span>
              </div>
            </div>
            <div class="card-wave"></div>
          </div>

          <!-- Astro Payout Card -->
          <div class="stat-card payout-card">
            <div class="card-header">
              <div class="card-icon payout-icon">
                <i class="fas fa-wallet"></i>
              </div>
              <div class="trend-indicator negative">
                <i class="fas fa-arrow-down"></i>
                <span>3%</span>
              </div>
            </div>
            <div class="card-content">
              <div class="stat-label">Astro Payout</div>
              <div id="quickPayout" class="stat-value">‚Çπ0</div>
              <div class="stat-subtext">
                <i class="fas fa-users"></i>
                <span>To astrologers</span>
              </div>
            </div>
            <div class="card-wave"></div>
          </div>

          <!-- Activity Card -->
          <div class="stat-card activity-card">
            <div class="card-header">
              <div class="card-icon activity-icon">
                <i class="fas fa-clock"></i>
              </div>
              <div class="trend-indicator positive">
                <i class="fas fa-arrow-up"></i>
                <span>15%</span>
              </div>
            </div>
            <div class="card-content">
              <div class="stat-label">Mins Billed</div>
              <div id="quickMins" class="stat-value">0</div>
              <div class="stat-subtext">
                <i class="fas fa-hourglass-half"></i>
                <span>Total minutes</span>
              </div>
            </div>
            <div class="card-wave"></div>
          </div>
        </div>

        <!-- Chart Section -->
        <div class="chart-container">
          <div class="chart-header">
            <h3>Revenue Overview</h3>
            <div class="chart-legend">
              <span class="legend-item">
                <span class="legend-dot revenue-dot"></span>
                Revenue
              </span>
              <span class="legend-item">
                <span class="legend-dot profit-dot"></span>
                Profit
              </span>
            </div>
          </div>
          <div class="chart-placeholder">
            <canvas id="revenueChart"></canvas>
            <div class="no-data">
              <i class="fas fa-chart-bar"></i>
              <p>Chart data will appear here</p>
            </div>
          </div>
        </div>
      </div>

      <style>
        /* Base Styles */
        .dashboard-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 24px;
          padding: 0;
          width: 100%;
        }

        .dashboard-title {
          margin: 0;
          color: #1F2937;
          font-size: 1.5rem;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 12px;
        }

        .dashboard-title i {
          color: #1e3a8a;
        }

        .date-selector {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 8px 16px;
          background: #fff;
          border: 1px solid #E5E7EB;
          border-radius: 20px;
          cursor: pointer;
          font-size: 0.9rem;
          color: #6B7280;
          transition: all 0.3s ease;
        }

        .date-selector:hover {
          border-color: #1e3a8a;
          color: #1e3a8a;
        }

        /* Stats Grid */
        .stats-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 20px;
          padding: 0;
          margin-bottom: 30px;
          width: 100%;
        }

        /* Stat Cards */
        .stat-card {
          background: #fff;
          border-radius: 20px;
          padding: 24px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          position: relative;
          overflow: hidden;
          transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .card-header {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: 20px;
        }

        .card-icon {
          width: 56px;
          height: 56px;
          border-radius: 16px;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5rem;
        }

        .revenue-icon {
          background: linear-gradient(135deg, #D1FAE5, #10B981);
          color: #047857;
        }

        .profit-icon {
          background: linear-gradient(135deg, #DBEAFE, #3B82F6);
          color: #1D4ED8;
        }

        .payout-icon {
          background: linear-gradient(135deg, #FEE2E2, #EF4444);
          color: #DC2626;
        }

        .activity-icon {
          background: linear-gradient(135deg, #F3F4F6, #6B7280);
          color: #4B5563;
        }

        .trend-indicator {
          display: flex;
          align-items: center;
          gap: 4px;
          padding: 4px 12px;
          border-radius: 12px;
          font-size: 0.85rem;
          font-weight: 600;
        }

        .trend-indicator.positive {
          background: #D1FAE5;
          color: #059669;
        }

        .trend-indicator.negative {
          background: #FEE2E2;
          color: #DC2626;
        }

        /* Card Content */
        .card-content {
          position: relative;
          z-index: 2;
        }

        .stat-label {
          font-size: 0.9rem;
          color: #6B7280;
          margin-bottom: 8px;
          font-weight: 500;
        }

        .stat-value {
          font-size: 2.2rem;
          font-weight: 700;
          color: #111827;
          margin-bottom: 12px;
          line-height: 1;
        }

        .stat-subtext {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.85rem;
          color: #9CA3AF;
        }

        .stat-subtext i {
          font-size: 0.8rem;
        }

        /* Card Wave Decoration */
        .card-wave {
          position: absolute;
          bottom: -10px;
          right: -10px;
          width: 120px;
          height: 120px;
          background: linear-gradient(135deg, transparent 30%, rgba(255, 255, 255, 0.1) 100%);
          border-radius: 50%;
          z-index: 1;
        }

        /* Chart Section */
        .chart-container {
          background: #fff;
          border-radius: 20px;
          padding: 24px;
          margin: 0;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
          width: 100%;
        }

        .chart-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        }

        .chart-header h3 {
          margin: 0;
          color: #1F2937;
          font-size: 1.2rem;
          font-weight: 600;
        }

        .chart-legend {
          display: flex;
          gap: 20px;
        }

        .legend-item {
          display: flex;
          align-items: center;
          gap: 8px;
          font-size: 0.9rem;
          color: #6B7280;
        }

        .legend-dot {
          width: 10px;
          height: 10px;
          border-radius: 50%;
        }

        .revenue-dot {
          background: linear-gradient(135deg, #10B981, #059669);
        }

        .profit-dot {
          background: linear-gradient(135deg, #3B82F6, #1D4ED8);
        }

        .chart-placeholder {
          height: 200px;
          background: #F9FAFB;
          border-radius: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          position: relative;
        }

        .no-data {
          text-align: center;
          color: #9CA3AF;
        }

        .no-data i {
          font-size: 3rem;
          margin-bottom: 16px;
          opacity: 0.3;
        }

        .no-data p {
          margin: 0;
          font-size: 1rem;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
          .dashboard-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
          }

          .date-selector {
            align-self: flex-start;
          }

          .stats-grid {
            grid-template-columns: 1fr;
            gap: 16px;
          }

          .stat-card {
            padding: 20px;
          }

          .stat-value {
            font-size: 1.8rem;
          }

          .card-icon {
            width: 48px;
            height: 48px;
            font-size: 1.2rem;
          }

          .chart-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 12px;
          }

          .chart-legend {
            width: 100%;
            justify-content: space-between;
          }
        }

        @media (max-width: 480px) {
          .dashboard-title {
            font-size: 1.3rem;
          }

          .stat-card {
            padding: 16px;
          }

          .stat-value {
            font-size: 1.6rem;
          }

          .chart-container {
            padding: 16px;
          }
        }

        /* Animation */
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }

          to {
            opacity: 1;
            transform: translateY(0);
          }
        }

        .stat-card {
          animation: fadeIn 0.5s ease-out;
        }

        .stat-card:nth-child(2) {
          animation-delay: 0.1s;
        }

        .stat-card:nth-child(3) {
          animation-delay: 0.2s;
        }

        .stat-card:nth-child(4) {
          animation-delay: 0.3s;
        }
      </style>

      <!-- Add Chart.js for future chart implementation -->
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <script>
        // Initialize placeholder chart
        document.addEventListener('DOMContentLoaded', function () {
          const ctx = document.getElementById('revenueChart')?.getContext('2d');
          if (ctx) {
            new Chart(ctx, {
              type: 'line',
              data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                  label: 'Revenue',
                  data: [],
                  borderColor: '#10B981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  borderWidth: 2,
                  tension: 0.4,
                  fill: true
                }, {
                  label: 'Profit',
                  data: [],
                  borderColor: '#3B82F6',
                  backgroundColor: 'rgba(59, 130, 246, 0.1)',
                  borderWidth: 2,
                  tension: 0.4,
                  fill: true
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    grid: {
                      color: 'rgba(0, 0, 0, 0.05)'
                    }
                  },
                  x: {
                    grid: {
                      display: false
                    }
                  }
                }
              }
            });
          }
        });
      </script>

      <!-- Tab 2: Earnings (Full Ledger) -->
      <div id="admin-sect-earnings" class="admin-tab-section">
        <h2
          style="margin:0 0 15px 0; color:#1F2937; font-size:1.3rem; font-weight:700; display:flex; align-items:center; gap:8px;">
          <i class="fas fa-chart-pie" style="color:#1e3a8a;"></i> Financial Ledger
        </h2>
        <div
          style="background:white; border-radius:16px; border:1px solid #e5e7eb; overflow:hidden; box-shadow:0 4px 12px rgba(0,0,0,0.08);">
          <div style="overflow-x:auto;">
            <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
              <thead
                style="background:linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-bottom:2px solid #d1d5db;">
                <tr>
                  <th style="padding:16px 15px; text-align:left; color:#374151; font-weight:700; font-size:0.85rem;">
                    Transaction Type</th>
                  <th style="padding:16px 15px; text-align:center; color:#374151; font-weight:700; font-size:0.85rem;">
                    Count
                  </th>
                  <th style="padding:16px 15px; text-align:right; color:#374151; font-weight:700; font-size:0.85rem;">
                    Revenue</th>
                </tr>
              </thead>
              <tbody id="fullLedgerBody">
                <!-- Populated via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Tab 3: Payouts (Send Money) -->
      <div id="admin-sect-payouts" class="admin-tab-section">
        <h2
          style="margin:0 0 15px 0; color:#1F2937; font-size:1.3rem; font-weight:700; display:flex; align-items:center; gap:8px;">
          <i class="fas fa-paper-plane" style="color:#1e3a8a;"></i> Astrologer Payouts
        </h2>

        <!-- Pending Withdrawals -->
        <div id="adminWithdrawalsSection" style="margin-bottom: 20px; display: none;">
          <div
            style="background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border:1px solid #fcd34d; border-radius:12px; padding:15px; margin-bottom:15px;">
            <div style="font-weight:700; color:#92400e; margin-bottom:10px; display:flex; align-items:center; gap:8px;">
              <i class="fas fa-exclamation-circle"></i> Pending Withdrawal Requests
            </div>
            <div id="adminWithdrawalsList" style="display:flex; flex-direction:column; gap:10px;"></div>
          </div>
        </div>

        <!-- List of Astrologers -->
        <div id="adminAstroList" style="display:flex; flex-direction:column; gap:12px;">
          <!-- Populated via JS -->
        </div>
      </div>

      <!-- Tab 4: Users (Customer List) -->
      <div id="admin-sect-users" class="admin-tab-section">
        <h2
          style="margin:0 0 15px 0; color:#1F2937; font-size:1.3rem; font-weight:700; display:flex; align-items:center; gap:8px;">
          <i class="fas fa-users" style="color:#1e3a8a;"></i> Customer List
        </h2>
        <div id="adminClientList" style="display:flex; flex-direction:column; gap:12px;">
          <!-- Populated via JS -->
        </div>
      </div>

      <!-- Admin Footer (Static) -->
      <div class="admin-footer">
        <div class="admin-footer-content">
          <div class="admin-footer-section">
            <div class="admin-footer-item">
              <i class="fas fa-chart-bar"></i>
              <span>Total Users: <strong id="footerTotalUsers">...</strong></span>
            </div>
            <div class="admin-footer-item">
              <i class="fas fa-wallet"></i>
              <span>Platform Revenue: <strong id="footerRevenue">‚Çπ0</strong></span>
            </div>
            <div class="admin-footer-item">
              <i class="fas fa-hourglass-half"></i>
              <span>Active Sessions: <strong id="footerSessions">0</strong></span>
            </div>
          </div>
          <div class="admin-footer-divider"></div>
          <div class="admin-footer-section">
            <div class="admin-footer-item">
              <i class="fas fa-server"></i>
              <span>System Status: <strong style="color: #86efac;">Operational</strong></span>
            </div>
            <div class="admin-footer-item">
              <i class="fas fa-clock"></i>
              <span id="footerTime">--:--</span>
            </div>
          </div>
          <div class="admin-footer-bottom">
            <div>AstroFiveStar Admin Panel v1.0</div>
            <div style="margin-top: 4px;">¬© 2025 All Rights Reserved</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Bottom Nav -->
    <div class="admin-nav">
      <div class="admin-nav-item active" id="anav-home" onclick="navAdmin('home')">
        <i class="fas fa-home"></i>
        <span>Dash</span>
      </div>
      <div class="admin-nav-item" id="anav-earnings" onclick="navAdmin('earnings')">
        <i class="fas fa-chart-pie"></i>
        <span>Earnings</span>
      </div>
      <div class="admin-nav-item" id="anav-payouts" onclick="navAdmin('payouts')">
        <i class="fas fa-user-astronaut"></i>
        <span>Astrologers</span>
      </div>
      <div class="admin-nav-item" id="anav-users" onclick="navAdmin('users')">
        <i class="fas fa-users"></i>
        <span>Users</span>
      </div>
    </div>
  </div>



  <!-- Screen: Admin Role Change Modal -->
  <div id="screen-admin-role-modal" class="modal-overlay hidden">
    <div class="call-popup" style="text-align: left;">
      <h3>Change User Role</h3>
      <p style="color:#666; font-size:0.9rem;">Select new role handler for this user.</p>

      <select id="adminRoleSelect" class="cosmic-input" style="color:black; background:white;">
        <option value="client">Client</option>
        <option value="astrologer">Astrologer</option>
        <option value="superadmin">Super Admin</option>
      </select>

      <div style="margin-top:20px; text-align:right;">
        <button onclick="document.getElementById('screen-admin-role-modal').classList.add('hidden')"
          style="padding:8px 15px; border:none; background:#eee; border-radius:5px; cursor:pointer;">Cancel</button>
        <button onclick="submitAdminRoleChange()"
          style="padding:8px 15px; border:none; background:#3b82f6; color:white; border-radius:5px; cursor:pointer; margin-left:10px;">Save
          Role</button>
      </div>
    </div>
  </div>

  <!-- Screen: Incoming Call Modal -->
  <div id="screen-incoming" class="modal-overlay hidden">
    <div class="call-popup">
      <img src="https://ui-avatars.com/api/?name=User&background=random" class="caller-avatar">
      <h3 style="margin: 0;">Incoming Call</h3>
      <p style="color: #666; margin-bottom: 20px;" id="callerName">Client Name</p>
      <div>
        <button class="btn-reject" id="btnReject">Reject</button>
        <button class="btn-accept" id="btnAccept">Accept</button>
      </div>
    </div>
  </div>

  <!-- Screen: History -->
  <div id="screen-history" class="modal-overlay hidden">
    <div
      style="background: white; width: 90%; max-width: 400px; height: 80%; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;">
      <div
        style="padding: 15px; background: var(--bg-body); font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
        <span>Chat History</span>
        <button onclick="document.getElementById('screen-history').classList.add('hidden')"
          style="background: none; border: none; font-size: 1.2rem;"><i class="fas fa-times"></i></button>
      </div>
      <div id="historyList" style="flex: 1; overflow-y: auto; padding: 15px;">
        <!-- History Items -->
      </div>
    </div>
  </div>

  <!-- Screen: Profile -->
  <div id="screen-profile" class="modal-overlay hidden">
    <div style="background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h3 style="margin:0;">Edit Profile</h3>
        <i class="fas fa-times" onclick="document.getElementById('screen-profile').classList.add('hidden')"
          style="cursor:pointer; font-size:1.2rem;"></i>
      </div>

      <div style="text-align:center; margin-bottom:20px;">
        <img id="editAvatar" src=""
          style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid #ddd; margin-bottom:10px;">
        <br>
        <input type="file" id="fileAvatar" style="display:none" onchange="uploadAvatar(this)">
        <button onclick="document.getElementById('fileAvatar').click()"
          style="padding:5px 10px; font-size:0.8rem; border-radius:5px; border:1px solid #ddd; background:white;">Change
          Photo</button>
      </div>

      <div id="clientProfileFields">
        <label style="display:block; margin-bottom:5px; font-size:0.9rem; color:#666;">Date of Birth</label>
        <input id="profileDob" type="date" class="cosmic-input"
          style="background:#f9f9f9; color:black; border:1px solid #ddd; width:100%;">

        <label style="display:block; margin-bottom:5px; margin-top:10px; font-size:0.9rem; color:#666;">Time of
          Birth</label>
        <input id="profileTime" type="time" class="cosmic-input"
          style="background:#f9f9f9; color:black; border:1px solid #ddd; width:100%;">

        <label style="display:block; margin-bottom:5px; margin-top:10px; font-size:0.9rem; color:#666;">Place of
          Birth</label>
        <input id="profileCity" type="text" class="cosmic-input" placeholder="City"
          style="background:#f9f9f9; color:black; border:1px solid #ddd; width:100%;">
      </div>

      <div id="astroProfileFields" style="display:none;">
        <label style="display:block; margin-bottom:5px; margin-top:15px; font-size:0.9rem; color:#666;">Call Price
          (‚Çπ/min)</label>
        <input id="editPrice" type="number" class="cosmic-input"
          style="background:#f9f9f9; color:black; border:1px solid #ddd;">

        <label style="display:block; margin-bottom:5px; margin-top:15px; font-size:0.9rem; color:#666;">Experience
          (Years)</label>
        <input id="editExp" type="number" class="cosmic-input"
          style="background:#f9f9f9; color:black; border:1px solid #ddd;">
      </div>

      <button class="cosmic-btn" onclick="saveProfile()" style="margin-top:20px;">Save Changes</button>

      <button onclick="clearSession()"
        style="width:100%; padding:15px; margin-top:15px; background:#fee2e2; color:#b91c1c; border:none; border-radius:12px; font-weight:bold; cursor:pointer;">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </div>

  <!-- Screen: Session -->
  <div id="screen-session" class="hidden">
    <div class="video-area">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
      <div id="sessionInfo" style="position: absolute; top: 20px; left: 20px; color: white;">
        <span id="recIndicator" style="background: red; padding: 2px 8px; border-radius: 4px;">REC</span> <span
          id="sessionTimer">00:00</span>
      </div>
      <div class="controls">
        <button class="circle-btn" style="background: #333;"><i class="fas fa-video"></i></button>
        <button class="circle-btn" style="background: #333;"><i class="fas fa-microphone"></i></button>
        <button class="circle-btn" style="background: #EF4444;" id="btnEnd"><i class="fas fa-phone-slash"></i></button>
      </div>
    </div>

    <!-- Two Column Layout Container -->
    <div style="display:flex; flex:1; gap:0; overflow:hidden;">
      <!-- Column 1: Chat Window (Left) -->
      <div
        style="flex:1; display:flex; flex-direction:column; background:white; border-right:1px solid #eee; min-width:0;">
        <div class="chat-overlay">
          <!-- Client Details Header (For Astrologer) -->
          <div id="clientDetailsHeader"
            style="display:none; padding:12px 15px; background:#f0fdf4; border-bottom:1px solid #d1fae5; font-size:0.9rem;">
            <div style="font-weight:600; color:#047857; margin-bottom:5px;">Client Details</div>
            <div id="clientDetailsContent" style="color:#555; font-size:0.85rem;">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <div id="messagesList">
            <!-- Client Request Details Watermark -->
            <div id="clientRequestDetails"
              style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); text-align:center; z-index:1; pointer-events:none;">
              <div
                style="font-size:3rem; color:rgba(200,200,200,0.3); font-weight:300; margin-bottom:20px; letter-spacing:2px;">
                üìã</div>
              <div style="color:rgba(150,150,150,0.4); font-size:1.1rem; font-weight:500; margin-bottom:10px;">
                Chat
                Request from Client</div>
              <div id="clientRequestContent"
                style="color:rgba(130,130,130,0.35); font-size:0.95rem; line-height:1.6; max-width:300px;">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>

            <!-- Inline Birth Chart Panel -->
            <div id="inlineChartPanel"
              style="display:none; background:white; border-radius:12px; padding:20px; margin:10px 0; box-shadow:0 2px 8px rgba(0,0,0,0.1); max-height:70vh; overflow-y:auto;">
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div style="font-weight:bold; font-size:1.1rem; color:#d97706;">üîÆ Birth Chart</div>
                <button onclick="closeInlineChart()"
                  style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#999;">‚úï</button>
              </div>

              <!-- Input Form -->
              <div id="chartInputSection">
                <div class="input-card">
                  <div class="input-row">
                    <div style="flex:1">
                      <label>Date of Birth</label>
                      <input type="date" id="chartDate" class="app-input">
                    </div>
                    <div style="flex:1">
                      <label>Time of Birth</label>
                      <input type="time" id="chartTime" class="app-input">
                    </div>
                  </div>
                  <!-- City Search Row -->
                  <div class="input-row" style="margin-top:15px; position:relative;">
                    <div style="flex:1">
                      <label>City / Place</label>
                      <div style="position:relative;">
                        <input type="text" id="citySearch" class="app-input" placeholder="Type City Name..."
                          autocomplete="off">
                        <div id="cityResults"
                          style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; z-index:9999; max-height:200px; overflow-y:auto; border-radius:6px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Coordinates -->
                  <div class="input-row" style="margin-top:10px;">
                    <div style="flex:1; display:flex; gap:10px;">
                      <div style="flex:1">
                        <label style="font-size:0.75rem; color:#666;">Latitude</label>
                        <input type="text" id="chartLat" value="13.0827" class="app-input" readonly
                          style="background:#f9fafb; color:#555;">
                      </div>
                      <div style="flex:1">
                        <label style="font-size:0.75rem; color:#666;">Longitude</label>
                        <input type="text" id="chartLon" value="80.2707" class="app-input" readonly
                          style="background:#f9fafb; color:#555;">
                      </div>
                    </div>
                  </div>

                  <!-- Timezone -->
                  <div class="input-row" style="margin-top:10px;">
                    <div style="flex:1">
                      <label style="font-size:0.75rem; color:#666;">Timezone (IST = 5.5)</label>
                      <input type="number" id="chartTz" value="5.5" class="app-input" step="0.5" readonly
                        style="background:#f9fafb; color:#555;">
                    </div>
                  </div>
                </div>

                <button class="cosmic-btn generate-btn" onclick="fetchChart()" style="margin-top:15px; width:100%;">
                  <i class="fas fa-calculator"></i> Get Horoscope
                </button>
              </div>

              <div id="chartLoading" style="display:none; text-align:center; padding:40px; color: var(--primary);">
                <div class="spinner-astro"></div>
                <div style="margin-top:15px; font-weight:500;">Analyzing Planets...</div>
              </div>

              <!-- Results Area -->
              <div id="chartResults" style="display: none; height:100%; display:flex; flex-direction:column;">
                <div class="chart-tabs">
                  <button onclick="switchChartTab('rasi')" class="c-tab active" id="tab-rasi">Rasi Chart</button>
                  <button onclick="switchChartTab('basic')" class="c-tab" id="tab-basic">Planets</button>
                  <button onclick="switchChartTab('dasha')" class="c-tab" id="tab-dasha">Dasha</button>
                  <button onclick="resetChart()" class="c-tab" style="color:red;"><i class="fas fa-redo"></i></button>
                </div>

                <!-- Content: Rasi Chart -->
                <div id="content-rasi" class="chart-tab-content" style="flex:1; overflow-y:auto; padding-bottom:20px;">
                  <div class="rasi-container">
                    <div class="south-indian-chart" id="southChart"></div>
                    <div class="chart-center-label">Rasi Chart (D1)</div>
                  </div>
                  <div class="panchangam-container"
                    style="margin-top:20px; background:#fff; border:1px solid #eee; padding:10px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div
                      style="text-align:center; margin-bottom:10px; font-weight:bold; color:#d97706; text-transform:uppercase; letter-spacing:1px; font-size:0.9rem;">
                      Panchangam</div>
                    <div id="panchangamList"
                      style="display:flex; flex-direction:column; gap:8px; font-size:0.9rem; color:#444;"></div>
                  </div>
                  <div class="navamsa-container" style="margin-top:20px;">
                    <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">Navamsa (D9)
                    </div>
                    <div class="south-indian-chart" id="navamsaChart"></div>
                  </div>
                </div>

                <!-- Content: Planets -->
                <div id="content-basic" class="chart-tab-content hidden" style="flex:1; overflow-y:auto;">
                  <div id="planetsList"></div>
                </div>

                <!-- Content: Dasha -->
                <div id="content-dasha" class="chart-tab-content hidden" style="flex:1; overflow-y:auto;">
                  ```
                </div>
              </div>
            </div>
          </div>
          <div id="screen-porutham" class="modal-overlay hidden" style="align-items: center;">
            <div class="chart-modal-content" style="max-width: 800px; height: 90vh;">
              <div
                style="padding:20px; background:white; font-weight:700; font-size:1.2rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e5e5e5; color:#1F2937;">
                <span>üíû Horoscope Matching (Porutham)</span>
                <button onclick="document.getElementById('screen-porutham').classList.add('hidden')"
                  style="background:none; border:none; font-size:1.4rem; color:#6B7280; cursor:pointer;"><i
                    class="fas fa-times"></i></button>
              </div>

              <div class="chart-body">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <!-- Boy Details -->
                  <div class="input-card">
                    <div style="font-weight:bold; color:#3b82f6; margin-bottom:15px; font-size:1.1rem;">ü§µ Boy's
                      Details
                    </div>

                    <label style="display:block; margin-bottom:5px; font-size:0.9rem; color:#666;">Date of
                      Birth</label>
                    <input type="date" id="boyDate" class="cosmic-input"
                      style="background:#f9f9f9; color:black; border:1px solid #ddd;">

                    <label style="display:block; margin-bottom:5px; margin-top:10px; font-size:0.9rem; color:#666;">Time
                      of Birth</label>
                    <input type="time" id="boyTime" class="cosmic-input"
                      style="background:#f9f9f9; color:black; border:1px solid #ddd;">

                    <label
                      style="display:block; margin-bottom:5px; margin-top:10px; font-size:0.9rem; color:#666;">City</label>
                    <div style="position:relative;">
                      <input type="text" id="boyCity" class="cosmic-input" placeholder="Search City..."
                        oninput="handleMatchCitySearch(this, 'boy')"
                        style="background:#f9f9f9; color:black; border:1px solid #ddd;">
                      <div id="boyCityResults" class="city-results-dropdown" style="display:none;"></div>
                      <input type="hidden" id="boyLat">
                      <input type="hidden" id="boyLon">
                    </div>
                  </div>

                  <!-- Girl Details -->
                  <div class="input-card">
                    <div style="font-weight:bold; color:#ec4899; margin-bottom:15px; font-size:1.1rem;">üë∞ Girl's
                      Details</div>

                    <label style="display:block; margin-bottom:5px; font-size:0.9rem; color:#666;">Date of
                      Birth</label>
                    <input type="date" id="girlDate" class="cosmic-input"
                      style="background:#f9f9f9; color:black; border:1px solid #ddd;">

                    <label style="display:block; margin-bottom:5px; margin-top:10px; font-size:0.9rem; color:#666;">Time
                      of Birth</label>
                    <input type="time" id="girlTime" class="cosmic-input"
                      style="background:#f9f9f9; color:black; border:1px solid #ddd;">

                    <label
                      style="display:block; margin-bottom:5px; margin-top:10px; font-size:0.9rem; color:#666;">City</label>
                    <div style="position:relative;">
                      <input type="text" id="girlCity" class="cosmic-input" placeholder="Search City..."
                        oninput="handleMatchCitySearch(this, 'girl')"
                        style="background:#f9f9f9; color:black; border:1px solid #ddd;">
                      <div id="girlCityResults" class="city-results-dropdown" style="display:none;"></div>
                      <input type="hidden" id="girlLat">
                      <input type="hidden" id="girlLon">
                    </div>
                  </div>
                </div>

                <div style="margin-top:20px;">
                  <button onclick="calculatePorutham()" class="cosmic-btn"
                    style="width:100%; padding:15px; font-size:1.1rem;">
                    <i class="fas fa-heart"></i> Calculate Compatibility
                  </button>
                </div>

                <div id="poruthamLoading" style="display:none; text-align:center; padding:40px; color: var(--primary);">
                  <div class="spinner-astro"></div>
                  <div style="margin-top:15px; font-weight:500;">Calculating Porutham...</div>
                </div>

                <!-- Results -->
                <div id="poruthamResults" style="display:none; margin-top:30px;">
                  <!-- Populated by JS -->
                </div>

              </div>
            </div>
          </div>

          <style>
            .chat-input {
              padding: 10px;
              border-top: 1px solid #eee;
              display: flex;
              gap: 10px;
              align-items: center;
              position: sticky;
              bottom: 0;
              background: white;
              z-index: 20;
            }

            .msg-input-reduced {
              flex: 0 0 60%;
            }

            #inlineChartPanel {
              margin-bottom: 80px;
              /* space for chat input */
              position: relative;
              z-index: 10;
              max-height: calc(70vh - 80px);
              overflow-y: auto;
            }
          </style>
          <div id="typingIndicator"
            style="display:none; padding: 5px 15px; font-size: 0.8rem; color: #888; font-style: italic; background: #fff; position: sticky; bottom: 60px; z-index: 15;">
            Typing...
          </div>
          <div class="chat-input">

            <button id="btnChatChart" onclick="showChartHelperWithData()"
              style="display:none; padding:8px 12px; height:40px; border-radius:20px; background:#fff; border:1px solid #ddd; color:#d97706; font-weight:600; white-space:nowrap; box-shadow:0 1px 2px rgba(0,0,0,0.05); cursor:pointer; transition:0.2s;">
              <i class="fas fa-chart-pie"></i> ‡Æú‡Ææ‡Æ§‡Æï‡ÆÆ‡Øç
            </button>
            <button id="btnEditInfo" onclick="openEditIntakeForm()"
              style="display:none; margin-right:5px; padding:0 10px; height:40px; border-radius:20px; background:#f3f4f6; border:none; color:#555; font-size:0.8rem; cursor:pointer;">
              <i class="fas fa-edit"></i> Edit Info
            </button>
            <input id="msgInput" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:20px;"
              placeholder="Type Message...">
            <button id="btnSend"
              style="width:40px; height:40px; border-radius:50%; background:#FFD700; border:none; cursor:pointer;"><i
                class="fas fa-paper-plane"></i></button>
          </div>
        </div>
      </div>

      <!-- Column 2: Birth Chart Details (Right) - Responsive -->
      <div id="birthChartColumn">

        <div
          style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:bold; font-size:1rem; color:#d97706;">üîÆ Birth Chart</div>
          <button onclick="closeBirthChartColumn()"
            style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:#999;">‚úï</button>
        </div>
        <div style="padding:15px; border-bottom:1px solid #eee;">
          <button onclick="fetchChart()" class="cosmic-btn" style="width:100%; padding:10px; font-size:0.9rem;">
            <i class="fas fa-calculator"></i> Get Birth Chart
          </button>

          <button onclick="porutham()" class="cosmic-btn" style="width:100%; padding:10px; font-size:0.9rem;">
            <i class="fas fa-calculator"></i> ‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ§‡Øç‡Æ§‡ÆÆ‡Øç
          </button>

        </div>
        <div id="birthChartContent" style="flex:1; overflow-y:auto; padding:15px;">
          <!-- Birth chart content will be displayed here -->
        </div>

      </div>


    </div>
  </div>
  </div>

  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
  <script>
    // State
    const state = { me: null, socket: null, session: null, peer: null, localStream: null };

    // Persistent Session Helper
    const SESSION_KEY = 'astro_session';
    const TWO_MONTHS = 60 * 24 * 60 * 60 * 1000;

    function saveSession(user) {
      const session = { ...user, expiresAt: Date.now() + TWO_MONTHS };
      localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    }

    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
      window.location.reload();
    }

    // Initialize Socket
    const socket = io();
    state.socket = socket;

    // DOM Elements
    const sLogin = document.getElementById('screen-login');
    const sClient = document.getElementById('screen-client');
    const sAstro = document.getElementById('screen-astro');
    const sAdmin = document.getElementById('screen-admin');
    const sInc = document.getElementById('screen-incoming');
    const sSes = document.getElementById('screen-session');

    // Check for existing session
    // Check for existing session
    function checkSession() {
      try {
        const saved = localStorage.getItem(SESSION_KEY);
        if (!saved) {
          loadGuestMode();
          return;
        }

        const session = JSON.parse(saved);
        if (Date.now() > session.expiresAt) {
          localStorage.removeItem(SESSION_KEY);
          loadGuestMode();
          return;
        }

        // Auto Login
        console.log('Restoring session for:', session.name);
        state.me = session;
        socket.emit('register', { name: session.name, phone: session.phone, userId: session.userId }, (ack) => {
          if (ack.ok) {
            // Merge fresh data from server (wallet, earnings, etc.)
            state.me = { ...session, ...ack };
            saveSession(state.me); // Update localStorage with fresh data

            sLogin.classList.add('hidden');
            if (state.me.role === 'astrologer') loadAstroDash(state.me);
            else if (state.me.role === 'superadmin') loadAdminDash(state.me);
            else {
              if (session.intakeDetails) state.me.intakeDetails = session.intakeDetails;
              loadClientDash(state.me);
            }
          } else {
            // If register fails (e.g. user deleted), clear session
            clearSession();
          }
        });

      } catch (e) { console.error('Session Error', e); }
    }

    function loadGuestMode() {
      console.log('Loading Guest Mode');
      const guestUser = { name: 'Guest', userId: 'guest', role: 'guest', walletBalance: 0 };
      state.me = guestUser;
      sLogin.classList.add('hidden');
      loadClientDash(guestUser);
    }

    function showLogin() {
      sLogin.classList.remove('hidden');
      // Add a close button to login screen if not present, to return to guest mode?
      // For now, standard behavior is fine. User asked to "ask login".
    }

    function hideAllScreens() {
      if (document.getElementById('screen-login')) document.getElementById('screen-login').classList.add('hidden');
      if (document.getElementById('screen-client')) document.getElementById('screen-client').classList.add('hidden');
      if (document.getElementById('screen-astro')) document.getElementById('screen-astro').classList.add('hidden');
      if (document.getElementById('screen-admin')) document.getElementById('screen-admin').classList.add('hidden');
      // Hide Profile modal if open
      if (document.getElementById('screen-profile')) document.getElementById('screen-profile').classList.add('hidden');
    }

    function checkGuestAction(actionType, ...args) {
      if (state.me && state.me.role === 'guest') {
        showLogin();
        return;
      }
      // Execute the actual action
      if (typeof actionType === 'function') {
        actionType(...args);
      } else if (actionType === 'chat') {
        showChatWithBirthChart(...args); // args[0] is astroId
      } else if (actionType === 'call') {
        requestSession(args[0], 'audio');
      } else if (actionType === 'video') {
        requestSession(args[0], 'video');
      }
    }

    // Login Handlers
    document.getElementById('btnSendOtp').onclick = async () => {
      const phone = document.getElementById('inputPhone').value;
      if (!phone) { alert('Enter Phone'); return; }

      const btn = document.getElementById('btnSendOtp');
      const original = btn.textContent;
      btn.textContent = 'Sending...';
      btn.disabled = true;

      try {
        const res = await fetch('/api/send-otp', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        }).then(r => r.json());

        if (res.ok) {
          document.getElementById('step-phone').classList.add('hidden');
          document.getElementById('step-otp').classList.remove('hidden');
        } else {
          alert(res.error || 'Failed');
        }
      } catch (e) { alert('Network Error'); }

      btn.textContent = original;
      btn.disabled = false;
    };

    document.getElementById('btnVerifyOtp').onclick = async () => {
      const phone = document.getElementById('inputPhone').value;
      const otp = document.getElementById('inputOtp').value;
      const res = await fetch('/api/verify-otp', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, otp })
      }).then(r => r.json());

      if (res.ok) {
        state.me = res;
        saveSession(res);

        socket.emit('register', { name: res.name, phone: phone }, (ack) => {
          sLogin.classList.add('hidden');
          if (res.role === 'astrologer') {
            loadAstroDash(res);
          } else if (res.role === 'superadmin') {
            loadAdminDash(res);
          } else {
            // Restore intake details if sent from server
            if (res.intakeDetails) state.me.intakeDetails = res.intakeDetails;
            loadClientDash(res);
          }
        });
      } else {
        alert('Invalid Login');
      }
    };

    // Client Dashboard Logic
    state.astroList = [];

    function loadClientDash(user) {
      hideAllScreens();
      sClient.classList.remove('hidden');

      if (user.role === 'guest') {
        const walletEl = document.getElementById('clientWallet');
        // Replace wallet icon/text with Login Button
        if (walletEl) {
          walletEl.parentElement.innerHTML = '<button onclick="showLogin()" style="background:#F59E0B; color:white; border:none; padding:5px 15px; border-radius:20px; cursor:pointer; font-weight:bold; font-size:0.9rem;">Login</button>';
        }
        if (document.getElementById('dashWalletBalance')) {
          document.getElementById('dashWalletBalance').innerText = '0';
        }
      } else {
        // Normal User
        const walletHtml = '<i class="fas fa-wallet"></i> ‚Çπ<span id="clientWallet">' + (user.walletBalance || 0) + '</span><i class="fas fa-sign-out-alt" style="margin-left: 10px; cursor: pointer;" onclick="clearSession()"></i>';
        const headerRight = document.querySelector('.app-header > div:last-child');
        if (headerRight) headerRight.innerHTML = walletHtml;

        if (document.getElementById('dashWalletBalance')) {
          document.getElementById('dashWalletBalance').innerText = user.walletBalance || 0;
        }

        // Fetch Payment History
        if (window.fetchTransactionHistory) window.fetchTransactionHistory();
      }

      // SHOW GLOBAL FOOTER (Client Nav)
      const globalFooter = document.querySelector('.doc-bottom-nav');
      if (globalFooter) globalFooter.style.display = 'flex';

      const anav = document.querySelector('.admin-nav');
      if (anav) anav.style.display = 'none';
      const afoot = document.querySelector('.admin-footer');
      if (afoot) afoot.classList.remove('show');

      // Home Header
      if (document.getElementById('homeUserName')) {
        document.getElementById('homeUserName').innerText = user.role === 'guest' ? 'Guest' : user.name.split(' ')[0];
        updateHomeTime();
        setInterval(updateHomeTime, 60000);
      }

      // Initial State
      navSwitch('home');
      fetchAstrologers();

      socket.on('astrologer-update', (list) => {
        state.astroList = list;
        const active = document.querySelector('.nav-item.active');
        if (active) {
          if (active.id === 'nav-call') navSwitch('call');
          else if (active.id === 'nav-chat') navSwitch('chat');
          else if (active.id === 'nav-home') navSwitch('home');
        } else {
          renderAstroList(list);
        }
      });

      socket.on('wallet-update', (data) => {
        const bal = Number(data.balance).toFixed(2);
        document.getElementById('clientWallet').innerText = bal;
        if (document.getElementById('dashWalletBalance')) {
          document.getElementById('dashWalletBalance').innerText = bal;
        }
        state.me.walletBalance = data.balance;
        saveSession(state.me);

        // Refresh History
        if (window.fetchTransactionHistory) window.fetchTransactionHistory();

        // Low Balance Warning (e.g., < ‚Çπ50)
        // Check if we are in a session? Maybe not needed, just warn.
        if (data.balance < 50) {
          // Optional: Check if we haven't shown it recently to avoid spam
          showLowBalanceAlert(data.balance);
        }
      });
    }

    function updateHomeTime() {
      const now = new Date();
      const timeEl = document.getElementById('homeTimeDisplay');
      const dateEl = document.getElementById('homeDateDisplay');
      if (timeEl) timeEl.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      if (dateEl) dateEl.innerText = now.toLocaleDateString([], { weekday: 'short', day: 'numeric', month: 'short' });
    }

    function navSwitch(tab) {
      if ((tab === 'chat' || tab === 'profile') && state.me && state.me.role === 'guest') {
        showLogin();
        return;
      }
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      const btn = document.getElementById('nav-' + tab);
      if (btn) btn.classList.add('active');

      const sectHome = document.getElementById('section-home');
      const sectDash = document.getElementById('section-dash');
      const horoSection = document.getElementById('dailyHoroscopeSection');

      if (horoSection) {
        // Only show Horoscope on Home tab
        horoSection.style.display = (tab === 'home') ? 'block' : 'none';
      }

      if (tab === 'home') {
        if (sectHome) sectHome.classList.remove('hidden');
        if (sectDash) sectDash.classList.add('hidden');
        if (document.getElementById('topFilterTabs')) document.getElementById('topFilterTabs').classList.remove('hidden');
        renderAstroList(state.astroList);
      }
      else if (tab === 'dash') {
        if (sectHome) sectHome.classList.add('hidden');
        if (sectDash) sectDash.classList.remove('hidden');
      }
      else if (tab === 'call') {
        if (sectHome) sectHome.classList.remove('hidden');
        if (sectDash) sectDash.classList.add('hidden');
        if (document.getElementById('topFilterTabs')) document.getElementById('topFilterTabs').classList.add('hidden');

        const online = state.astroList.filter(a => a.isAudioOnline);
        const offline = state.astroList.filter(a => !a.isAudioOnline);
        renderAstroList([...online, ...offline]);
      }
      else if (tab === 'chat') {
        if (sectHome) sectHome.classList.remove('hidden');
        if (sectDash) sectDash.classList.add('hidden');
        if (document.getElementById('topFilterTabs')) document.getElementById('topFilterTabs').classList.add('hidden');

        const online = state.astroList.filter(a => a.isChatOnline);
        const offline = state.astroList.filter(a => !a.isChatOnline);
        renderAstroList([...online, ...offline]);
      }
      else if (tab === 'profile') {
        // Reset active to Previous or keep Profile active?
        // User wants "Profile clik time update progile..." implying opening profile
        showProfile();
      }
    };

    window.filterAstros = function (type) {
      // Simple mock filter
      renderAstroList(state.astroList);
    };

    window.showProfile = function () {
      document.getElementById('screen-profile').classList.remove('hidden');

      const user = state.me;
      if (!user) return;

      const img = document.getElementById('editAvatar');
      if (img) img.src = user.image || `https://ui-avatars.com/api/?name=${user.name}&background=random`;

      // Fields
      if (user.birthDetails) {
        if (document.getElementById('profileDob')) document.getElementById('profileDob').value = user.birthDetails.dob || '';
        if (document.getElementById('profileTime')) document.getElementById('profileTime').value = user.birthDetails.tob || '';
        if (document.getElementById('profileCity')) document.getElementById('profileCity').value = user.birthDetails.pob || '';
      }

      const astroFields = document.getElementById('astroProfileFields');
      if (user.role === 'astrologer') {
        astroFields.style.display = 'block';
        document.getElementById('editPrice').value = user.price || '';
        document.getElementById('editExp').value = user.experience || '';
      } else {
        astroFields.style.display = 'none';
      }
    };

    window.saveProfile = function () {
      const update = {};

      if (state.me.role === 'astrologer') {
        update.price = document.getElementById('editPrice').value;
        update.experience = document.getElementById('editExp').value;
      }

      update.birthDetails = {
        dob: document.getElementById('profileDob').value,
        tob: document.getElementById('profileTime').value,
        pob: document.getElementById('profileCity').value
      };

      socket.emit('update-profile', update, (res) => {
        if (res.ok) {
          state.me = res.user;
          saveSession(state.me);
          alert('Profile Updated');
          document.getElementById('screen-profile').classList.add('hidden');
          // Refresh dash if needed (name/image)
          if (state.me.role === 'astrologer') loadAstroDash(state.me);
          else loadClientDash(state.me);
        } else {
          alert('Failed: ' + res.error);
        }
      });
    };

    function fetchAstrologers() {
      socket.emit('get-astrologers', (res) => {
        if (res.astrologers) {
          state.astroList = res.astrologers;
          renderAstroList(state.astroList);
        } else {
          renderAstroList([]);
        }
      });
    }

    function renderAstroList(list) {
      const container = document.getElementById('astroList');
      container.innerHTML = '';

      const astrologers = list || [];

      // Sort: Online First, then by Order Count (desc)
      astrologers.sort((a, b) => {
        if (a.isOnline === b.isOnline) {
          return (b.orderCount || 0) - (a.orderCount || 0);
        }
        return b.isOnline ? 1 : -1;
      });

      if (astrologers.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#A7F3D0;">No astrologers online right now.</div>';
        return;
      }

      astrologers.forEach(a => {
        const div = document.createElement('div');
        div.className = 'astro-card';
        div.onclick = () => openAstroProfile(a);

        // REAL Trust Markers from DB
        const orderCount = a.orderCount || Math.floor(Math.random() * 500) + 100; // Fallback if not in DB yet
        const languages = a.languages || ['Tamil', 'English'];
        const isVerified = a.isVerified; // Real DB Value
        const isDocsVerified = a.isDocumentVerified; // Real DB Value
        const isTopChoice = a.isTopChoice; // Optional extra field if added later

        div.innerHTML = `
          ${isTopChoice ? '<div class="ribbon"><span>Top Choice</span></div>' : ''}

          <!-- Top Row: Image & Info -->
          <div class="card-top-row">
              <div class="astro-img-wrapper">
                  <img src="${a.image || 'https://ui-avatars.com/api/?name=' + a.name + '&background=random'}"
                       class="astro-img ${a.isOnline ? 'online-active' : ''}">
                  <div class="status-badge ${a.isOnline ? 'online' : 'busy'}"></div>
              </div>

              <div class="astro-details">
                  <div class="astro-name">
                    ${a.name}
                    ${isVerified ? '<i class="fas fa-check-circle" style="color:#3B82F6; font-size:0.9rem; margin-left:4px;" title="Verified Astrologer"></i>' : ''}
                  </div>

                  <div class="astro-expertise">${a.skills ? a.skills.join(', ') : 'Vedic, Prashana'}</div>

                  <!-- Document Verified Badge (Conditional) -->
                  ${isDocsVerified ? `
                  <div style="display:inline-flex; align-items:center; gap:4px; font-size:0.75rem; color:#059669; background:#ECFDF5; padding:2px 6px; border-radius:4px; border:1px solid #D1FAE5; margin-bottom:4px;">
                    <i class="fas fa-check-circle"></i> Document Verified
                  </div>` : ''}

                  <div style="font-size:0.8rem; color:#4B5563; margin-bottom:4px;">
                    <i class="fas fa-language" style="color:#F59E0B;"></i> ${languages.join(', ')}
                  </div>

                  <div class="rating-row">
                      <span class="star-rating">‚òÖ 4.9</span>
                      <span style="color:#6B7280; font-size:0.75rem;">(${orderCount} + orders)</span>
                  </div>
              </div>

              <div class="price-tag">‚Çπ${a.price}/min</div>
          </div>

          <!-- Bottom Row: Action Buttons -->
          <div class="card-actions">
              <div class="cta-btn ${a.isChatOnline ? 'active-chat' : ''}"
                   onclick="event.stopPropagation(); checkGuestAction('chat', '${a.userId}')">
                  <i class="fas fa-comment-dots"></i>
                  <span>Chat</span>
              </div>

              <div class="cta-btn ${a.isAudioOnline ? 'active-audio' : ''}"
                   onclick="event.stopPropagation(); checkGuestAction('call', '${a.userId}')">
                  <i class="fas fa-phone-alt"></i>
                  <span>Call</span>
              </div>

              <div class="cta-btn ${a.isVideoOnline ? 'active-video' : ''}"
                   onclick="event.stopPropagation(); checkGuestAction('video', '${a.userId}')">
                  <i class="fas fa-video"></i>
                  <span>Video</span>
              </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Astrologer Dashboard Logic
    function loadAstroDash(user) {
      hideAllScreens();
      sAstro.classList.remove('hidden');
      document.getElementById('astroName').textContent = user.name;
      document.getElementById('astroId').textContent = user.userId.slice(0, 6);

      const avatarImg = document.getElementById('astroAvatar');
      if (user.image && user.image !== 'undefined' && user.image !== 'null') {
        avatarImg.src = user.image;
        avatarImg.onerror = function () {
          this.src = `https://ui-avatars.com/api/?name=${user.name}&background=random`;
        };
      } else {
        avatarImg.src = `https://ui-avatars.com/api/?name=${user.name}&background=random`;
      }

      setupToggle('toggleChat', 'chat');
      setupToggle('toggleCall', 'audio');
      setupToggle('toggleVideo', 'video');

      const anav = document.querySelector('.admin-nav');
      if (anav) anav.style.display = 'none';
      const afoot = document.querySelector('.admin-footer');
      if (afoot) afoot.classList.remove('show');

      const globalFooter = document.querySelector('.doc-bottom-nav');
      if (globalFooter) globalFooter.style.display = 'none';

      // Initialize Wallet Display
      document.getElementById('astroLifetimeDisplay').innerText = Number(user.totalEarnings || 0).toFixed(2);

      // Update Dynamic Prices
      const rate = user.price || 20;
      const pChat = document.getElementById('priceChat');
      const pCall = document.getElementById('priceCall');
      const pVideo = document.getElementById('priceVideo');
      if (pChat) pChat.innerText = rate;
      if (pCall) pCall.innerText = rate;
      if (pVideo) pVideo.innerText = rate;

      // Status Toggles
      updateToggleUI('toggleChat', user.isChatOnline);
      updateToggleUI('toggleCall', user.isAudioOnline);
      updateToggleUI('toggleVideo', user.isVideoOnline);

      // Listen for Wallet Updates
      socket.off('wallet-update'); // Prevent duplicates if reloaded
      socket.on('wallet-update', (data) => {
        // Update earnings display
        if (data.totalEarnings !== undefined) {
          const el = document.getElementById('astroLifetimeDisplay');
          if (el) el.innerText = Number(data.totalEarnings).toFixed(2);
          state.me.totalEarnings = data.totalEarnings;
        }

        // Update stored wallet balance (internal state)
        if (data.balance !== undefined) {
          state.me.walletBalance = data.balance;
        }
        saveSession(state.me);
      });

      // Update Payout Status (if any pending)
      socket.emit('get-payout-status', {}, (res) => {
        const pDiv = document.getElementById('astroPendingWithdrawals');
        if (res.pendingAmount > 0) {
          pDiv.style.display = 'block';
          pDiv.innerHTML = `<i class="fas fa-clock"></i> Pending Withdrawal: ‚Çπ${res.pendingAmount}`;
        } else {
          pDiv.style.display = 'none';
        }
      });
    }

    function setupToggle(id, type) {
      const el = document.getElementById(id);
      if (!el) return;

      el.onclick = () => {
        el.classList.toggle('active');
        const isOnline = el.classList.contains('active');
        socket.emit('toggle-status', { online: isOnline, type: type });
      };
    }

    // Profile Logic
    let tempAvatarUrl = '';

    function showProfile() {
      const u = state.me;
      const editAvatar = document.getElementById('editAvatar');
      editAvatar.src = u.image || `https://ui-avatars.com/api/?name=${u.name}&background=random`;
      document.getElementById('editPrice').value = u.price || 20;
      document.getElementById('editExp').value = u.experience || 0;
      document.getElementById('screen-profile').classList.remove('hidden');
    }

    async function uploadAvatar(input) {
      if (!input.files[0]) return;
      const formData = new FormData();
      formData.append('file', input.files[0]);

      const btn = input.nextElementSibling;
      const oldText = btn.textContent;
      btn.textContent = 'Uploading...';

      try {
        const res = await fetch('/upload', { method: 'POST', body: formData }).then(r => r.json());
        if (res.ok) {
          tempAvatarUrl = res.url;
          document.getElementById('editAvatar').src = res.url;
          btn.textContent = 'Uploaded';
          setTimeout(() => btn.textContent = 'Change Photo', 2000);
        } else {
          alert('Upload Failed');
          btn.textContent = oldText;
        }
      } catch (e) {
        alert('Error uploading');
        btn.textContent = oldText;
      }
    }

    function saveProfile() {
      const price = document.getElementById('editPrice').value;
      const exp = document.getElementById('editExp').value;

      const update = { price, experience: exp };
      if (tempAvatarUrl) update.image = tempAvatarUrl;

      socket.emit('update-profile', update, (res) => {
        if (res.ok) {
          state.me = res.user;
          saveSession(res.user);
          alert('Saved!');
          document.getElementById('screen-profile').classList.add('hidden');
          if (state.me.image) {
            document.getElementById('astroAvatar').src = state.me.image;
          }
        } else {
          alert(res.error || 'Failed');
        }
      });
    }

    // History Logic
    function showHistory() {
      const modal = document.getElementById('screen-history');
      const list = document.getElementById('historyList');
      list.innerHTML = '<div style="text-align:center; margin-top:20px;">Loading...</div>';
      modal.classList.remove('hidden');

      socket.emit('get-history', (res) => {
        if (!res.ok || !res.sessions) {
          list.innerHTML = '<div style="text-align:center; color:red;">Failed to load.</div>';
          return;
        }

        if (res.sessions.length === 0) {
          list.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">No History Found</div>';
          return;
        }

        list.innerHTML = '';
        res.sessions.forEach(s => {
          const date = new Date(s.startTime).toLocaleString();
          const dura = s.duration ? Math.round(s.duration / 1000) + 's' : 'Ongoing/Failed';
          const isMe = s.fromUserId === state.me.userId;
          const otherId = isMe ? s.toUserId : s.fromUserId;

          const item = document.createElement('div');
          item.style.cssText = 'background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #FFD700;';
          item.innerHTML = `
            <div style="font-weight:bold; font-size:0.9rem;">${s.type.toUpperCase()}</div>
            <div style="font-size:0.8rem; color:#555;">ID: ${otherId ? otherId.slice(0, 6) : 'Unknown'}</div>
            <div style="font-size:0.75rem; color:#999; display:flex; justify-content:space-between; margin-top:5px;">
              <span>${date}</span>
              <span>${dura}</span>
            </div>
          `;
          list.appendChild(item);
        });
      });
    }

    // Session Request Logic
    window.requestSession = (targetId, type) => {
      const titles = { chat: 'Chat', audio: 'Audio Call', video: 'Video Call' };
      const modal = document.createElement('div');
      modal.id = 'calling-modal';
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="call-popup" style="background:white; padding:20px; border-radius:15px; text-align:center;">
          ${type !== 'chat' ? `<div class="spinner-astro" style="margin: 0 auto 15px;"></div>` : ''}
          <h3>Requesting ${titles[type]}...</h3>
          <button onclick="document.getElementById('calling-modal').remove()" style="margin-top:10px; padding:8px 20px; border-radius:8px; border:none; background:#ccc;">Cancel</button>
        </div>
      `;
      document.body.appendChild(modal);

      socket.emit('request-session', { toUserId: targetId, type }, (res) => {
        if (res.ok) {
          initSession(res.sessionId, targetId, type, true, null);
          document.getElementById('calling-modal').remove();
        } else {
          document.getElementById('calling-modal').remove();
          alert('Request failed: ' + res.error);
        }
      });
    };

    // Incoming Session Handler
    socket.on('incoming-session', (data) => {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'VIBRATE' }));
      }
      console.log('Incoming session:', data);
      if (state.session) {
        socket.emit('answer-session', { sessionId: data.sessionId, toUserId: data.fromUserId, accept: false });
        return;
      }

      if (data.birthData) {
        window.receivedBirthData = data.birthData;
      } else {
        window.receivedBirthData = null;
      }

      sInc.classList.remove('hidden');
      const titles = { chat: 'Chat Request', audio: 'Incoming Call', video: 'Incoming Video Call' };
      document.getElementById('callerName').innerHTML = `
        <strong>${titles[data.type]}</strong><br>Client ${data.fromUserId.slice(0, 4)}
      `;

      try {
        if (window.incomingAudio) {
          window.incomingAudio.pause();
          window.incomingAudio = null;
        }

        const soundUrl = 'sound.mpeg';
        window.incomingAudio = new Audio(soundUrl);
        window.incomingAudio.loop = true;
        window.incomingAudio.play().catch(e => console.log('Autoplay blocked:', e));
      } catch (e) { console.error('Sound Error', e); }

      document.getElementById('btnAccept').onclick = () => {
        if (window.incomingAudio) {
          window.incomingAudio.pause();
          window.incomingAudio = null;
        }
        sInc.classList.add('hidden');
        socket.emit('answer-session', { sessionId: data.sessionId, toUserId: data.fromUserId, type: data.type, accept: true });
        initSession(data.sessionId, data.fromUserId, data.type, false, data.birthData);
        if (data.type === 'chat') { startTimer(); }
      };

      document.getElementById('btnReject').onclick = () => {
        if (window.incomingAudio) {
          window.incomingAudio.pause();
          window.incomingAudio = null;
        }
        sInc.classList.add('hidden');
        socket.emit('answer-session', { sessionId: data.sessionId, toUserId: data.fromUserId, accept: false });
      };
    });

    socket.on('session-answered', (data) => {
      if (data.accept) {
        if (state.session.type === 'chat') {
          startTimer();
        } else {
          startWebRTC(true);
        }
      } else {
        alert('Request Rejected');
        sSes.classList.add('hidden');
        state.session = null;
      }
    });

    // Timer Logic
    let timerInt = null;
    let timerSec = 0;

    function startTimer() {
      if (timerInt) return;
      timerSec = 0;
      updateTimerDisplay();
      timerInt = setInterval(() => {
        timerSec++;
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer() {
      if (timerInt) {
        clearInterval(timerInt);
        timerInt = null;
      }
    }

    function updateTimerDisplay() {
      const m = Math.floor(timerSec / 60).toString().padStart(2, '0');
      const s = (timerSec % 60).toString().padStart(2, '0');
      document.getElementById('sessionTimer').innerHTML = `${m}:${s} <span style="font-size:0.8rem; opacity:0.8;"></span>`;
    }

    // Session Management
    function initSession(sid, pid, type, isInit, birthData) {
      document.getElementById('messagesList').innerHTML = '';

      state.session = { id: sid, partnerId: pid, type };
      sSes.classList.remove('hidden');

      // Trigger Billing Start on Server
      socket.emit('session-connect', { sessionId: sid });

      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'KEEP_AWAKE', enable: true }));
      }

      if (birthData) {
        window.receivedBirthData = birthData;
      }

      if (state.me && state.me.role === 'astrologer') {
        const dScore = document.getElementById('dailyScore');
        if (dScore) dScore.innerText = `‚Çπ${state.me.walletBalance || 0}`; // Using score as wallet for now?

        // Phase 15: new display
        const wDisplay = document.getElementById('astroWalletDisplay');
        if (wDisplay) wDisplay.innerText = state.me.walletBalance || 0;

        const lDisplay = document.getElementById('astroLifetimeDisplay');
        if (lDisplay) lDisplay.innerText = state.me.totalEarnings || 0;

        // Update Withdraw Button State
        const btnWithdraw = document.getElementById('btnAstroWithdraw');
        if (btnWithdraw) {
          if ((state.me.walletBalance || 0) < 500) {
            btnWithdraw.style.opacity = '0.5';
            btnWithdraw.style.cursor = 'not-allowed';
          } else {
            btnWithdraw.style.opacity = '1';
            btnWithdraw.style.cursor = 'pointer';
          }
        }

        // Setup chart helper
        window.currentAstroId = state.me.userId;

        const btn = document.getElementById('btnChatChart');
        const headerDiv = document.getElementById('clientDetailsHeader');
        const contentDiv = document.getElementById('clientDetailsContent');

        if (btn) btn.style.display = 'block';

        if (window.receivedBirthData) {
          const bd = window.receivedBirthData;
          if (headerDiv) {
            contentDiv.innerHTML = `
              <div>üìÖ DOB: ${bd.day}/${bd.month}/${bd.year}</div>
              <div>‚è∞ Time: ${String(bd.hour).padStart(2, '0')}:${String(bd.minute).padStart(2, '0')}</div>
              <div>üìç Location: ${bd.city || 'N/A'}</div>
              <div>üåç Coordinates: ${bd.latitude}¬∞N, ${bd.longitude}¬∞E</div>
            `;
            headerDiv.style.display = 'block';
          }
        } else {
          if (headerDiv) headerDiv.style.display = 'none';
        }
      } else {
        const btn = document.getElementById('btnChatChart');
        if (btn) btn.style.display = 'none';

        // Show Edit Info for Client
        const btnEdit = document.getElementById('btnEditInfo');
        if (btnEdit) btnEdit.style.display = 'block';

        const headerDiv = document.getElementById('clientDetailsHeader');
        if (headerDiv) headerDiv.style.display = 'none';
      }

      const vArea = document.querySelector('.video-area');
      const localV = document.getElementById('localVideo');
      const remoteV = document.getElementById('remoteVideo');
      const controls = document.querySelector('.controls');
      const sessionInfo = document.getElementById('sessionInfo');
      const recInd = document.getElementById('recIndicator');
      const timer = document.getElementById('sessionTimer');

      timer.innerText = '00:00';
      timerSec = 0;

      if (type === 'chat') {
        vArea.style.cssText = 'height: 60px; flex: 0 0 60px; background: #FFFFFF; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 15px;';
        localV.style.display = 'none';
        remoteV.style.display = 'none';
        controls.classList.add('hidden');
        recInd.style.display = 'none';
        sessionInfo.style.cssText = 'position: static; color: black;';
        timer.style.cssText = 'color: black; font-weight: bold; font-size: 1.1rem;';

        let btnEndTitle = document.getElementById('btnEndChat');
        if (!btnEndTitle) {
          const btn = document.createElement('button');
          btn.id = 'btnEndChat';
          btn.innerHTML = 'End Chat';
          btn.style.cssText = 'background:#EF4444; color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; cursor:pointer; font-size:0.9rem;';
          btn.onclick = () => document.getElementById('btnEnd').click();
          vArea.appendChild(btn);
        } else {
          btnEndTitle.style.display = 'block';
        }
      } else {
        if (document.getElementById('btnEndChat')) document.getElementById('btnEndChat').style.display = 'none';
        controls.classList.remove('hidden');

        if (type === 'audio') {
          vArea.style.cssText = 'height: 250px; flex: 0 0 250px; background: #1F2937;';
          localV.style.display = 'none';
          remoteV.style.display = 'none';
        } else {
          vArea.style.cssText = 'flex: 1; background: black;';
          localV.style.display = 'block';
          remoteV.style.display = 'block';
        }
      }

      if (!isInit && type !== 'chat') startWebRTC(false);
    }

    // WebRTC Logic
    async function startWebRTC(initiator) {
      if (state.session.type === 'chat') return;

      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Camera/Mic access failed. Please use HTTPS or localhost.");
        const loader = document.getElementById('connectionStatus');
        if (loader) loader.classList.add('hidden');
        return;
      }

      try {
        const constraints = {
          audio: true,
          video: state.session.type === 'video'
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);

        if (state.session.type === 'video') {
          document.getElementById('localVideo').srcObject = stream;
        }

        const p = new SimplePeer({ initiator, stream, trickle: false });

        p.on('signal', d => {
          if (state.session) {
            socket.emit('signal', { sessionId: state.session.id, toUserId: state.session.partnerId, signal: d });
          }
        });

        p.on('stream', s => {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'VIBRATE' }));
          }
          const loader = document.getElementById('connectionStatus');
          if (loader) loader.classList.add('hidden');

          const rv = document.getElementById('remoteVideo');
          rv.srcObject = s;
          if (state.session.type === 'audio') {
            rv.style.opacity = 0;
          } else {
            rv.style.opacity = 1;
          }
          startTimer();
        });

        p.on('error', err => {
          console.error('Peer Error', err);
        });

        p.on('data', data => {
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'VIBRATE' }));
          }
          console.log('WebRTC Data:', data);
        });

        state.peer = p;
        state.localStream = stream;
      } catch (e) {
        console.error(e);
        alert('Device Error: ' + e.message);
        const loader = document.getElementById('connectionStatus');
        if (loader) loader.textContent = 'Error: ' + e.message;
      }
    }

    // Signal Handler
    socket.on('signal', d => {
      if (state.session && d.sessionId === state.session.id && state.peer) {
        state.peer.signal(d.signal);
      }
    });

    // End Session
    document.getElementById('btnEnd').onclick = () => {
      if (state.session) {
        socket.emit('session-ended', { sessionId: state.session.id, toUserId: state.session.partnerId });
      }
      endLocal();
    };

    socket.on('session-ended', endLocal);

    function endLocal(data) {
      if (data && data.reason === 'insufficient_funds') {
        showLowBalanceAlert(state.me.walletBalance || 0, "Current session ended due to insufficient funds. Please recharge to continue.");
      } else if (data && data.summary) {
        // Show summary modal ONLY for Clients
        if (state.me.role !== 'astrologer') {
          showSummary(data.summary);
        }
      }

      // Force refresh of wallet/earnings
      if (state.me && state.me.userId) {
        socket.emit('get-wallet', { userId: state.me.userId });
      }

      if (state.me && state.me.role === 'astrologer') {
        socket.emit('toggle-status', { online: true, type: 'online' });
      }
      stopTimer();
      if (state.peer) { state.peer.destroy(); state.peer = null; }
      if (state.localStream) {
        state.localStream.getTracks().forEach(t => t.stop());
        state.localStream = null;
        document.getElementById('localVideo').srcObject = null;
      }
      sSes.classList.add('hidden');
      state.session = null;

      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'KEEP_AWAKE', enable: false }));
      }



      document.querySelector('.video-area').style.cssText = '';
      document.getElementById('localVideo').srcObject = null;
      document.querySelector('.controls').classList.remove('hidden');
    }

    // Chat Logic
    const appendMsg = (txt, isMe, messageId, timestamp = Date.now()) => {
      const t = new Date(timestamp);
      const timeStr = t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      const mid = messageId || Date.now();

      const div = document.createElement('div');
      div.id = 'msg-' + mid;
      div.style.cssText = 'max-width: 80%; padding: 8px 12px; border-radius: 12px; margin-bottom: 8px; font-size: 0.9rem; align-self: ' + (isMe ? 'flex-end' : 'flex-start') + '; background: ' + (isMe ? '#FFD700' : 'white') + '; border: ' + (isMe ? 'none' : '1px solid #eee') + '; color: black; margin-left: ' + (isMe ? 'auto' : '0') + '; display:flex; flex-direction:column; min-width:100px;';

      // Ticks for ME
      const tickHtml = isMe ? `<span class="msg-tick" id="tick-${mid}" style="margin-left:5px; font-size:0.7rem; color:#777;">‚úì</span>` : '';

      div.innerHTML = `
    <div style="word-wrap:break-word;">${txt}</div>
    <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:2px;">
       <span style="font-size:0.65rem; color:#666; margin-right:2px;">${timeStr}</span>
       ${tickHtml}
    </div>
  `;
      document.getElementById('messagesList').appendChild(div);
      document.getElementById('messagesList').scrollTop = document.getElementById('messagesList').scrollHeight;
    };

    document.getElementById('btnSend').onclick = () => {
      const txt = document.getElementById('msgInput').value.trim();
      if (!txt) return;

      const requestDetailsDiv = document.getElementById('clientRequestDetails');
      if (requestDetailsDiv) {
        requestDetailsDiv.style.display = 'none';
      }

      const mid = Date.now();
      socket.emit('chat-message', {
        toUserId: state.session.partnerId, sessionId: state.session.id,
        content: { type: 'text', text: txt }, messageId: mid, timestamp: mid
      });
      appendMsg(txt, true, mid, mid);
      document.getElementById('msgInput').value = '';
    };

    // Chat Message Handler
    socket.on('chat-message', d => {
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({ type: 'VIBRATE' }));
      }
      if (state.session && d.fromUserId === state.session.partnerId) {
        const requestDetailsDiv = document.getElementById('clientRequestDetails');
        if (requestDetailsDiv) {
          requestDetailsDiv.style.display = 'none';
        }

        // Emit delivered immediately
        if (d.messageId) {
          socket.emit('message-delivered', { toUserId: d.fromUserId, messageId: d.messageId });

          // Simulate Read after 1s (or if window focused)
          setTimeout(() => {
            socket.emit('message-read', { toUserId: d.fromUserId, messageId: d.messageId });
          }, 1000);
        }

        appendMsg(d.content.text || 'Message', false, d.messageId, d.timestamp);
      }
    });

    // Typing Logic
    let typingTimeout = null;
    document.getElementById('msgInput').addEventListener('input', () => {
      if (!state.session) return;
      socket.emit('typing', { toUserId: state.session.partnerId, isTyping: true });

      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit('typing', { toUserId: state.session.partnerId, isTyping: false });
      }, 2000);
    });

    socket.on('typing', (data) => {
      const el = document.getElementById('typingIndicator');
      if (state.session && data.fromUserId === state.session.partnerId && el) {
        if (data.isTyping) {
          el.innerText = 'Typing...';
          el.style.display = 'block';
        } else {
          el.style.display = 'none';
        }
      }
    });

    // Message Status Handler (Ticks)
    socket.on('message-status', d => {
      const tick = document.getElementById('tick-' + d.messageId);
      if (tick) {
        if (d.status === 'sent') tick.innerText = '‚úì'; // Single Grey
        if (d.status === 'delivered') tick.innerText = '‚úì‚úì'; // Double Grey
        if (d.status === 'read' || d.status === 'seen') {
          tick.innerText = '‚úì‚úì';
          tick.style.color = '#3b82f6'; // Blue
        }
      }
    });

    // --- Admin Dashboard Logic ---
    let adminUsersCache = [];

    window.navAdmin = function (tab) {
      // 1. Update Buttons
      document.querySelectorAll('.admin-nav-item').forEach(el => el.classList.remove('active'));
      const btn = document.getElementById('anav-' + tab);
      if (btn) btn.classList.add('active');

      // 2. Switch Section
      document.querySelectorAll('.admin-tab-section').forEach(el => el.classList.remove('active'));
      const sect = document.getElementById('admin-sect-' + tab);
      if (sect) sect.classList.add('active');

      // 3. Logic dependent on tab
      if (tab === 'home' || tab === 'earnings') {
        loadAdminLedgerStats(); // Refresh Stats
      } else if (tab === 'payouts') {
        // Filter Astrologers from Cache
        const astros = adminUsersCache.filter(u => u.role === 'astrologer');
        renderAdminAstros(astros);
        loadAdminWithdrawals(); // Phase 15
      } else if (tab === 'users') {
        // Filter Clients from Cache
        const clients = adminUsersCache.filter(u => u.role !== 'astrologer' && u.role !== 'superadmin');
        renderAdminClients(clients);
      }
    };

    function loadAdminDash(user) {
      hideAllScreens();
      sAdmin.classList.remove('hidden');

      // HIDE GLOBAL FOOTER (Client Nav)
      const globalFooter = document.querySelector('.doc-bottom-nav');
      if (globalFooter) globalFooter.style.display = 'none';

      const anav = document.querySelector('.admin-nav');
      if (anav) anav.style.display = 'flex';
      const afoot = document.querySelector('.admin-footer');
      if (afoot) afoot.classList.add('show');

      navAdmin('home'); // Default to home tab

      // Fetch initial data
      socket.emit('get-all-users', (res) => {
        if (res.ok) {
          adminUsersCache = res.users;
          // Don't render yet until tab is clicked or initialized
        }
      });
      loadAdminLedgerStats();

      // Update footer time
      updateAdminFooterTime();
      setInterval(updateAdminFooterTime, 60000);
    }

    function updateAdminFooterTime() {
      const now = new Date();
      const timeEl = document.getElementById('footerTime');
      if (timeEl) {
        timeEl.innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    }

    function loadAdminLedgerStats() {
      socket.emit('admin-get-ledger-stats', {}, (res) => {
        if (res.ok) {
          setText('quickRev', '‚Çπ' + (res.stats.totalRevenue || 0));
          setText('quickProfit', '‚Çπ' + (res.stats.adminProfit || 0));
          setText('quickPayout', '‚Çπ' + (res.stats.astroPayout || 0));
          setText('quickMins', Math.round((res.stats.totalDuration || 0) / 60));

          setText('footerTotalUsers', res.stats.totalUsers || 0);
          setText('footerRevenue', '‚Çπ' + (res.stats.totalRevenue || 0));
          setText('footerSessions', res.stats.activeSessions || 0);

          // Update Chart if exists
          const chartInstance = Chart.getChart("revenueChart");
          if (chartInstance) {
            // Simple mock historical data for visual effect, anchored to real total
            const total = res.stats.totalRevenue || 0;
            const profit = res.stats.adminProfit || 0;

            // Distribute total over last 6 months (mock distribution)
            const spread = [0.1, 0.15, 0.1, 0.2, 0.25, 0.2];
            const revData = spread.map(x => Math.round(x * total));
            const profData = spread.map(x => Math.round(x * profit));

            chartInstance.data.datasets[0].data = revData;
            chartInstance.data.datasets[1].data = profData;
            chartInstance.update();
          }

          if (res.fullLedger) {
            const tbody = document.getElementById('fullLedgerBody');
            tbody.innerHTML = '';
            // Aggregate by type
            const agg = {};
            res.fullLedger.forEach(l => {
              if (!agg[l.type]) agg[l.type] = { count: 0, amount: 0 };
              agg[l.type].count++;
              agg[l.type].amount += (l.amount || 0);
            });

            Object.keys(agg).forEach(k => {
              const row = document.createElement('tr');
              row.innerHTML = `
                  <td style="padding:16px 15px; border-bottom:1px solid #e5e7eb;">${k.toUpperCase().replace('_', ' ')}</td>
                  <td style="padding:16px 15px; text-align:center; border-bottom:1px solid #e5e7eb;">${agg[k].count}</td>
                  <td style="padding:16px 15px; text-align:right; font-weight:700; color:#059669; border-bottom:1px solid #e5e7eb;">‚Çπ${agg[k].amount}</td>
                `;
              tbody.appendChild(row);
            });
          } else {
            const tbody = document.getElementById('fullLedgerBody');
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">No Data</td></tr>';
            }
          }
        }
      });
    }

    function formatReason(r) {
      if (r === 'first_60') return '<span style="color:#DC2626; font-weight:600;">First Min</span>';
      if (r === 'first_60_partial') return '<span style="color:#DC2626;">First Min (Partial)</span>';
      if (r === 'rounded') return '<span style="color:#F59E0B;">Rounding</span>';
      if (r?.startsWith('slab_')) return `<span style="color:#059669;">Slab ${r.split('_')[1]}</span>`;
      return r;
    }

    function setText(id, val) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = val;
    }

    // --- Admin Edit User Modal Logic ---
    window.openAdminEditUser = (userId) => {
      // Find user in local cache
      const u = adminUsersCache.find(x => x.userId === userId);
      if (!u) return alert('User not found in cache');

      document.getElementById('adminEditUserId').value = u.userId;
      document.getElementById('adminEditName').value = u.name;

      const astroFields = document.getElementById('adminEditAstroFields');
      if (u.role === 'astrologer') {
        astroFields.style.display = 'block';
        document.getElementById('adminEditPrice').value = u.price || 20;
        document.getElementById('adminEditVerified').checked = u.isVerified || false;

        // Handle Document Status
        // If has documentStatus (new), use it. Else fallback to isDocumentVerified
        let docStatus = u.documentStatus || (u.isDocumentVerified ? 'verified' : 'none');
        document.getElementById('adminEditDocStatus').value = docStatus;

      } else {
        astroFields.style.display = 'none';
      }

      document.getElementById('adminEditModal').classList.remove('hidden');
    };

    window.saveAdminEditUser = () => {
      const uid = document.getElementById('adminEditUserId').value;
      const name = document.getElementById('adminEditName').value;
      const u = adminUsersCache.find(x => x.userId === uid);

      const updates = { name };

      if (u.role === 'astrologer') {
        updates.price = document.getElementById('adminEditPrice').value;
        updates.isVerified = document.getElementById('adminEditVerified').checked;
        updates.documentStatus = document.getElementById('adminEditDocStatus').value;
      }

      socket.emit('admin-update-user-details', { userId: uid, updates }, (res) => {
        if (res.ok) {
          alert('Updated Successfully');
          document.getElementById('adminEditModal').classList.add('hidden');
          loadAdminDash(); // Refresh List
        } else {
          alert('Error: ' + res.error);
        }
      });
    };

    // Render Astrologers for Payout Tab
    function renderAdminAstros(list) {
      const container = document.getElementById('adminAstroList');
      if (!container) return;
      container.innerHTML = '';

      if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:#9ca3af;"><i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px; display:block;"></i>No astrologers found</div>';
        return;
      }

      // Sort: Newest First, then Offline Astrologers
      list.sort((a, b) => {
        // First sort by newest (by _id)
        if (a._id && b._id) {
          const idCompare = b._id.localeCompare(a._id);
          if (idCompare !== 0) return idCompare;
        }
        // Then sort offline astrologers to bottom
        const aOnline = a.isOnline ? 1 : 0;
        const bOnline = b.isOnline ? 1 : 0;
        return bOnline - aOnline;
      });

      list.forEach(u => {
        const div = document.createElement('div');
        div.className = 'admin-user-card';
        const onlineStatus = u.isOnline ? '<span style="color:#22c55e; font-weight:600;">üü¢ Online</span>' : '<span style="color:#9ca3af; font-weight:600;">‚ö´ Offline</span>';

        div.innerHTML = `
            <div class="admin-user-header">
              <div>
                <div class="admin-user-name">${u.name}</div>
                <div style="font-size:0.8rem; color:#9ca3af; margin-top:2px;">${u.phone} ‚Ä¢ ID: ${u.userId.slice(0, 6)}...</div>
                <div style="font-size:0.75rem; margin-top:4px;">${onlineStatus}</div>
              </div>
              <div style="text-align:right;">
                <div style="font-weight:700; color:#059669; font-size:1.1rem;">‚Çπ${u.walletBalance || 0}</div>
                <div class="admin-user-role" style="background:#fef3c7; color:#d97706; margin-top:4px;">Astrologer</div>
              </div>
            </div>
            <div class="admin-actions">
               <button class="btn-admin btn-wallet" onclick="adminWallet('${u.userId}')" title="Manage Wallet">
                 <i class="fas fa-wallet"></i> Wallet
               </button>
               <button class="btn-admin btn-role" onclick="adminRole('${u.userId}', '${u.role}')" title="Change Role">
                 <i class="fas fa-user-tag"></i> Role
               </button>
               <button class="btn-admin btn-role" onclick="openAdminEditUser('${u.userId}')" title="Edit Profile">
                 <i class="fas fa-edit"></i> Edit
               </button>
               <button class="btn-admin btn-block" onclick="adminBan('${u.userId}', ${!u.isBanned})" title="${u.isBanned ? 'Unblock User' : 'Block User'}">
                 <i class="fas fa-ban"></i> ${u.isBanned ? 'Unblock' : 'Block'}
               </button>
            </div>
          `;
        container.appendChild(div);
      });
    }

    // Render Clients for Users Tab
    function renderAdminClients(list) {
      const container = document.getElementById('adminClientList');
      if (!container) return;
      container.innerHTML = '';

      if (list.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:30px; color:#9ca3af;"><i class="fas fa-inbox" style="font-size:2rem; margin-bottom:10px; display:block;"></i>No users found</div>';
        return;
      }

      list.sort((a, b) => {
        if (a.role === 'astrologer' && b.role !== 'astrologer') return -1; // Astrologers first
        if (a._id && b._id) return b._id.localeCompare(a._id);
        return 0;
      });

      list.forEach(u => {
        const div = document.createElement('div');
        div.className = 'admin-user-card';
        const isAstro = u.role === 'astrologer';
        const roleColor = isAstro ? '#ECFDF5' : '#EFF6FF';
        const roleTextColor = isAstro ? '#059669' : '#1E3A8A';
        const roleBorder = isAstro ? '2px solid #F59E0B' : '1px solid #E5E7EB';

        div.style.border = roleBorder;

        // Verification Statuses
        const isVerified = u.isVerified || false;
        const isDocs = u.isDocumentVerified || false;

        div.innerHTML = `
           <div class="admin-user-header">
             <div>
               <div class="admin-user-name">
                 ${u.name}
                 ${isVerified ? '<i class="fas fa-check-circle" style="color:#3B82F6;"></i>' : ''}
               </div>
               <div style="font-size:0.8rem; color:#9ca3af; margin-top:2px;">${u.phone} ‚Ä¢ ${u.role.toUpperCase()}</div>
               ${isAstro && isDocs ? '<div style="font-size:0.7rem; color:#059669;"><i class="fas fa-file-contract"></i> Docs Verified</div>' : ''}
             </div>
             <div style="text-align:right;">
               <div style="font-weight:700; color:#059669; font-size:1.1rem;">‚Çπ${u.walletBalance || 0}</div>
             </div>
           </div>

           <div class="admin-actions">
              <button class="btn-admin btn-wallet" onclick="adminWallet('${u.userId}')"><i class="fas fa-plus"></i> Wallet</button>
              <button class="btn-admin btn-role" onclick="openAdminEditUser('${u.userId}')"><i class="fas fa-edit"></i> Edit</button>

              <button class="btn-admin btn-block" onclick="adminBan('${u.userId}', ${!u.isBanned})" style="background:${u.isBanned ? '#DC2626' : '#eee'}; color:${u.isBanned ? 'white' : '#666'};">
                <i class="fas fa-ban"></i>
              </button>
            </div>
           `;
        container.appendChild(div);
      });
    }

    window.adminWallet = (uid) => {
      const amt = prompt("Enter amount to ADD (e.g., 100):");
      if (amt) {
        socket.emit('admin-add-money', { userId: uid, amount: parseInt(amt) }, (res) => {
          alert(res.msg || (res.ok ? 'Success' : 'Failed'));
          loadAdminDash(); // Refresh
        });
      }
    };

    // --- Phase 15: Withdrawal Logic ---

    // Astrologer Request
    window.astroRequestWithdrawal = () => {
      // We can get current balance from UI or cache
      const balance = parseInt(document.getElementById('astroWalletDisplay')?.innerText || '0');
      if (balance < 500) {
        alert("Minimum wallet balance of ‚Çπ500 is required to request withdrawal.");
        return;
      }

      const amt = prompt(`Enter amount to withdraw(Max ‚Çπ${balance}): `, balance);
      if (!amt) return;

      const amount = parseInt(amt);
      if (isNaN(amount) || amount <= 0) {
        alert("Invalid amount");
        return;
      }
      if (amount > balance) {
        alert("Amount exceeds wallet balance");
        return;
      }

      // Confirm
      if (!confirm(`Request withdrawal of ‚Çπ${amount}?`)) return;

      socket.emit('request-withdrawal', { amount }, (res) => {
        if (res.ok) {
          alert("Request Sent! Pending Admin Approval.");
        } else {
          alert(res.error || "Failed");
        }
        // Update UI if needed, but balance doesn't change yet
      });
    };

    // Admin: Load Pending Withdrawals
    function loadAdminWithdrawals() {
      socket.emit('get-withdrawals', {}, (res) => {
        const container = document.getElementById('adminWithdrawalsList');
        const section = document.getElementById('adminWithdrawalsSection');
        if (!container || !section) return;

        if (res.ok && res.list && res.list.length > 0) {
          section.style.display = 'block';
          container.innerHTML = '';
          res.list.filter(x => x.status === 'pending').forEach(w => {
            const div = document.createElement('div');
            div.className = 'admin-card';
            div.style.borderLeft = '4px solid #DC2626';
            div.innerHTML = `
                      <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                           <div style="font-weight:bold; color:#111;">${w.astroName}</div>
                           <div style="font-size:0.8rem; color:#666;">${w.astroPhone}</div>
                           <div style="font-size:0.75rem; color:#999;">${new Date(w.requestedAt).toLocaleDateString()}</div>
                        </div>
                        <div style="text-align:right;">
                           <div style="font-size:1.2rem; font-weight:bold; color:#DC2626;">‚Çπ${w.amount}</div>
                           <button onclick="adminApproveWithdrawal('${w._id}')"
                             style="margin-top:5px; background: #059669; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                             Approve
                           </button>
                        </div>
                      </div >
              `;
            container.appendChild(div);
          });
        } else {
          section.style.display = 'none';
        }
      });
    }

    window.adminApproveWithdrawal = (wid) => {
      if (!confirm("Approve this withdrawal? Funds will be deducted from Astrologer's wallet now.")) return;
      socket.emit('approve-withdrawal', { withdrawalId: wid }, (res) => {
        if (res.ok) {
          alert("Withdrawal Approved & Funds Deducted.");
          loadAdminWithdrawals(); // Refresh list
          navAdmin('payouts'); // Refresh astro list too
        } else {
          alert("Error: " + (res.msg || 'Failed'));
        }
      });
    };

    // Hook into Admin Nav
    const originalNavAdmin = window.navAdmin;


    let roleChangeTargetId = null;

    window.adminRole = (uid, currentRole) => {
      document.getElementById('adminRoleSelect').value = currentRole;
      document.getElementById('screen-admin-role-modal').classList.remove('hidden');
    };

    window.submitAdminRoleChange = () => {
      if (!roleChangeTargetId) return;
      const newRole = document.getElementById('adminRoleSelect').value;

      socket.emit('admin-update-role', { userId: roleChangeTargetId, role: newRole }, (res) => {
        if (res.ok) {
          alert('Role Updated');
          document.getElementById('screen-admin-role-modal').classList.add('hidden');
          refreshAdminData();
        } else {
          alert('Failed to update role');
        }
      });
    };

    window.adminBan = (uid, doBan) => {
      if (confirm(doBan ? 'Block this user?' : 'Unblock this user?')) {
        socket.emit('admin-toggle-ban', { userId: uid, isBanned: doBan }, (res) => {
          if (res.ok) { alert(doBan ? 'User Blocked' : 'User Unblocked'); refreshAdminData(); }
          else alert('Failed');
        });
      }
    };

    // Admin: Verify Users (Blue Tick / Docs)
    window.adminVerify = (uid, field, value) => {
      // value is passed as boolean
      const label = field === 'isVerified' ? 'Verification Badge' : 'Document Verification';
      if (confirm(`Change ${label} status?`)) {
        socket.emit('admin-toggle-verification', { targetUserId: uid, field: field, value: value }, (res) => {
          if (res.ok) {
            // alert('Updated!'); // Optional: silent update is better for admin flow
            refreshAdminData();
          } else {
            alert(res.error || 'Failed to update');
          }
        });
      }
    };

    // Admin: Edit User Name (Prompt)

    function adminEditUser(targetId, currentName) {
      const newName = prompt('Enter new display name:', currentName);
      if (!newName || newName === currentName) return;

      socket.emit('admin-edit-user', { targetUserId: targetId, updates: { name: newName } }, (res) => {
        if (res.ok) {
          alert('Name Updated');
          loadAdminDash(state.me);
        } else {
          alert('Failed: ' + (res.error || 'Unknown'));
        }
      });
    }

    socket.on('force-logout', () => {
      alert('Your account has been suspended by Admin.');
      clearSession();
    });

    // Geolocation
    window.useCurrentLocation = function () {
      if (!navigator.geolocation) return alert("Geolocation not supported");

      const btn = document.querySelector('button[onclick="useCurrentLocation()"]');
      const icon = btn.querySelector('i');
      const oldClass = icon.className;

      icon.className = "fas fa-spinner fa-spin";

      navigator.geolocation.getCurrentPosition(async (Pos) => {
        const lat = Pos.coords.latitude;
        const lon = Pos.coords.longitude;

        document.getElementById('chartLat').value = lat.toFixed(4);
        document.getElementById('chartLon').value = lon.toFixed(4);

        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
          const data = await res.json();
          if (data && data.display_name) {
            const parts = data.display_name.split(',');
            document.getElementById('citySearch').value = parts[0] + (parts[1] ? ',' + parts[1] : '');
          } else {
            document.getElementById('citySearch').value = "Current Location";
          }
        } catch (e) {
          document.getElementById('citySearch').value = "Ky Coordinates";
        }

        icon.className = "fas fa-check";
        setTimeout(() => icon.className = oldClass, 2000);

      }, (err) => {
        alert("Location Access Denied: " + err.message);
        icon.className = oldClass;
      });
    };

    // City Search
    (function () {
      const inp = document.getElementById('citySearch');
      const res = document.getElementById('cityResults');
      let t;
      if (inp) {
        inp.addEventListener('input', e => {
          const v = e.target.value.trim();
          if (v.length < 3) { res.style.display = 'none'; return; }
          clearTimeout(t);
          t = setTimeout(async () => {
            res.innerHTML = '<div style="padding:10px; color:#666;">Searching...</div>';
            res.style.display = 'block';
            try {
              const req = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=15&q=${encodeURIComponent(v)}`);
              const data = await req.json();
              res.innerHTML = '';
              if (!data.length) { res.innerHTML = '<div style="padding:10px; color:#999;">No results</div>'; return; }

              data.sort((a, b) => {
                const nA = a.display_name.toLowerCase();
                const nB = b.display_name.toLowerCase();
                let sA = 0; if (nA.includes("tamil nadu")) sA += 100; else if (nA.includes("india")) sA += 50;
                let sB = 0; if (nB.includes("tamil nadu")) sB += 100; else if (nB.includes("india")) sB += 50;
                return sB - sA;
              });

              data.forEach(p => {
                const d = document.createElement('div');
                d.innerText = p.display_name;
                d.style.cssText = 'padding: 10px; border-bottom: 1px solid #f0f0f0; cursor: pointer; font-size: 0.85rem;';
                d.onmouseover = () => d.style.background = '#f3f4f6';
                d.onmouseout = () => d.style.background = 'white';
                d.onclick = () => {
                  document.getElementById('chartLat').value = p.lat;
                  document.getElementById('chartLon').value = p.lon;
                  const parts = p.display_name.split(',');
                  inp.value = parts[0] + (parts[1] ? ',' + parts[1] : '');
                  res.style.display = 'none';
                };
                res.appendChild(d);
              });
            } catch (e) { res.style.display = 'none'; }
          }, 500);
        });
        document.addEventListener('click', e => { if (e.target !== inp && e.target !== res) res.style.display = 'none'; });
      }
    })();

    // Client Birth Chart Form
    let citySearchTimeout;

    window.handleCityInput = async function (query) {
      clearTimeout(citySearchTimeout);
      const resultsDiv = document.getElementById('clientCityResults');

      if (!query || query.trim().length < 2) {
        resultsDiv.style.display = 'none';
        return;
      }

      citySearchTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/city-autocomplete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: query.trim() })
          });

          const data = await response.json();

          if (data.ok && data.results && data.results.length > 0) {
            let html = '';
            data.results.forEach((city, index) => {
              const stateLabel = city.state ? ` (${city.state})` : '';
              html += `
                <div onclick="selectCity(${index}, '${city.name}', '${city.state}', ${city.latitude}, ${city.longitude})"
                  style="padding:10px 15px; cursor:pointer; border-bottom:1px solid #eee; hover:background:#f5f5f5; transition:0.2s;"
                  onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                  <div style="font-weight:500; color:#333;">${city.name}${stateLabel}</div>
                  <div style="font-size:0.85rem; color:#999;">${city.displayName}</div>
                </div>
              `;
            });
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
          } else {
            resultsDiv.innerHTML = '<div style="padding:10px 15px; color:#999;">No cities found</div>';
            resultsDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('City search error:', error);
          resultsDiv.innerHTML = '<div style="padding:10px 15px; color:#f00;">Error searching cities</div>';
          resultsDiv.style.display = 'block';
        }
      }, 300);
    };

    window.selectCity = async function (index, cityName, state, latitude, longitude) {
      document.getElementById('clientCitySearch').value = cityName;
      document.getElementById('clientCityResults').style.display = 'none';
      document.getElementById('clientChartLat').value = latitude;
      document.getElementById('clientChartLon').value = longitude;

      try {
        const response = await fetch('/api/city-timezone', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ latitude, longitude })
        });

        const data = await response.json();

        if (data.ok) {
          const gmtOffset = data.gmtOffset || 5.5;
          document.getElementById('clientChartTz').value = gmtOffset;
        } else {
          document.getElementById('clientChartTz').value = '5.5';
        }
      } catch (error) {
        console.error('Timezone fetch error:', error);
        document.getElementById('clientChartTz').value = '5.5';
      }
    };

    window.showChatWithBirthChart = function (astroId) {
      window.selectedAstroId = astroId;

      // Smart Check: If we already have intake details, skip the form!
      if (state.me && state.me.intakeDetails && state.me.intakeDetails.topic) {
        // We have details. Construct birthData for the request directly.
        // NOTE: We need birthData (lat/lon etc) which are in state.me.birthDetails
        const bd = state.me.birthDetails;
        const id = state.me.intakeDetails;

        if (bd && bd.dob && bd.lat) {
          // Parse DOB/Time
          const [y, m, d] = bd.dob.split('-').map(Number);
          const [h, min] = bd.tob.split(':').map(Number);

          const birthData = {
            name: state.me.name,
            gender: id.gender,
            marital: id.marital,
            occupation: id.occupation,
            topic: id.topic,
            partner: id.partner,
            year: y, month: m, day: d,
            hour: h, minute: min,
            latitude: bd.lat,
            longitude: bd.lon,
            city: bd.pob,
            timezone: 5.5 // Default
          };

          // Direct Request
          socket.emit('request-session', { toUserId: astroId, type: 'chat', birthData }, (res) => {
            if (res.ok) initSession(res.sessionId, astroId, 'chat', true, null);
            else alert('Request failed: ' + res.error);
          });
          return;
        }
      }

      // If no details, show the form
      document.getElementById('screen-client-birth-chart').classList.remove('hidden');

      const now = new Date();
      document.getElementById('clientChartDate').value = now.toISOString().split('T')[0];
      document.getElementById('clientChartTime').value = now.toTimeString().slice(0, 5);

      if (state.me) {
        document.getElementById('clientChartName').value = state.me.name || '';
        document.getElementById('clientChartPhone').value = state.me.phone || '';
        // Pre-fill if partial data exists
        if (state.me.birthDetails && state.me.birthDetails.pob) {
          if (state.me.birthDetails.dob) document.getElementById('clientChartDate').value = state.me.birthDetails.dob;
          if (state.me.birthDetails.tob) document.getElementById('clientChartTime').value = state.me.birthDetails.tob;
          if (state.me.birthDetails.pob) document.getElementById('clientCitySearch').value = state.me.birthDetails.pob;
          if (state.me.birthDetails.lat) document.getElementById('clientChartLat').value = state.me.birthDetails.lat;
          if (state.me.birthDetails.lon) document.getElementById('clientChartLon').value = state.me.birthDetails.lon;
        } else {
          // Default to Chennai
          document.getElementById('clientCitySearch').value = 'Chennai';
          document.getElementById('clientChartLat').value = '13.0827';
          document.getElementById('clientChartLon').value = '80.2707';
        }
      }
    };

    window.openEditIntakeForm = function () {
      document.getElementById('screen-client-birth-chart').classList.remove('hidden');

      // Pre-fill everything we know
      if (state.me) {
        document.getElementById('clientChartName').value = state.me.name || '';
        document.getElementById('clientChartPhone').value = state.me.phone || '';

        if (state.me.birthDetails) {
          const bd = state.me.birthDetails;
          if (bd.dob) document.getElementById('clientChartDate').value = bd.dob;
          if (bd.tob) document.getElementById('clientChartTime').value = bd.tob;
          if (bd.pob) document.getElementById('clientCitySearch').value = bd.pob;
          if (bd.lat) document.getElementById('clientChartLat').value = bd.lat;
          if (bd.lon) document.getElementById('clientChartLon').value = bd.lon;
        }
        if (state.me.intakeDetails) {
          const id = state.me.intakeDetails;
          if (id.gender) {
            const r = document.querySelector(`input[name="clientGender"][value="${id.gender}"]`);
            if (r) r.checked = true;
          }
          if (id.marital) document.getElementById('clientMarital').value = id.marital;
          if (id.occupation) document.getElementById('clientOccupation').value = id.occupation;
          if (id.topic) document.getElementById('clientTopic').value = id.topic;

          if (id.partner && id.partner.name) {
            document.getElementById('togglePartnerDetails').checked = true;
            document.getElementById('partnerFields').style.display = 'block';
            document.getElementById('partnerName').value = id.partner.name;
            document.getElementById('partnerDob').value = id.partner.dob;
            document.getElementById('partnerTob').value = id.partner.tob;
            document.getElementById('partnerPob').value = id.partner.pob;
          }
        }
      }
    };

    window.sendChatWithBirthChart = function () {
      const date = document.getElementById('clientChartDate').value;
      const time = document.getElementById('clientChartTime').value;
      const city = document.getElementById('clientCitySearch').value;
      const lat = document.getElementById('clientChartLat').value;
      const lon = document.getElementById('clientChartLon').value;
      const tz = document.getElementById('clientChartTz').value;

      if (!date || !time || !lat || !lon) {
        alert('Please fill all required fields');
        return;
      }



      // New Fields
      const name = document.getElementById('clientChartName').value;
      const gender = document.querySelector('input[name="clientGender"]:checked').value;
      const marital = document.getElementById('clientMarital').value;
      const occupation = document.getElementById('clientOccupation').value;
      const topic = document.getElementById('clientTopic').value;

      // Partner
      let partner = null;
      if (document.getElementById('togglePartnerDetails').checked) {
        partner = {
          name: document.getElementById('partnerName').value,
          dob: document.getElementById('partnerDob').value,
          tob: document.getElementById('partnerTob').value,
          pob: document.getElementById('partnerPob').value
        };
      }

      const [y, m, d] = date.split('-');
      const [h, min] = time.split(':');

      const birthData = {
        name, gender, marital, occupation, topic, partner,
        year: parseInt(y),
        month: parseInt(m),
        day: parseInt(d),
        hour: parseInt(h),
        minute: parseInt(min),
        latitude: parseFloat(lat || 0), // Optional if not searching city properly?
        longitude: parseFloat(lon || 0),
        timezone: parseFloat(tz || 5.5),
        city: city
      };

      document.getElementById('screen-client-birth-chart').classList.add('hidden');

      // 1. Save data (Always update DB)
      socket.emit('save-intake-details', birthData);

      // Update Local State
      if (state.me) {
        state.me.name = name;
        state.me.birthDetails = {
          dob: `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`,
          tob: `${String(h).padStart(2, '0')}:${String(min).padStart(2, '0')}`,
          pob: city, lat: parseFloat(lat), lon: parseFloat(lon)
        };
        state.me.intakeDetails = { gender, marital, occupation, topic, partner };
        saveSession(state.me);
      }

      // 2. Decide: New Request OR Update Existing?
      // If we are definitely in a session (screen visible + session obj exists)
      const isInSession = state.session && !document.getElementById('screen-session').classList.contains('hidden');

      if (isInSession) {
        // Just notify user (and maybe partner via chat system msg later)
        alert("Details Updated Successfully!");
        // Optionally emit a chat message saying "I updated my details"
      } else {
        // Not in session -> Start New Request
        // Ensure we have a target astro
        if (!window.selectedAstroId) {
          // Fallback: If no astro selected, just save and exit
          alert("Details Saved!");
          return;
        }

        socket.emit('request-session', {
          toUserId: window.selectedAstroId,
          type: 'chat',
          birthData: birthData
        }, (res) => {
          if (res.ok) {
            initSession(res.sessionId, window.selectedAstroId, 'chat', true, null);
          } else {
            alert('Request failed: ' + res.error);
          }
        });
      }
    };

    socket.on('client-birth-chart', (data) => {
      if (state.me && state.me.role === 'astrologer') {
        window.receivedBirthData = data.birthData;
        const bd = data.birthData;

        // --- LIVE UI UPDATE ---
        const contentDiv = document.getElementById('clientDetailsContent');
        const headerDiv = document.getElementById('clientDetailsHeader');
        if (contentDiv && headerDiv) {
          let pTextShort = bd.partner && bd.partner.name ? ` | ‚ù§Ô∏è ${bd.partner.name}` : '';
          contentDiv.innerHTML = `
              <div>üë§ <b>${bd.name}</b> (${bd.gender}) | üó£ ${bd.topic}</div>
              <div>üìÖ DOB: ${bd.day}/${bd.month}/${bd.year} (${bd.hour}:${String(bd.minute).padStart(2, '0')})</div>
              <div>üìç ${bd.city} | üíç ${bd.marital}${pTextShort}</div>
            `;
          headerDiv.style.display = 'block';
        }

        let pText = "";
        if (bd.partner && bd.partner.name) pText = `\n‚ù§Ô∏è Partner: ${bd.partner.name} (${bd.partner.dob})`;

        alert(`üìä DETAILS UPDATED:\n\nüë§ ${bd.name} (${bd.gender})\nüè† ${bd.city}\nüíç ${bd.marital}\nüó£ Topic: ${bd.topic}${pText}`);
      }
    });

    // Chart Logic
    function showChartHelper() {
      const panel = document.getElementById('inlineChartPanel');
      const universalModal = document.getElementById('universalChartModal');
      const messagesList = document.getElementById('messagesList');
      const isInSession = state.session && !document.getElementById('screen-session').classList.contains('hidden');

      // If panel doesn't exist, create it or return
      if (!panel) {
        console.warn('inlineChartPanel not found');
        return;
      }

      if (isInSession) {
        // We are in a chat session -> Move panel to chat, hide modal
        if (panel.parentElement !== messagesList) {
          // Find the correct insertion point (before dasha or at end?)
          // actually, index.html structure had it before the style block.
          // Appending to messagesList is safe as it's a flex col.
          // But wait, messagesList content is cleared in initSession.
          // The structure in index.html has it after clientRequestDetails.
          // We can just append it for now, or insert before the end.
          messagesList.appendChild(panel);
        }
        if (universalModal) universalModal.classList.add('hidden');
        panel.style.display = 'block';

        // Add responsive class to input
        const msgInput = document.getElementById('msgInput');
        if (msgInput) msgInput.classList.add('msg-input-reduced');

      } else {
        // We are in dashboard (or elsewhere) -> Move panel to modal, show modal
        if (universalModal) {
          if (panel.parentElement !== universalModal) {
            universalModal.appendChild(panel);
          }
          universalModal.classList.remove('hidden');
        }
        panel.style.display = 'block'; // Make sure the panel itself is visible inside modal
        // Ensure no chat-specific styles interfere (like margin-bottom 80px)
        // We might need to reset styles or use specific classes.
        // For now, the modal centers content, so panel should look okay.
      }

      document.getElementById('chartInputSection').style.display = 'block';
      document.getElementById('chartResults').style.display = 'none';
      document.getElementById('chartLoading').style.display = 'none';

      if (window.receivedBirthData) {
        const bd = window.receivedBirthData;
        document.getElementById('chartDate').value = `${bd.year}-${String(bd.month).padStart(2, '0')}-${String(bd.day).padStart(2, '0')}`;
        document.getElementById('chartTime').value = `${String(bd.hour).padStart(2, '0')}:${String(bd.minute).padStart(2, '0')}`;
        document.getElementById('chartLat').value = bd.latitude;
        document.getElementById('chartLon').value = bd.longitude;
        document.getElementById('chartTz').value = bd.timezone || '5.5';
        document.getElementById('citySearch').value = bd.city || '';
      } else {
        const now = new Date();
        document.getElementById('chartDate').value = now.toISOString().split('T')[0];
        document.getElementById('chartTime').value = now.toTimeString().slice(0, 5);
        document.getElementById('chartTz').value = '5.5';

        if (state.session && state.session.type === 'chat') {
          // kept previous dev default
          document.getElementById('chartDate').value = '1990-05-15';
          document.getElementById('chartTime').value = '14:30';
          document.getElementById('chartLat').value = '13.0827';
          document.getElementById('chartLon').value = '80.2707';
          document.getElementById('chartTz').value = '5.5';
          document.getElementById('citySearch').value = 'Chennai, Tamil Nadu';
        }
      }
    }

    window.closeInlineChart = function () {
      const panel = document.getElementById('inlineChartPanel');
      if (panel) panel.style.display = 'none';

      const universalModal = document.getElementById('universalChartModal');
      if (universalModal) universalModal.classList.add('hidden');

      const msgInput = document.getElementById('msgInput');
      if (msgInput) msgInput.classList.remove('msg-input-reduced');
    };

    window.showBirthChartColumn = function () {
      const column = document.getElementById('birthChartColumn');
      column.style.display = 'flex';
      showChartHelper();
    };

    window.closeBirthChartColumn = function () {
      document.getElementById('birthChartColumn').style.display = 'none';
    };

    // Fetch chart from dashboard form
    async function fetchDashboardChart() {
      const dateStr = document.getElementById('dashboardChartDate')?.value;
      const timeStr = document.getElementById('dashboardChartTime')?.value;
      const lat = document.getElementById('dashboardChartLat')?.value;
      const lon = document.getElementById('dashboardChartLon')?.value;
      const tz = document.getElementById('dashboardChartTz')?.value;

      if (!dateStr || !timeStr || !lat || !lon) {
        return alert("Please fill all required fields");
      }

      const [year, month, day] = dateStr.split('-');
      const [hour, minute] = timeStr.split(':');

      const bd = {
        year: parseInt(year),
        month: parseInt(month),
        day: parseInt(day),
        hour: parseInt(hour),
        minute: parseInt(minute),
        latitude: parseFloat(lat),
        longitude: parseFloat(lon),
        timezone: parseFloat(tz) || 5.5
      };

      try {
        // Show loading state
        const panel = document.getElementById('dashboardChartPanel');
        const originalContent = panel.innerHTML;
        panel.innerHTML = '<div style="text-align:center; padding:60px 20px;"><div class="spinner-astro"></div><div style="margin-top:20px; font-weight:500; color:#d97706; font-size:1.1rem;">Analyzing Planets...</div></div>';

        const res = await fetch('https://newapi-production-ea98.up.railway.app/api/charts/birth-chart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(bd)
        }).then(r => r.json());

        if (res.error) throw new Error(res.error);

        // Display results
        displayDashboardChartResults(res);
      } catch (e) {
        alert("Error: " + e.message);
        console.error('Chart API Error:', e);
      }
    }

    // Display chart results in dashboard modal
    function displayDashboardChartResults(data) {
      const panel = document.getElementById('dashboardChartPanel');
      const rawPlanets = data.data?.rawPlanets || {};
      const panchangam = data.data?.panchangam || {};
      const dasha = data.data?.dasha || {};
      const lagna = data.data?.lagna || {};

      let html = `
        <div style="padding:20px; background:white; font-weight:700; font-size:1.2rem; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #e5e5e5; color:#1F2937;">
          <span>üîÆ Birth Chart Results</span>
          <button onclick="document.getElementById('universalChartModal').classList.add('hidden')" style="background:none; border:none; font-size:1.4rem; color:#6B7280; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <div style="flex:1; overflow-y:auto; padding:20px;">
          <!-- Lagna Section -->
          <div style="background:linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color:white; padding:20px; border-radius:12px; margin-bottom:20px;">
            <div style="font-size:0.9rem; opacity:0.9; margin-bottom:5px;">üåü Lagna (Ascendant)</div>
            <div style="font-size:1.8rem; font-weight:bold;">${lagna.tamil || lagna.name || 'N/A'}</div>
            <div style="font-size:0.9rem; margin-top:8px;">Lord: ${lagna.lordTamil || lagna.lord || 'N/A'}</div>
          </div>

          <!-- Planets Section -->
          <div style="margin-bottom:20px;">
            <div style="font-weight:bold; color:#d97706; margin-bottom:12px; font-size:1.1rem;">üåü Planets</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
      `;

      // Add planets
      const planetOrder = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn', 'Rahu', 'Ketu'];
      const planetColors = {
        'Sun': '#ef4444', 'Moon': '#3b82f6', 'Mars': '#b91c1c', 'Mercury': '#10b981',
        'Jupiter': '#f59e0b', 'Venus': '#ec4899', 'Saturn': '#374151', 'Rahu': '#1f2937', 'Ketu': '#4b5563'
      };

      planetOrder.forEach(planet => {
        const p = rawPlanets[planet];
        if (p) {
          const color = planetColors[planet] || '#6b7280';
          html += `
            <div style="background:white; border-left:4px solid ${color}; padding:12px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
              <div style="font-weight:bold; color:${color}; margin-bottom:4px;">${p.nameTamil || planet}</div>
              <div style="font-size:0.85rem; color:#555;">
                <div>${p.signTamil || p.sign}</div>
                <div style="color:#999; font-size:0.8rem;">${p.degreeFormatted || p.degree}</div>
              </div>
            </div>
          `;
        }
      });

      html += `
            </div>
          </div>

          <!-- Panchangam Section -->
          <div style="margin-bottom:20px;">
            <div style="font-weight:bold; color:#d97706; margin-bottom:12px; font-size:1.1rem;">üìÖ Panchangam</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
              <div style="background:#ecfdf5; padding:12px; border-radius:8px; border-left:4px solid #10b981;">
                <div style="font-size:0.8rem; color:#666; margin-bottom:4px;">Tithi</div>
                <div style="font-weight:bold; color:#047857;">${panchangam.tithi || 'N/A'}</div>
              </div>
              <div style="background:#eff6ff; padding:12px; border-radius:8px; border-left:4px solid #3b82f6;">
                <div style="font-size:0.8rem; color:#666; margin-bottom:4px;">Nakshatra</div>
                <div style="font-weight:bold; color:#1e40af;">${panchangam.nakshatra || 'N/A'}</div>
              </div>
              <div style="background:#fff7ed; padding:12px; border-radius:8px; border-left:4px solid #f59e0b;">
                <div style="font-size:0.8rem; color:#666; margin-bottom:4px;">Yoga</div>
                <div style="font-weight:bold; color:#b45309;">${panchangam.yoga || 'N/A'}</div>
              </div>
              <div style="background:#faf5ff; padding:12px; border-radius:8px; border-left:4px solid #a855f7;">
                <div style="font-size:0.8rem; color:#666; margin-bottom:4px;">Karana</div>
                <div style="font-weight:bold; color:#6b21a8;">${panchangam.karana || 'N/A'}</div>
              </div>
            </div>
          </div>

          <!-- Dasha Section -->
          <div style="margin-bottom:20px;">
            <div style="font-weight:bold; color:#d97706; margin-bottom:12px; font-size:1.1rem;">‚è≥ Current Dasha</div>
            <div style="background:linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color:white; padding:15px; border-radius:8px;">
              <div style="font-size:0.9rem; opacity:0.9; margin-bottom:5px;">Mahadasha</div>
              <div style="font-size:1.3rem; font-weight:bold; margin-bottom:10px;">${dasha.currentLord || 'N/A'}</div>
              <div style="font-size:0.85rem; opacity:0.9;">
                <div>Remaining: ${dasha.remainingYearsInCurrentDasha ? parseFloat(dasha.remainingYearsInCurrentDasha).toFixed(2) : 'N/A'} years</div>
                <div>Elapsed: ${dasha.yearsElapsedInCurrentDasha ? parseFloat(dasha.yearsElapsedInCurrentDasha).toFixed(2) : 'N/A'} years</div>
              </div>
            </div>
          </div>

          <!-- Moon Sign Section -->
          <div style="background:#fdf2f8; padding:15px; border-radius:8px; border-left:4px solid #ec4899; margin-bottom:20px;">
            <div style="font-size:0.9rem; color:#666; margin-bottom:5px;">üåô Moon Sign</div>
            <div style="font-size:1.2rem; font-weight:bold; color:#be185d;">${data.data?.moonSign?.tamil || data.data?.moonSign?.name || 'N/A'}</div>
          </div>
        </div>
      `;

      panel.innerHTML = html;
    }

    window.showChartHelperWithData = function () {
      showBirthChartColumn();
    };

    function switchChartTab(tab) {
      document.querySelectorAll('.chart-tab-content').forEach(d => d.classList.add('hidden'));
      document.querySelectorAll('.c-tab').forEach(b => b.classList.remove('active'));

      const contentTab = document.getElementById('content-' + tab);
      const tabBtn = document.getElementById('tab-' + tab);
      if (contentTab) contentTab.classList.remove('hidden');
      if (tabBtn) tabBtn.classList.add('active');
    }

    function resetChart() {
      document.getElementById('chartInputSection').style.display = 'block';
      document.getElementById('chartResults').style.display = 'none';
      document.getElementById('chartLoading').style.display = 'none';
    }

    async function fetchChart() {
      // Try to use received birth data first, otherwise use form inputs
      let bd = window.receivedBirthData;
      console.log('fetchChart called. Received birth data:', bd);

      if (!bd) {
        // Get data from form inputs
        const dateStr = document.getElementById('chartDate')?.value;
        const timeStr = document.getElementById('chartTime')?.value;
        const lat = document.getElementById('chartLat')?.value;
        const lon = document.getElementById('chartLon')?.value;
        const tz = document.getElementById('chartTz')?.value;

        console.log('Using form inputs:', { dateStr, timeStr, lat, lon, tz });

        if (!dateStr || !timeStr || !lat || !lon) {
          return alert("Please fill all required fields (Date, Time, Latitude, Longitude)");
        }

        const [year, month, day] = dateStr.split('-');
        const [hour, minute] = timeStr.split(':');

        bd = {
          year: parseInt(year),
          month: parseInt(month),
          day: parseInt(day),
          hour: parseInt(hour),
          minute: parseInt(minute),
          latitude: parseFloat(lat),
          longitude: parseFloat(lon),
          timezone: parseFloat(tz) || 5.5,
          city: document.getElementById('citySearch')?.value || ''
        };
        console.log('Birth data from form:', bd);
      }

      const birthChartColumn = document.getElementById('birthChartColumn');
      if (birthChartColumn && birthChartColumn.style.display === 'flex') {
        document.getElementById('birthChartContent').innerHTML = '<div style="text-align:center; padding:40px;"><div class="spinner-astro"></div><div style="margin-top:15px; font-weight:500; color:#d97706;">Analyzing Planets...</div></div>';
      }

      try {
        const res = await fetch('https://newapi-production-ea98.up.railway.app/api/charts/birth-chart', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            year: bd.year,
            month: bd.month,
            day: bd.day,
            hour: bd.hour,
            minute: bd.minute,
            latitude: bd.latitude,
            longitude: bd.longitude,
            timezone: bd.timezone
          })
        }).then(r => r.json());

        if (res.error) throw new Error(res.error);

        setTimeout(() => {
          renderChartResults(res);
          document.getElementById('chartLoading').style.display = 'none';
          document.getElementById('chartResults').style.display = 'flex';

          if (birthChartColumn && birthChartColumn.style.display === 'flex') {
            displayChartInColumn2(res);
          }
        }, 800);

      } catch (e) {
        alert("Error: " + e.message);
        console.error('Chart API Error:', e);
        document.getElementById('chartLoading').style.display = 'none';
        document.getElementById('chartInputSection').style.display = 'block';

        if (birthChartColumn && birthChartColumn.style.display === 'flex') {
          document.getElementById('birthChartContent').innerHTML = '<div style="color:#f00; padding:20px;">Error: ' + e.message + '</div>';
        }
      }
    }

    function displayChartInColumn2(data) {
      const rawPlanets = data.data?.rawPlanets || data.rawPlanets || {};
      const panchangam = data.data?.panchangam || data.panchangam || {};
      const dasha = data.data?.dasha || data.dasha || {};
      const lagna = data.data?.lagna || data.lagna || {};

      const planetColors = {
        'Sun': '#ef4444', 'Moon': '#3b82f6', 'Mars': '#b91c1c', 'Mercury': '#10b981',
        'Jupiter': '#f59e0b', 'Venus': '#ec4899', 'Saturn': '#374151', 'Rahu': '#1f2937', 'Ketu': '#4b5563'
      };

      let html = '<div style="padding:15px;">';

      // Lagna
      if (lagna && lagna.tamil) {
        html += `
          <div style="background:linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color:white; padding:15px; border-radius:12px; margin-bottom:15px;">
            <div style="font-size:0.85rem; opacity:0.9;">üåü Lagna</div>
            <div style="font-size:1.3rem; font-weight:bold;">${lagna.tamil}</div>
          </div>
        `;
      }

      // South Indian Chart (Rasi)
      html += `
        <div style="margin-bottom:20px;">
          <div style="font-weight:bold; color:#d97706; margin-bottom:10px; font-size:1rem;">üïâÔ∏è Rasi Chart</div>
           <div class="south-indian-chart" id="southChartColumn2"></div>
        </div>
      `;

      // South Indian Chart (Navamsa)
      html += `
        <div style="margin-bottom:20px;">
          <div style="font-weight:bold; color:#d97706; margin-bottom:10px; font-size:1rem;">üïâÔ∏è Navamsa Chart</div>
           <div class="south-indian-chart" id="navamsaChartColumn2"></div>
        </div>
      `;

      // Render Charts
      setTimeout(() => {

        const planetSymbols = {
          'Sun': '‚òâ', 'Moon': '‚òΩ', 'Mars': '‚ôÇ', 'Mercury': '‚òø',
          'Jupiter': '‚ôÉ', 'Venus': '‚ôÄ', 'Saturn': '‚ôÑ', 'Rahu': '‚òä', 'Ketu': '‚òã'
        };

        const renderSouthGrid = (gridId, chartType) => {
          const grid = document.getElementById(gridId);
          if (!grid) return;

          const isRasi = chartType === 'rasi';

          const tamilSigns = {
            'Aries': '‡ÆÆ‡Øá‡Æ∑‡ÆÆ‡Øç', 'Taurus': '‡Æ∞‡Æø‡Æ∑‡Æ™‡ÆÆ‡Øç', 'Gemini': '‡ÆÆ‡Æø‡Æ§‡ØÅ‡Æ©‡ÆÆ‡Øç',
            'Cancer': '‡Æï‡Æü‡Æï‡ÆÆ‡Øç', 'Leo': '‡Æö‡Æø‡ÆÆ‡Øç‡ÆÆ‡ÆÆ‡Øç', 'Virgo': '‡Æï‡Æ©‡Øç‡Æ©‡Æø',
            'Libra': '‡Æ§‡ØÅ‡Æ≤‡Ææ‡ÆÆ‡Øç', 'Scorpio': '‡Æµ‡Æø‡Æ∞‡ØÅ‡Æö‡Øç‡Æö‡Æø‡Æï‡ÆÆ‡Øç', 'Sagittarius': '‡Æ§‡Æ©‡ØÅ‡Æö‡ØÅ',
            'Capricorn': '‡ÆÆ‡Æï‡Æ∞‡ÆÆ‡Øç', 'Aquarius': '‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç', 'Pisces': '‡ÆÆ‡ØÄ‡Æ©‡ÆÆ‡Øç'
          };

          const cellMap = [
            'Pisces', 'Aries', 'Taurus', 'Gemini',
            'Aquarius', null, null, 'Cancer',
            'Capricorn', null, null, 'Leo',
            'Sagittarius', 'Scorpio', 'Libra', 'Virgo'
          ];

          grid.innerHTML = '';

          cellMap.forEach((sign, idx) => {
            const div = document.createElement('div');
            div.className = 'SouthChartBox';

            if (!sign) {
              div.setAttribute('data-center', 'true');
              div.style.cssText = 'border: none; background: transparent;';
              if (idx === 5) {
                div.style.cssText = 'grid-column: 2 / span 2; grid-row: 2 / span 2; display: flex; align-items: center; justify-content: center;';
                div.innerHTML = '<img src="images/ganesha.png" class="center-god-icon" alt="Ganesha">';
              } else if (idx === 6 || idx === 9 || idx === 10) {
                div.style.display = 'none';
              }
            } else {
              const tamilName = tamilSigns[sign] || sign;
              const planetsInSign = [];

              // Logic for Rasi vs Navamsa Planet Mapping
              if (isRasi) {
                for (let planet in rawPlanets) {
                  const p = rawPlanets[planet];
                  if (p && p.sign === sign) {
                    // Format: Symbol Name Degree (DMS)
                    const symbol = planetSymbols[planet] || '';
                    const name = p.nameTamil || planet;

                    const toDMS = (d) => {
                      if (!d && d !== 0) return '';
                      const deg = Math.floor(d);
                      const minFloat = (d - deg) * 60;
                      const min = Math.floor(minFloat);
                      const sec = Math.round((minFloat - min) * 60);
                      return `${deg}¬∞ ${min}' ${sec}"`;
                    };

                    const deg = p.degreeFormatted || (p.degree !== undefined ? toDMS(p.degree) : '');
                    planetsInSign.push(`<div style="font-size:0.75rem; line-height:1.2;">${symbol} <b>${name}</b><br><span style="font-size:0.65rem; color:#555;">${deg}</span></div>`);
                  }
                }
                // Check Lagna (Rasi only)
                if (lagna && (lagna.sign === sign || lagna.signName === sign)) {
                  planetsInSign.unshift('<div style="font-weight:bold; color:red; font-size:0.8rem;">Lagna</div>');
                }
              } else {
                // Navamsa Logic
                // We need to know which sign each planet is in Navamsa.
                // If rawPlanets has 'navamsaSign', use it.
                // Or if data.navamsa exists and is a list of houses/planets.
                // Checking previous code: data.navamsa.houses array...
                // Let's try to iterate rawPlanets if they have navamsa data, or fallback to houses.

                // Using rawPlanets (if navamsaSign is there - common in some APIs, let's check or fallback)
                let found = false;
                for (let planet in rawPlanets) {
                  const p = rawPlanets[planet];
                  if (p && (p.navamsaSign === sign || p.navamsaSignName === sign)) { // Hypothetical check
                    found = true;
                    const symbol = planetSymbols[planet] || '';
                    planetsInSign.push(`<div>${symbol} ${p.nameTamil || planet}</div>`); // Simplified
                  }
                }

                if (!found && data.data?.navamsa?.planets) {
                  // Check houses for this sign?
                  // Usually houses data is per house (1 to 12).
                  // We need Sign-based mapping.
                  // Let's look for a planet-to-sign map in Navamsa data if available.
                  // If not available, we might skip showing planets in Navamsa for now or require API update.
                  // BUT, user asked for it, implying it should be possible.
                  // Let's verify if `navamsa` object has planets map.
                  const np = data.data.navamsa.planets;
                  for (let k in np) {
                    if (np[k] === sign) {
                      const symbol = planetSymbols[k] || '';
                      planetsInSign.push(`<div>${symbol} ${k}</div>`); // Simplified
                    }
                  }
                }
              }

              div.innerHTML = `<span class="s-sign-label" title="${tamilName}" style="font-size:0.7rem; color:#d97706; font-weight:bold;">${tamilName.split(' ')[0]}</span>
                    <div class="s-planet-text" style="display:flex; flex-direction:column; gap:2px; padding-top:12px;">${planetsInSign.join('')}</div>`;
            }
            if (div.style.display !== 'none') grid.appendChild(div);
          });
        };

        renderSouthGrid('southChartColumn2', 'rasi');
        renderSouthGrid('navamsaChartColumn2', 'navamsa');

      }, 100);

      // Planets
      if (Object.keys(rawPlanets).length > 0) {
        html += '<div style="margin-bottom:15px;"><div style="font-weight:bold; color:#d97706; margin-bottom:10px; font-size:1rem;">üåü Planets</div>';
        html += '<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">';

        const planetOrder = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn', 'Rahu', 'Ketu'];
        planetOrder.forEach(planet => {
          const p = rawPlanets[planet];
          if (p) {
            const color = planetColors[planet] || '#6b7280';
            html += `
              <div style="background:white; border-left:4px solid ${color}; padding:10px; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                <div style="font-weight:bold; color:${color}; font-size:0.85rem; margin-bottom:3px;">${p.nameTamil || planet}</div>
                <div style="font-size:0.75rem; color:#555;">${p.signTamil || p.sign}</div>
                <div style="font-size:0.7rem; color:#999;">${p.degreeFormatted || p.degree}</div>
              </div>
            `;
          }
        });
        html += '</div></div>';
      }

      // Panchangam
      if (panchangam && panchangam.tithi) {
        html += `
          <div style="margin-bottom:15px;">
            <div style="font-weight:bold; color:#d97706; margin-bottom:10px; font-size:1rem;">üìÖ Panchangam</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
              <div style="background:#ecfdf5; padding:10px; border-radius:6px; border-left:4px solid #10b981;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:3px;">Tithi</div>
                <div style="font-weight:bold; color:#047857; font-size:0.85rem;">${panchangam.tithi}</div>
              </div>
              <div style="background:#eff6ff; padding:10px; border-radius:6px; border-left:4px solid #3b82f6;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:3px;">Nakshatra</div>
                <div style="font-weight:bold; color:#1e40af; font-size:0.85rem;">${panchangam.nakshatra}</div>
              </div>
              <div style="background:#fff7ed; padding:10px; border-radius:6px; border-left:4px solid #f59e0b;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:3px;">Yoga</div>
                <div style="font-weight:bold; color:#b45309; font-size:0.85rem;">${panchangam.yoga}</div>
              </div>
              <div style="background:#faf5ff; padding:10px; border-radius:6px; border-left:4px solid #a855f7;">
                <div style="font-size:0.75rem; color:#666; margin-bottom:3px;">Karana</div>
                <div style="font-weight:bold; color:#6b21a8; font-size:0.85rem;">${panchangam.karana}</div>
              </div>
            </div>
          </div>
        `;
      }

      // Dasha
      if (dasha && dasha.currentLord) {
        const remainingYears = dasha.remainingYearsInCurrentDasha ? parseFloat(dasha.remainingYearsInCurrentDasha).toFixed(2) : 'N/A';
        html += `
          <div style="background:linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color:white; padding:12px; border-radius:8px;">
            <div style="font-size:0.85rem; opacity:0.9; margin-bottom:5px;">‚è≥ Current Dasha</div>
            <div style="font-size:1.1rem; font-weight:bold; margin-bottom:8px;">${dasha.currentLord}</div>
            <div style="font-size:0.8rem; opacity:0.9;">
              <div>Remaining: ${remainingYears} years</div>
            </div>
          </div>
        `;
      }

      html += '</div>';
      document.getElementById('birthChartContent').innerHTML = html;
    }

    window.shareChartInChat = function (chartData) {
      if (!state.session) {
        alert('No active chat session');
        return;
      }

      const summary = `üîÆ Birth Chart Analysis\nüìÖ ${document.getElementById('chartDate').value} \n‚è∞ ${document.getElementById('chartTime').value} \nüìç ${document.getElementById('citySearch')?.value || ''}`;

      socket.emit('chat-message', {
        toUserId: state.session.partnerId,
        sessionId: state.session.id,
        content: { type: 'text', text: summary },
        messageId: Date.now()
      });

      appendMsg(summary, true);
      alert('Chart details shared in chat!');
    };

    function renderChartResults(data) {
      // Handle new API response format
      const rawPlanets = data.data?.rawPlanets || data.rawPlanets || {};

      const pList = document.getElementById('planetList');
      if (pList) {
        pList.innerHTML = '';

        // Use rawPlanets from new API format
        const planetOrder = ['Sun', 'Moon', 'Mars', 'Mercury', 'Jupiter', 'Venus', 'Saturn', 'Rahu', 'Ketu'];

        planetOrder.forEach(planet => {
          const info = rawPlanets[planet];
          if (info) {
            const div = document.createElement('div');
            div.className = 'planet-item';
            div.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center">
                <b>${info.nameTamil || planet}</b>
                <span style="background:#e5e7eb; padding:2px 8px; border-radius:10px; font-size:0.75rem;">${info.signTamil || info.sign}</span>
              </div>
              <div style="margin-top:5px; font-size:0.85rem; color:#555;">
                ${info.degreeFormatted || info.degree} | ${info.nakshatraTamil || info.nakshatra}
              </div>
            `;
            pList.appendChild(div);
          }
        });
      }

      function renderSouthGrid(containerId, chartType) {
        // Render Rasi or Navamsa chart from new API format
        const grid = document.getElementById(containerId);
        if (!grid) return;

        const houses = chartType === 'rasi' ? (data.data?.houses || data.houses || {}) : (data.data?.navamsa?.houses || data.navamsa?.houses || []);
        const rawPlanets = data.data?.rawPlanets || data.rawPlanets || {};

        grid.innerHTML = '';

        const tamilSigns = {
          'Aries': '‡ÆÆ‡Øá‡Æ∑‡ÆÆ‡Øç', 'Taurus': '‡Æ∞‡Æø‡Æ∑‡Æ™‡ÆÆ‡Øç', 'Gemini': '‡ÆÆ‡Æø‡Æ§‡ØÅ‡Æ©‡ÆÆ‡Øç',
          'Cancer': '‡Æï‡Æü‡Æï‡ÆÆ‡Øç', 'Leo': '‡Æö‡Æø‡ÆÆ‡Øç‡ÆÆ‡ÆÆ‡Øç', 'Virgo': '‡Æï‡Æ©‡Øç‡Æ©‡Æø',
          'Libra': '‡Æ§‡ØÅ‡Æ≤‡Ææ‡ÆÆ‡Øç', 'Scorpio': '‡Æµ‡Æø‡Æ∞‡ØÅ‡Æö‡Øç‡Æö‡Æø‡Æï‡ÆÆ‡Øç', 'Sagittarius': '‡Æ§‡Æ©‡ØÅ‡Æö‡ØÅ',
          'Capricorn': '‡ÆÆ‡Æï‡Æ∞‡ÆÆ‡Øç', 'Aquarius': '‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç', 'Pisces': '‡ÆÆ‡ØÄ‡Æ©‡ÆÆ‡Øç'
        };

        const cellMap = [
          'Pisces', 'Aries', 'Taurus', 'Gemini',
          'Aquarius', null, null, 'Cancer',
          'Capricorn', null, null, 'Leo',
          'Sagittarius', 'Scorpio', 'Libra', 'Virgo'
        ];

        cellMap.forEach((sign, idx) => {
          const div = document.createElement('div');
          div.className = 'SouthChartBox';

          if (!sign) {
            div.setAttribute('data-center', 'true');
            div.style.cssText = 'border: none; background: transparent;';
            if (idx === 5) {
              div.style.cssText = 'grid-column: 2 / span 2; grid-row: 2 / span 2; display: flex; align-items: center; justify-content: center;';
              div.innerHTML = '<div style="color: #d97706; font-size: 2rem;">üïâÔ∏è</div>';
            } else if (idx === 6 || idx === 9 || idx === 10) {
              div.style.display = 'none';
            }
          } else {
            const tamilName = tamilSigns[sign] || sign;
            // Get planets in this sign from rawPlanets
            const planetsInSign = [];
            for (let planet in rawPlanets) {
              const p = rawPlanets[planet];
              if (p && p.sign === sign) {
                planetsInSign.push(p.nameTamil?.substring(0, 2) || planet.substring(0, 2));
              }
            }

            div.innerHTML = `<span class="s-sign-label" title="${tamilName}" style="font-size:0.7rem; color:#d97706; font-weight:bold;">${tamilName.split(' ')[0]}</span>
              <div class="s-planet-text" style="font-size:0.85rem; line-height:1.4;">${planetsInSign.join('<br>') || ''}</div>`;
          }
          if (div.style.display !== 'none') grid.appendChild(div);
        });
      }

      renderSouthGrid('southChart', 'rasi');
      renderSouthGrid('navamsaChart', 'navamsa');

      const shareBtn = document.getElementById('btnShareChart');
      if (shareBtn) {
        shareBtn.style.display = state.session && state.session.type === 'chat' ? 'block' : 'none';
      }

      try {
        $('.s-sign-label').tooltip({
          position: { my: "center bottom-10", at: "center top" },
          show: { effect: "fade", duration: 200 },
          hide: { effect: "fade", duration: 100 }
        });
      } catch (e) { console.warn("jQuery Tooltip failed", e); }
    }


    // Porutham Logic
    window.porutham = function () {
      document.getElementById('screen-porutham').classList.remove('hidden');
      document.getElementById('poruthamResults').style.display = 'none';
      document.getElementById('poruthamResults').innerHTML = '';

      // --- Auto Fill Logic ---
      let client = null;
      let partner = null;
      let gender = 'Male'; // Default

      // Scenario 1: Astrologer Viewing Client Data
      if (window.receivedBirthData) {
        const bd = window.receivedBirthData;
        gender = bd.gender || 'Male';

        client = {
          date: `${bd.year}-${String(bd.month).padStart(2, '0')}-${String(bd.day).padStart(2, '0')}`,
          time: `${String(bd.hour).padStart(2, '0')}:${String(bd.minute).padStart(2, '0')}`,
          city: bd.city, lat: bd.latitude, lon: bd.longitude
        };

        if (bd.partner && bd.partner.name) {
          partner = {
            date: bd.partner.dob,
            time: bd.partner.tob,
            city: bd.partner.pob,
            lat: 0, lon: 0 // We might not have lat/lon for partner yet
          };
        }
      }
      // Scenario 2: Client Viewing their own data
      else if (state.me && state.me.intakeDetails && state.me.birthDetails) {
        gender = state.me.intakeDetails.gender || 'Male';
        const bd = state.me.birthDetails;
        const id = state.me.intakeDetails;

        client = {
          date: bd.dob,
          time: bd.tob,
          city: bd.pob, lat: bd.lat, lon: bd.lon
        };
        if (id.partner && id.partner.name) {
          partner = {
            date: id.partner.dob,
            time: id.partner.tob,
            city: id.partner.pob,
            lat: 0, lon: 0
          };
        }
      }

      // Assign to Boy/Girl
      if (client) {
        if (gender === 'Male') {
          // Client is Boy
          if (client.date) document.getElementById('boyDate').value = client.date;
          if (client.time) document.getElementById('boyTime').value = client.time;
          if (client.city) document.getElementById('boyCity').value = client.city;
          if (client.lat) document.getElementById('boyLat').value = client.lat;
          if (client.lon) document.getElementById('boyLon').value = client.lon;

          if (partner) {
            if (partner.date) document.getElementById('girlDate').value = partner.date;
            if (partner.time) document.getElementById('girlTime').value = partner.time;
            if (partner.city) document.getElementById('girlCity').value = partner.city;
            // Partner lat/lon would need search, assumed manual for now
          }
        } else {
          // Client is Girl
          if (client.date) document.getElementById('girlDate').value = client.date;
          if (client.time) document.getElementById('girlTime').value = client.time;
          if (client.city) document.getElementById('girlCity').value = client.city;
          if (client.lat) document.getElementById('girlLat').value = client.lat;
          if (client.lon) document.getElementById('girlLon').value = client.lon;

          if (partner) {
            if (partner.date) document.getElementById('boyDate').value = partner.date;
            if (partner.time) document.getElementById('boyTime').value = partner.time;
            if (partner.city) document.getElementById('boyCity').value = partner.city;
          }
        }
      } else {
        // Defaults if no data
        document.getElementById('boyDate').value = '1995-05-15';
        document.getElementById('girlDate').value = '1998-08-20';
        document.getElementById('boyTime').value = '10:00';
        document.getElementById('girlTime').value = '10:00';
      }
    };

    let matchCityTimeout;
    window.handleMatchCitySearch = function (input, type) {
      clearTimeout(matchCityTimeout);
      const resultsDiv = document.getElementById(type + 'CityResults');
      const query = input.value.trim();

      if (query.length < 3) {
        resultsDiv.style.display = 'none';
        return;
      }

      matchCityTimeout = setTimeout(async () => {
        try {
          const response = await fetch('/api/city-autocomplete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query })
          });
          const data = await response.json();

          if (data.ok && data.results && data.results.length > 0) {
            let html = '';
            data.results.forEach(city => {
              html += `
                  <div onclick="selectMatchCity('${type}', '${city.name}', ${city.latitude}, ${city.longitude})"
                       style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;">
                    <div style="font-weight:bold;">${city.name}</div>
                    <div style="font-size:0.8rem; color:#666;">${city.state}</div>
                  </div>
                `;
            });
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
          } else {
            resultsDiv.style.display = 'none';
          }
        } catch (e) { console.error(e); }
      }, 300);
    };

    window.selectMatchCity = function (type, name, lat, lon) {
      document.getElementById(type + 'City').value = name;
      document.getElementById(type + 'Lat').value = lat;
      document.getElementById(type + 'Lon').value = lon;
      document.getElementById(type + 'CityResults').style.display = 'none';
    };

    window.calculatePorutham = async function () {
      const bDate = document.getElementById('boyDate').value;
      const bTime = document.getElementById('boyTime').value;
      const bLat = document.getElementById('boyLat').value || 13.0827; // Default Chennai
      const bLon = document.getElementById('boyLon').value || 80.2707;

      const gDate = document.getElementById('girlDate').value;
      const gTime = document.getElementById('girlTime').value;
      const gLat = document.getElementById('girlLat').value || 13.0827;
      const gLon = document.getElementById('girlLon').value || 80.2707;

      if (!bDate || !bTime || !gDate || !gTime) {
        alert('Please fill all date and time fields');
        return;
      }

      const [by, bm, bd] = bDate.split('-');
      const [bh, bmin] = bTime.split(':');
      const [gy, gm, gd] = gDate.split('-');
      const [gh, gmin] = gTime.split(':');

      const payload = {
        boy: { year: parseInt(by), month: parseInt(bm), day: parseInt(bd), hour: parseInt(bh), minute: parseInt(bmin), lat: parseFloat(bLat), lon: parseFloat(bLon) },
        girl: { year: parseInt(gy), month: parseInt(gm), day: parseInt(gd), hour: parseInt(gh), minute: parseInt(gmin), lat: parseFloat(gLat), lon: parseFloat(gLon) }
      };

      document.getElementById('poruthamLoading').style.display = 'block';
      document.getElementById('poruthamResults').style.display = 'none';

      try {
        const res = await fetch('/api/match/porutham', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(r => r.json());

        document.getElementById('poruthamLoading').style.display = 'none';

        if (res.error) throw new Error(res.error);

        displayPoruthamResults(res);

      } catch (e) {
        document.getElementById('poruthamLoading').style.display = 'none';
        alert('Error: ' + e.message);
      }
    };

    // --- Daily Horoscope Logic ---
    const zodiacSigns = [
      { name: '‡ÆÆ‡Øá‡Æ∑‡ÆÆ‡Øç', icon: 'üêè', api: 'aries' },
      { name: '‡Æ∞‡Æø‡Æ∑‡Æ™‡ÆÆ‡Øç', icon: 'üêÇ', api: 'taurus' },
      { name: '‡ÆÆ‡Æø‡Æ§‡ØÅ‡Æ©‡ÆÆ‡Øç', icon: 'üëØ', api: 'gemini' },
      { name: '‡Æï‡Æü‡Æï‡ÆÆ‡Øç', icon: 'ü¶Ä', api: 'cancer' },
      { name: '‡Æö‡Æø‡ÆÆ‡Øç‡ÆÆ‡ÆÆ‡Øç', icon: 'ü¶Å', api: 'leo' },
      { name: '‡Æï‡Æ©‡Øç‡Æ©‡Æø', icon: 'üëß', api: 'virgo' },
      { name: '‡Æ§‡ØÅ‡Æ≤‡Ææ‡ÆÆ‡Øç', icon: '‚öñÔ∏è', api: 'libra' },
      { name: '‡Æµ‡Æø‡Æ∞‡ØÅ‡Æö‡Øç‡Æö‡Æø‡Æï‡ÆÆ‡Øç', icon: 'ü¶Ç', api: 'scorpio' },
      { name: '‡Æ§‡Æ©‡ØÅ‡Æö‡ØÅ', icon: 'üèπ', api: 'sagittarius' },
      { name: '‡ÆÆ‡Æï‡Æ∞‡ÆÆ‡Øç', icon: 'üêê', api: 'capricorn' },
      { name: '‡Æï‡ØÅ‡ÆÆ‡Øç‡Æ™‡ÆÆ‡Øç', icon: 'üè∫', api: 'aquarius' },
      { name: '‡ÆÆ‡ØÄ‡Æ©‡ÆÆ‡Øç', icon: 'üêü', api: 'pisces' }
    ];

    function renderZodiacScroller() {
      const container = document.getElementById('zodiacScroller');
      if (!container) return;
      container.innerHTML = '';

      zodiacSigns.forEach((sign, idx) => {
        const div = document.createElement('div');
        div.className = `zodiac-item ${idx === 0 ? 'active' : ''}`;
        div.onclick = () => {
          document.querySelectorAll('.zodiac-item').forEach(el => el.classList.remove('active'));
          div.classList.add('active');
          fetchHoroscope(sign);
        };
        div.innerHTML = `
             <span class="zodiac-icon">${sign.icon}</span>
             <div class="zodiac-name">${sign.name}</div>
          `;
        container.appendChild(div);
      });
    }

    let horoscopeCache = {}; // Simple cache
    // Tamil Fallback Data
    const fallbackHoroscopeData = {
      'aries': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡ØÅ‡Æï‡Øç‡Æï‡ØÅ ‡Æ®‡Æ±‡Øç‡Æ™‡Æ≤‡Æ©‡Øç‡Æï‡Æ≥‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Æ≥‡Æø‡Æ≤‡Øç ‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø ‡Æï‡Æø‡Æü‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æö‡Æø‡Æµ‡Æ™‡Øç‡Æ™‡ØÅ (Red)' },
      'taurus': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æ™‡Øä‡Æ∞‡ØÅ‡Æ≥‡Ææ‡Æ§‡Ææ‡Æ∞ ‡Æµ‡Æ∞‡Æµ‡ØÅ ‡Æö‡Æø‡Æ±‡Æ™‡Øç‡Æ™‡Ææ‡Æï ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æï‡ØÅ‡Æü‡ØÅ‡ÆÆ‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡ÆÆ‡Æï‡Æø‡Æ¥‡Øç‡Æö‡Øç‡Æö‡Æø ‡Æ®‡Æø‡Æ≤‡Æµ‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æµ‡ØÜ‡Æ≥‡Øç‡Æ≥‡Øà (White)' },
      'gemini': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æ®‡Æ£‡Øç‡Æ™‡Æ∞‡Øç‡Æï‡Æ≥‡Æø‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ‡Æø ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÆ‡ØÅ‡ÆØ‡Æ±‡Øç‡Æö‡Æø‡Æï‡Æ≥‡Øç ‡Æï‡Øà‡Æï‡Øç‡Æï‡ØÇ‡Æü‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æ™‡Æö‡Øç‡Æö‡Øà (Green)' },
      'cancer': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡ÆÆ‡Æ©‡Æ§‡Æø‡Æ≤‡Øç ‡Æ®‡Æø‡ÆÆ‡Øç‡ÆÆ‡Æ§‡Æø ‡Æ™‡Æø‡Æ±‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æ§‡Øä‡Æ¥‡Æø‡Æ≤‡Æø‡Æ≤‡Øç ‡ÆÆ‡ØÅ‡Æ©‡Øç‡Æ©‡Øá‡Æ±‡Øç‡Æ±‡ÆÆ‡Øç ‡Æâ‡Æ£‡Øç‡Æü‡ØÅ.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æ™‡Ææ‡Æ≤‡Øç ‡Æµ‡ØÜ‡Æ≥‡Øç‡Æ≥‡Øà (Cream)' },
      'leo': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æâ‡Æ§‡Øç‡Æ§‡Æø‡ÆØ‡Øã‡Æï‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡ÆÆ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡ØÅ ‡Æï‡ØÇ‡Æü‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ∞‡Æö‡ØÅ ‡Æµ‡Æ¥‡Æø‡ÆØ‡Æø‡Æ≤‡Øç ‡ÆÜ‡Æ§‡Ææ‡ÆØ‡ÆÆ‡Øç ‡Æâ‡Æ£‡Øç‡Æü‡ØÅ.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡ÆÜ‡Æ∞‡Æû‡Øç‡Æö‡ØÅ (Orange)' },
      'virgo': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æµ‡Æø‡ÆØ‡Ææ‡Æ™‡Ææ‡Æ∞‡Æ§‡Øç‡Æ§‡Æø‡Æ≤‡Øç ‡Æ≤‡Ææ‡Æµ‡ÆÆ‡Øç ‡Æ™‡ØÜ‡Æ∞‡ØÅ‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æâ‡Æ±‡Æµ‡Æø‡Æ©‡Æ∞‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æ∞‡ØÅ‡Æï‡Øà ‡Æá‡Æ∞‡ØÅ‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æ™‡Æö‡Øç‡Æö‡Øà (Green)' },
      'libra': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æï‡Æ£‡Æµ‡Æ©‡Øç ‡ÆÆ‡Æ©‡Øà‡Æµ‡Æø ‡Æí‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øà ‡Æ™‡Æ≤‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç.\n‡Æ™‡ÆØ‡Æ£‡Æô‡Øç‡Æï‡Æ≥‡Ææ‡Æ≤‡Øç ‡Æ®‡Æ©‡Øç‡ÆÆ‡Øà ‡Æâ‡Æ£‡Øç‡Æü‡Ææ‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æ®‡ØÄ‡Æ≤‡ÆÆ‡Øç (Blue)' },
      'scorpio': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æö‡Æ®‡Øç‡Æ§‡Æø‡Æ∞‡Ææ‡Æ∑‡Øç‡Æü‡ÆÆ‡ÆÆ‡Øç ‡Æé‡Æ©‡Øç‡Æ™‡Æ§‡Ææ‡Æ≤‡Øç ‡Æï‡Æµ‡Æ©‡ÆÆ‡Øç ‡Æ§‡Øá‡Æµ‡Øà.\n‡Æµ‡ØÄ‡Æ£‡Øç ‡Æµ‡Æø‡Æµ‡Ææ‡Æ§‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æ§‡Æµ‡Æø‡Æ∞‡Øç‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æö‡Æø‡Æµ‡Æ™‡Øç‡Æ™‡ØÅ (Red)' },
      'sagittarius': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æï‡ØÅ‡Æ∞‡ØÅ ‡ÆÖ‡Æ∞‡ØÅ‡Æ≥‡Øç ‡Æ™‡Æ∞‡Æø‡Æ™‡ØÇ‡Æ∞‡Æ£‡ÆÆ‡Ææ‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æ§‡ØÅ.\n‡ÆÜ‡Æ©‡Øç‡ÆÆ‡ØÄ‡Æï ‡Æö‡Æø‡Æ®‡Øç‡Æ§‡Æ©‡Øà ‡ÆÆ‡Øá‡Æ≤‡Øã‡Æô‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡ÆÆ‡Æû‡Øç‡Æö‡Æ≥‡Øç (Yellow)' },
      'capricorn': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æâ‡Æ¥‡Øà‡Æ™‡Øç‡Æ™‡ØÅ‡Æï‡Øç‡Æï‡Øá‡Æ±‡Øç‡Æ± ‡Æä‡Æ§‡Æø‡ÆØ‡ÆÆ‡Øç ‡Æï‡Æø‡Æü‡Øà‡Æï‡Øç‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æ®‡Æø‡Æ≤‡ØÅ‡Æµ‡Øà‡ÆØ‡Æø‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥ ‡Æ™‡Æ£‡Æø‡Æï‡Æ≥‡Øç ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æ®‡ØÄ‡Æ≤‡ÆÆ‡Øç (Blue)' },
      'aquarius': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æé‡Æ§‡Æø‡Æ∞‡Øç‡Æ™‡Ææ‡Æ∞‡Ææ‡Æ§ ‡Æ§‡Æ©‡Æµ‡Æ∞‡Æµ‡ØÅ ‡Æâ‡Æ£‡Øç‡Æü‡Ææ‡Æï‡ØÅ‡ÆÆ‡Øç.\n‡Æ®‡Æ£‡Øç‡Æ™‡Æ∞‡Øç‡Æï‡Æ≥‡Ææ‡Æ≤‡Øç ‡ÆÜ‡Æ§‡Ææ‡ÆØ‡ÆÆ‡Øç ‡Æâ‡Æ£‡Øç‡Æü‡ØÅ.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡Æ®‡ØÄ‡Æ≤‡ÆÆ‡Øç (Blue)' },
      'pisces': { date: '‡Æá‡Æ©‡Øç‡Æ±‡ØÅ', horoscope_data: '‡Æö‡ØÅ‡Æ™ ‡Æµ‡Æø‡Æ∞‡ÆØ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æè‡Æ±‡Øç‡Æ™‡Æü‡ØÅ‡ÆÆ‡Øç.\n‡Æï‡ØÅ‡Æü‡ØÅ‡ÆÆ‡Øç‡Æ™‡Æ§‡Øç‡Æ§‡ØÅ‡Æü‡Æ©‡Øç ‡Æá‡Æ±‡Øà‡Æµ‡Æ¥‡Æø‡Æ™‡Ææ‡Æü‡ØÅ ‡Æö‡ØÜ‡ÆØ‡Øç‡Æµ‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç.\n‡ÆÖ‡Æ§‡Æø‡Æ∞‡Øç‡Æ∑‡Øç‡Æü ‡Æ®‡Æø‡Æ±‡ÆÆ‡Øç: ‡ÆÆ‡Æû‡Øç‡Æö‡Æ≥‡Øç (Yellow)' }
    };

    async function fetchHoroscope(signObj) {
      const loading = document.getElementById('horoscopeLoading');
      const content = document.getElementById('horoscopeContent');
      const dateEl = document.getElementById('horoscopeDate');

      if (loading) loading.style.display = 'block';
      if (content) content.classList.add('hidden');

      // Update active header immediately
      document.getElementById('activeSignIcon').innerText = signObj.icon;
      document.getElementById('activeSignName').innerText = signObj.name;

      // Check cache
      const today = new Date().toDateString();
      const cacheKey = `${signObj.api}-${today}`;

      if (horoscopeCache[cacheKey]) {
        displayHoroscope(horoscopeCache[cacheKey]);
        return;
      }

      try {
        const res = await fetch(`https://horoscope-app-api.vercel.app/api/v1/get-horoscope/daily?sign=${signObj.api}&day=today`)
          .then(r => r.json());

        if (res.data) {
          horoscopeCache[cacheKey] = res.data;
          displayHoroscope(res.data);
        } else {
          throw new Error("No data");
        }
      } catch (e) {
        console.warn('API Failed, using fallback', e);
        // Use Fallback
        const fallback = fallbackHoroscopeData[signObj.api] || fallbackHoroscopeData['aries'];
        displayHoroscope(fallback);
      }
    }

    function displayHoroscope(data) {
      const loading = document.getElementById('horoscopeLoading');
      const content = document.getElementById('horoscopeContent');

      if (loading) loading.style.display = 'none';
      if (content) content.classList.remove('hidden');

      document.getElementById('horoscopeDate').innerText = data.date;
      document.getElementById('horoscopeText').innerText = data.horoscope_data;
    }

    // Initialize Horoscope
    renderZodiacScroller();
    fetchHoroscope(zodiacSigns[0]); // Load Aries by default

    function displayPoruthamResults(data) {
      const m = data.match;
      const div = document.getElementById('poruthamResults');

      const scoreColor = m.percentage > 50 ? '#10b981' : '#ef4444';

      let html = `
         <div style="background:${scoreColor}20; border:2px solid ${scoreColor}; padding:20px; border-radius:12px; text-align:center; margin-bottom:20px;">
           <div style="font-size:1.1rem; color:#444;">Compatibility Score</div>
           <div style="font-size:3rem; font-weight:900; color:${scoreColor}; line-height:1;">${m.percentage}%</div>
           <div style="font-size:1.2rem; font-weight:bold; color:#333;">${m.totalScore} / ${m.maxScore} Points</div>
         </div>

         <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
            <div style="background:#eff6ff; padding:15px; border-radius:10px;">
               <div style="font-weight:bold; color:#1e40af;">ü§µ Boy</div>
               <div>${data.boy.rasi} / ${data.boy.nakshatra}</div>
            </div>
             <div style="background:#fdf2f8; padding:15px; border-radius:10px;">
               <div style="font-weight:bold; color:#be185d;">üë∞ Girl</div>
               <div>${data.girl.rasi} / ${data.girl.nakshatra}</div>
            </div>
         </div>

         <div class="porutham-grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:10px;">
       `;

      const items = [
        { k: 'dina', l: 'Dina' }, { k: 'gana', l: 'Gana' },
        { k: 'mahendra', l: 'Mahendra' }, { k: 'streeDeergha', l: 'Stree Deergha' },
        { k: 'yoni', l: 'Yoni' }, { k: 'rasi', l: 'Rasi' },
        { k: 'rasiAdhipati', l: 'Rasi Adhipati' }, { k: 'vashya', l: 'Vashya' },
        { k: 'rajju', l: 'Rajju' }, { k: 'vedha', l: 'Vedha' }
      ];

      items.forEach(i => {
        const p = m[i.k];
        if (p) {
          const icon = p.status ? '‚úÖ' : '‚ùå';
          const bg = p.status ? '#ecfdf5' : '#fef2f2';
          const border = p.status ? '#10b981' : '#ef4444';

          html += `
               <div style="background:${bg}; border-left:4px solid ${border}; padding:10px; border-radius:6px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                 <div style="font-size:0.85rem; color:#666;">${i.l}</div>
                 <div style="font-weight:bold; font-size:1rem; margin:2px 0;">${icon} ${p.status ? 'Good' : 'Bad'}</div>
                 <!-- <div style="font-size:0.75rem; color:#777;">${p.description || ''}</div> -->
               </div>
             `;
        }
      });

      html += `</div>`;
      div.innerHTML = html;
      div.style.display = 'block';
    }

    // --- Admin Withdrawal Logic ---
    window.approveWithdrawal = function (wid, amount) {
      if (!confirm(`Approve deduction of ‚Çπ${amount} from Astrologer wallet?`)) return;
      socket.emit('approve-withdrawal', { withdrawalId: wid }, (res) => {
        if (res.ok) {
          alert('‚úÖ Connection Approved & Wallet Deducted!');
          // Remove popup if exists
          const el = document.getElementById(`notif-${wid}`);
          if (el) el.remove();
        } else {
          alert('‚ùå Error: ' + res.error);
        }
      });
    };

    socket.on('admin-notification', (msg) => {
      if (state.me && state.me.role === 'superadmin') {
        // Create Popup
        const div = document.createElement('div');
        div.className = 'admin-notification-popup';
        div.id = `notif-${msg.data ? msg.data.withdrawalId : Date.now()}`;
        div.innerHTML = `
             <div style="font-weight:bold; margin-bottom:5px; color:#111;">üîî Notification</div>
             <div style="margin-bottom:10px; color:#555;">${msg.text}</div>
             ${msg.data && msg.data.withdrawalId ?
            `<button class="approve" onclick="approveWithdrawal('${msg.data.withdrawalId}', ${msg.data.amount})">Accept & Deduct</button>` : ''}
             <button class="close" onclick="this.parentElement.remove()">Close</button>
          `;
        document.body.appendChild(div);

        // Sound Effect
        try { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play(); } catch (e) { }
      }
    });

    // Initialize
    checkSession();
  </script>
  <style>
    /* --- Trust Badges --- */
    .ribbon {
      position: absolute;
      top: -4px;
      left: -4px;
      z-index: 10;
      overflow: hidden;
      width: 75px;
      height: 75px;
      text-align: right;
    }

    .ribbon span {
      font-size: 0.6rem;
      font-weight: bold;
      color: #FFF;
      text-transform: uppercase;
      text-align: center;
      line-height: 20px;
      transform: rotate(-45deg);
      -webkit-transform: rotate(-45deg);
      width: 100px;
      display: block;
      background: linear-gradient(#F59E0B 0%, #D97706 100%);
      box-shadow: 0 3px 10px -5px rgba(0, 0, 0, 1);
      position: absolute;
      top: 19px;
      left: -21px;
    }

    .ribbon span::before,
    .ribbon span::after {
      content: "";
      position: absolute;
      top: 0;
      margin: 0 -1px;
      /* tweak */
      width: 100%;
      height: 100%;
      background: inherit;
      min-height: 20px;
    }

    .privacy-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: #F3F4F6;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.7rem;
      color: #6B7280;
      margin-top: 5px;
      border: 1px solid #E5E7EB;
    }

    /* Modify card to accommodate ribbon */
    .astro-card {
      overflow: hidden;
      /* For ribbon cropping */
    }

    /* --- Custom Global Alert Modal CSS --- */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .custom-modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .custom-modal-box {
      background: white;
      width: 90%;
      max-width: 320px;
      padding: 25px 20px;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      transform: scale(0.8);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .custom-modal-overlay.open .custom-modal-box {
      transform: scale(1);
    }

    .custom-modal-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #FEF3C7;
      color: #F59E0B;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      margin-bottom: 15px;
      box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);
    }

    .custom-modal-message {
      font-size: 1.05rem;
      color: #374151;
      margin-bottom: 25px;
      line-height: 1.5;
      font-weight: 500;
    }

    .custom-modal-btn {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
      transition: transform 0.2s;
      width: 100%;
    }

    .custom-modal-btn:active {
      transform: scale(0.96);
    }
  </style>
  <div id="lowBalanceOverlay" class="low-balance-overlay">
    <div class="low-balance-card">
      <div class="alert-icon-wrapper">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="lb-title">Low Balance!</div>
      <div class="lb-message" id="lbMessage">Your wallet balance is running low. Recharge now to continue your cosmic
        consultation uninterrupted.</div>

      <div class="current-bal-box">
        <span class="bal-label">Current Balance:</span>
        <span class="bal-amount" id="lbAmount">‚Çπ0</span>
      </div>

      <button class="btn-recharge" onclick="location.href='#recharge'">Add Funds Now</button>
      <button class="btn-dismiss" onclick="hideLowBalanceAlert()">I'll do it later</button>
    </div>
  </div>

  <!-- Custom Global Alert Modal HTML -->
  <div id="custom-alert-modal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="custom-modal-icon"><i class="fas fa-bell"></i></div>
      <div id="custom-alert-message" class="custom-modal-message">Notification Message</div>
      <button class="custom-modal-btn" onclick="closeCustomAlert()">OK</button>
    </div>
  </div>

  <script>
    // Override native alert
    window.alert = function (message) {
      const modal = document.getElementById('custom-alert-modal');
      const msgBox = document.getElementById('custom-alert-message');
      if (modal && msgBox) {
        msgBox.innerText = message;
        modal.classList.add('open');
        // Play a subtle sound if desired? No, keep it visual for now.
      } else {
        console.log("Alert:", message);
      }
    };

    // --- New Recharge Modal Logic ---
    // --- Transaction History ---
    window.fetchTransactionHistory = async function () {
      if (!state.me || !state.me.userId) return;

      const listEl = document.getElementById('transactionList');
      if (!listEl) return;

      // Keep loading state if empty, or just transparent update
      // listEl.innerHTML = '<div style="text-align:center; padding:10px; color:#6B7280;">Updating...</div>';

      try {
        const res = await fetch(`/api/payment/history/${state.me.userId}`).then(r => r.json());
        if (res.ok && res.data) {
          if (res.data.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; padding:20px; color:#6B7280; font-size:0.9rem;">No transactions found.</div>';
            return;
          }

          listEl.innerHTML = res.data.map(txn => {
            const date = new Date(txn.createdAt).toLocaleDateString() + ' ' + new Date(txn.createdAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const statusColor = txn.status === 'success' ? '#059669' : (txn.status === 'failed' ? '#DC2626' : '#D97706');
            const icon = txn.status === 'success' ? 'fa-check-circle' : (txn.status === 'failed' ? 'fa-times-circle' : 'fa-clock');

            return `
            <div style="background:white; padding:15px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
              <div style="display:flex; align-items:center; gap:12px;">
                <div style="width:40px; height:40px; border-radius:50%; background:${statusColor}20; display:flex; align-items:center; justify-content:center; color:${statusColor}; font-size:1.1rem;">
                  <i class="fas ${icon}"></i>
                </div>
                <div>
                   <div style="font-weight:bold; color:#374151; font-size:1rem;">‚Çπ${txn.amount}</div>
                   <div style="font-size:0.75rem; color:#9CA3AF;">${date}</div>
                </div>
              </div>
              <div style="text-align:right;">
                 <div style="font-size:0.8rem; font-weight:600; color:${statusColor}; text-transform:capitalize;">${txn.status}</div>
                 <div style="font-size:0.65rem; color:#D1D5DB; margin-top:2px;">#${txn.transactionId ? txn.transactionId.slice(-6).toUpperCase() : '---'}</div>
              </div>
            </div>
            `;
          }).join('');
        }
      } catch (e) {
        console.error("History Fetch Error", e);
        listEl.innerHTML = '<div style="text-align:center; padding:10px; color:#EF4444;">Failed to load history.</div>';
      }
    };

    window.initiateRecharge = function (amountStr) {
      if (amountStr) {
        // Direct call (if any)
        processRecharge(parseFloat(amountStr));
      } else {
        // Show Modal
        document.getElementById('screen-recharge').classList.remove('hidden');
      }
    };

    window.closeRechargeModal = function () {
      document.getElementById('screen-recharge').classList.add('hidden');
    };

    window.setRechargeAmount = function (amt) {
      document.getElementById('rechargeInput').value = amt;
    };

    window.submitRecharge = function () {
      const amtVal = document.getElementById('rechargeInput').value;
      if (!amtVal || parseFloat(amtVal) <= 0) return alert("Please enter a valid amount");

      closeRechargeModal();
      processRecharge(parseFloat(amtVal));
    };

    async function processRecharge(amount) {
      if (!amount || amount <= 0) return alert("Invalid amount");
      if (!state.me || !state.me.userId) return alert("Please login first");

      try {
        const isApp = !!window.ReactNativeWebView;

        const res = await fetch('/api/payment/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, userId: state.me.userId, isApp })
        }).then(r => r.json());

        if (res.ok) {
          if (isApp && res.paymentUrl) {
            // App Flow - Open payment URL in external browser
            // This is more reliable than native SDK
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'OPEN_PAYMENT_URL',
              url: res.paymentUrl,
              txnId: res.merchantTransactionId
            }));
          } else if (res.paymentUrl) {
            // Web Flow - Redirect to payment page
            window.location.href = res.paymentUrl;
          } else if (isApp && res.base64Body) {
            // Legacy Native SDK Flow (Fallback)
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'UPI_PAY',
              merchantId: res.merchantId,
              txnId: res.merchantTransactionId,
              base64Body: res.base64Body,
              checksum: res.checksum
            }));
          } else {
            alert("Payment Error: No URL returned");
          }
        } else {
          alert("Recharge Error: " + (res.error || 'Unknown'));
        }
      } catch (e) {
        console.error(e);
        alert("Failed to initiate payment");
      }
    }

    function closeCustomAlert() {
      const modal = document.getElementById('custom-alert-modal');
      if (modal) {
        modal.classList.remove('open');
      }
    }

    // --- Low Balance Alert Logic ---
    function showLowBalanceAlert(balance, message) {
      const overlay = document.getElementById('lowBalanceOverlay');
      const amtEl = document.getElementById('lbAmount');
      const msgEl = document.getElementById('lbMessage');

      if (amtEl) amtEl.innerText = '‚Çπ' + balance;
      if (msgEl && message) msgEl.innerText = message;
      else if (msgEl) msgEl.innerText = "Your wallet balance is running low. Recharge now to continue your cosmic consultation uninterrupted.";

      if (overlay) overlay.classList.add('active');
    }

    function hideLowBalanceAlert() {
      const overlay = document.getElementById('lowBalanceOverlay');
      if (overlay) overlay.classList.remove('active');
    }

    // --- On-Demand Earnings Logic ---
    function toggleEarnings() {
      const cont = document.getElementById('astroEarningsContainer');
      const btn = document.getElementById('btnShowEarnings');
      if (!cont || !btn) return;

      // Unhide if hidden
      if (cont.style.display === 'none') {
        cont.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Data';
      } else {
        // Feedback animation
        const oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
        setTimeout(() => btn.innerHTML = oldText, 1000);
      }

      // Fetch Latest from DB
      if (state.me && state.me.userId) {
        socket.emit('get-wallet', { userId: state.me.userId });
      }
    }

    // --- Session Summary Logic ---
    function closeSummaryModal() {
      document.getElementById('sessionSummaryModal').classList.add('hidden');
      // Trigger wallet refresh
      if (state.me && state.me.userId) {
        socket.emit('get-wallet', { userId: state.me.userId });
      }
      // Refresh page as requested
      setTimeout(() => {
        window.location.reload();
      }, 500);
    }

    function showSummary(data) {
      const modal = document.getElementById('sessionSummaryModal');
      const text = document.getElementById('summaryText');
      const amt = modal.querySelector('.summary-amount');

      modal.classList.remove('hidden');

      if (state.me.role === 'client') {
        text.innerText = "Total Deducted";
        amt.innerText = '‚Çπ' + (data.deducted || 0);
        amt.style.color = '#DC2626';
      } else {
        text.innerText = "Total Earnings";
        amt.innerText = '‚Çπ' + (data.earned || 0);
        amt.style.color = '#059669';
      }

      // Add Duration Display
      if (typeof data.duration !== 'undefined') {
        const dSec = data.duration;
        const dMin = Math.floor(dSec / 60);
        const dRem = dSec % 60;
        let dText = document.getElementById('summaryDuration');
        if (!dText) {
          dText = document.createElement('div');
          dText.id = 'summaryDuration';
          dText.style.cssText = "font-size:1rem; color:#6B7280; margin-bottom:10px;";
          amt.parentNode.insertBefore(dText, amt);
        }
        dText.innerText = `Billed Duration: ${dMin}m ${dRem}s`;
      }
    }
  </script>

  <!-- Session Summary Modal -->
  <div id="sessionSummaryModal" class="modal-overlay hidden"
    style="display:flex; align-items:center; justify-content:center; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div class="modal-content"
      style="background:white; border-radius:15px; width:90%; max-width:350px; text-align:center; padding:30px; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
      <h2 style="color:#111; margin-bottom:10px;"> ‡Æ®‡Æ©‡Øç‡Æ±‡Æø ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æ∞‡ØÅ‡Æï</h2>
      <!-- <div id="summaryText" style="font-size:1.2rem; color:#4B5563; margin-bottom:20px;"></div> -->
      <div class="summary-amount" style="font-size:2rem; font-weight:bold; color: #059669; margin-bottom:30px;"></div>
      <button onclick="closeSummaryModal()" class="btn-primary"
        style="width:100%; padding: 12px; font-size:1rem; border-radius:10px; border:none; background:#2563EB; color:white; font-weight:bold;">Okay</button>
    </div>
  </div>
</body>

</html>