<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Celestial Consultation</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/smoothness/jquery-ui.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <style>
    :root {
      /* Shared Colors */
      /* Shared Colors - Milk Green Luxury Theme */
      --primary: #047857;
      /* Deep Emerald for Text/Important */
      --secondary: #6EE7B7;
      /* Soft Milk Green */
      --bg-body: #F0FDF4;
      /* Very Light Mint Background */
      --accent-gold: #D4AF37;
      /* Luxury Gold Accent */
      --surface: #FFFFFF;
      --border: #A7F3D0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      height: 100vh;
      overflow: hidden;
      background: var(--bg-body);
    }

    input,
    button {
      font-family: inherit;
      outline: none;
    }

    .hidden {
      display: none !important;
    }

    .flex {
      display: flex;
    }

    .w-full {
      width: 100%;
    }

    /* === LOGIN === */
    #screen-login {
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #065F46, #059669, #34D399);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
    }

    .form-box {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }

    .cosmic-input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
    }

    .cosmic-btn {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 8px;
      border: none;
      background: linear-gradient(to right, #059669, #047857);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      color: white;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* === DASHBOARD LAYOUT === */
    .dashboard-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg-body);
      position: relative;
    }

    .app-header {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: none;
      color: var(--primary);
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      padding-bottom: 80px;
    }

    /* === CLIENT DASHBOARD (Rise Style) === */
    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      overflow-x: auto;
    }

    .tab {
      padding: 6px 12px;
      border-radius: 20px;
      background: white;
      border: 1px solid #ddd;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .astro-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      gap: 12px;
      position: relative;
    }

    .astro-img {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      position: absolute;
      bottom: 12px;
      left: 54px;
      background: #9CA3AF;
      /* gray default */
    }

    .status-dot.online {
      background: #22C55E;
    }

    .status-dot.busy {
      background: #EF4444;
    }

    /* === ASTROLOGER DASHBOARD (New UI) === */
    .astro-dash-header {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .toggle-row {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .toggle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .toggle-switch {
      width: 40px;
      height: 22px;
      background: #E5E7EB;
      border-radius: 20px;
      position: relative;
      cursor: pointer;
      transition: 0.3s;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle-switch.active {
      background: #22C55E;
    }

    .toggle-switch.active::after {
      left: 20px;
    }

    .emergency-banner {
      background: #B91C1C;
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .progress-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .grid-menu {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .grid-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      font-size: 0.8rem;
      color: #555;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .grid-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #F3F4F6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #333;
    }

    /* === MODALS === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .call-popup {
      background: white;
      width: 85%;
      max-width: 320px;
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      animation: popUp 0.3s ease-out;
    }

    @keyframes popUp {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .caller-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: block;
    }

    .btn-accept {
      background: #22C55E;
      padding: 10px 30px;
      border-radius: 30px;
      color: white;
      font-size: 1.1rem;
      margin: 10px;
      border: none;
    }

    .btn-reject {
      background: #EF4444;
      padding: 10px 30px;
      border-radius: 30px;
      color: white;
      font-size: 1.1rem;
      margin: 10px;
      border: none;
    }

    /* === SESSION === */
    #screen-session {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 3000;
      display: flex;
      flex-direction: column;
    }

    .video-area {
      flex: 1;
      position: relative;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #localVideo {
      position: absolute;
      right: 20px;
      bottom: 140px;
      width: 90px;
      height: 120px;
      background: #333;
      border-radius: 12px;
      border: 2px solid white;
    }

    .controls {
      position: absolute;
      bottom: 50px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
    }

    .circle-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .controls.hidden {
      display: none !important;
    }

    /* === ADMIN DASHBOARD === */
    .admin-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .admin-user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .admin-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .btn-admin {
      padding: 6px 12px;
      border-radius: 6px;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
      flex: 1;
    }

    .btn-block {
      background: #EF4444;
    }

    .btn-wallet {
      background: #22C55E;
    }

    .btn-role {
      background: #3B82F6;
    }

    .user-pill {
      background: #F3F4F6;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      color: #555;
    }
  </style>
</head>

<body>

  <!-- Screen: Login -->
  <div id="screen-login">
    <div class="form-box">
      <h2>âœ¨Astro5 Login</h2>
      <div id="step-phone">
        <input id="inputPhone" class="cosmic-input" placeholder="Mobile Number" value="">
        <button id="btnSendOtp" class="cosmic-btn">Get OTP</button>
        <div style="margin-top: 10px; font-size: 0.8rem; color: #ddd;">
          Use: 9000000001 (Astro) or 8000000001 (Client)
        </div>
      </div>
      <div id="step-otp" class="hidden">
        <input id="inputOtp" class="cosmic-input" placeholder="OTP" value="">
        <button id="btnVerifyOtp" class="cosmic-btn">Verify</button>
      </div>
    </div>
  </div>

  <!-- Screen: Client Dashboard -->
  <div id="screen-client" class="dashboard-container hidden">
    <div class="app-header">
      <div style="font-weight: bold; font-size: 1.2rem;">Rise Astro</div>
      <div>
        <i class="fas fa-wallet"></i> â‚¹<span id="clientWallet">369</span>
        <i class="fas fa-sign-out-alt" style="margin-left: 10px; cursor: pointer;" onclick="clearSession()"></i>
      </div>
    </div>
    <div class="content-area">
      <div class="filter-tabs">
        <div class="tab">All</div>
        <div class="tab">Love</div>
        <div class="tab">Career</div>
      </div>
      <div id="astroList">
        <!-- Dynamic Content -->
      </div>
    </div>
  </div>

  <!-- Screen: Astrologer Dashboard -->
  <div id="screen-astro" class="dashboard-container hidden">
    <div class="app-header">
      <div style="display: flex; align-items: center; gap: 10px;">
        <img src="" id="astroAvatar" style="width: 35px; height: 35px; border-radius: 50%;">
        <div>
          <div style="font-weight: bold;" id="astroName">Astrologer</div>
          <div style="font-size: 0.7rem; color: #666;">ID: <span id="astroId">...</span></div>
        </div>
      </div>
      <div>
        <i class="fas fa-bell"></i>
        <i class="fas fa-sign-out-alt" style="margin-left: 10px; cursor: pointer;" onclick="clearSession()"></i>
      </div>
    </div>

    <div class="content-area">
      <!-- Toggles -->
      <div class="toggle-row">
        <div class="toggle-item">
          <span>Chat <small class="text-muted">â‚¹20/min</small></span>
          <div class="toggle-switch" id="toggleChat"></div>
        </div>
        <div class="toggle-item">
          <span>Call <small class="text-muted">â‚¹20/min</small></span>
          <div class="toggle-switch" id="toggleCall"></div>
        </div>
        <div class="toggle-item">
          <span>Video Call <small class="text-muted">â‚¹20/min</small></span>
          <div class="toggle-switch" id="toggleVideo"></div>
        </div>
      </div>

      <div class="emergency-banner">
        <div style="font-weight: bold; margin-bottom: 5px;">Online for Emergency!</div>
        <div style="font-size: 0.8rem; opacity: 0.9;">Boost your earnings with emergency sessions.</div>
      </div>

      <div class="progress-card">
        <div>
          <div style="font-weight: bold; font-size: 1.1rem;">Today's Progress</div>
          <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">0 hours left to complete target</div>
        </div>
        <div
          style="width: 60px; height: 60px; border-radius: 50%; border: 4px solid #eee; display: flex; align-items: center; justify-content: center;">
          0m
        </div>
      </div>

      <div class="grid-menu">
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-phone"></i></div> Call
        </div>
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-comment"></i></div> Chat
        </div>
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-wallet"></i></div> Wallet
        </div>
        <div class="grid-item">
          <div class="grid-icon"><i class="fas fa-star"></i></div> Reviews
        </div>
        <div class="grid-item" onclick="showHistory()" style="cursor: pointer;">
          <div class="grid-icon"><i class="fas fa-clock"></i></div> History
        </div>
        <div class="grid-item" onclick="showProfile()" style="cursor: pointer;">
          <div class="grid-icon"><i class="fas fa-user"></i></div> Profile
        </div>
        <div class="grid-item" onclick="showChartHelper()" style="cursor: pointer;">
          <div class="grid-icon"><i class="fas fa-chart-pie"></i></div> Birth Chart
        </div>
      </div>
    </div>
  </div>

  <!-- Screen: Chart Helper Modal -->
  <div id="screen-chart-helper" class="modal-overlay hidden" style="align-items: flex-end;">
    <div class="chart-modal-content">
      <div class="chart-header">
        <span>ðŸ”® Birth Chart</span>
        <button onclick="document.getElementById('screen-chart-helper').classList.add('hidden')" class="close-btn"><i
            class="fas fa-times"></i></button>
      </div>

      <div class="chart-body">
        <!-- Input Form -->
        <div id="chartInputSection">
          <div class="input-card">
            <div class="input-row">
              <div style="flex:1">
                <label>Date of Birth</label>
                <input type="date" id="chartDate" class="app-input">
              </div>
              <div style="flex:1">
                <label>Time of Birth</label>
                <input type="time" id="chartTime" class="app-input">
              </div>
            </div>
            <!-- City Search Row (Restored) -->
            <div class="input-row" style="margin-top:15px; position:relative;">
              <div style="flex:1">
                <label>City / Place</label>
                <div style="display: flex; gap: 10px;">
                  <div style="flex:1; position:relative;">
                    <input type="text" id="citySearch" class="app-input" placeholder="Type City Name (e.g. Chennai)..."
                      autocomplete="off">
                    <div id="cityResults"
                      style="display:none; position:absolute; top:100%; left:0; right:0; background:white; border:1px solid #ddd; z-index:9999; max-height:200px; overflow-y:auto; border-radius:6px; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
                    </div>
                  </div>
                  <!-- Geo-Location Button -->
                  <button type="button" onclick="useCurrentLocation()" title="Use Current Location"
                    style="padding: 0 15px; background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; border-radius: 10px; cursor: pointer;">
                    <i class="fas fa-crosshairs"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Auto-Filled Coordinates (Visible) -->
            <div class="input-row" style="margin-top:10px;">
              <div style="flex:1; display:flex; gap:10px;">
                <div style="flex:1">
                  <label style="font-size:0.75rem; color:#666;">Latitude</label>
                  <input type="text" id="chartLat" value="13.0827" class="app-input" readonly
                    style="background:#f9fafb; color:#555;">
                </div>
                <div style="flex:1">
                  <label style="font-size:0.75rem; color:#666;">Longitude</label>
                  <input type="text" id="chartLon" value="80.2707" class="app-input" readonly
                    style="background:#f9fafb; color:#555;">
                </div>
              </div>
            </div>
          </div>

          <button class="cosmic-btn generate-btn" onclick="fetchChart()">
            <i class="fas fa-calculator"></i> Get Horoscope
          </button>
        </div>

        <div id="chartLoading" style="display:none; text-align:center; padding:40px; color: var(--primary);">
          <div class="spinner-astro"></div>
          <div style="margin-top:15px; font-weight:500;">Analyzing Planets...</div>
        </div>

        <!-- Results Area -->
        <div id="chartResults" style="display: none; height:100%; display:flex; flex-direction:column;">

          <div class="chart-tabs">
            <button onclick="switchChartTab('rasi')" class="c-tab active" id="tab-rasi">Rasi Chart</button>
            <button onclick="switchChartTab('basic')" class="c-tab" id="tab-basic">Planets</button>
            <button onclick="switchChartTab('dasha')" class="c-tab" id="tab-dasha">Dasha</button>
            <button onclick="resetChart()" class="c-tab" style="color:red;"><i class="fas fa-redo"></i></button>
          </div>

          <!-- Content: Rasi Chart (Traditional Box) -->
          <div id="content-rasi" class="chart-tab-content" style="flex:1; overflow-y:auto; padding-bottom:20px;">
            <div class="rasi-container">
              <div class="south-indian-chart" id="southChart">
                <!-- 12 Boxes generated by JS -->
              </div>
              <div class="chart-center-label">Rasi Chart (D1)</div>
            </div>

            <!-- Panchangam Container (Inserted Here) -->
            <div class="panchangam-container"
              style="margin-top:20px; background:#fff; border:1px solid #eee; padding:10px; border-radius:12px; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
              <div
                style="text-align:center; margin-bottom:10px; font-weight:bold; color:#d97706; text-transform:uppercase; letter-spacing:1px; font-size:0.9rem;">
                Panchangam</div>
              <div id="panchangamList"
                style="display:flex; flex-direction:column; gap:8px; font-size:0.9rem; color:#444;">
              </div>
            </div>

            <div class="navamsa-container" style="margin-top:20px;">
              <div style="text-align:center; margin-bottom:5px; font-weight:bold; color:#555;">Navamsa (D9)</div>
              <div class="south-indian-chart" id="navamsaChart"></div>
            </div>
          </div>

          <!-- Content: Basic -->
          <div id="content-basic" class="chart-tab-content hidden" style="overflow-y:auto;">
            <div id="planetList" class="planet-grid"></div>
          </div>

          <!-- Content: Dasha -->
          <div id="content-dasha" class="chart-tab-content hidden" style="overflow-y:auto;">
            <div id="currentDashaInfo" class="dasha-card-highlight"></div>
            <div style="margin-top:15px; font-weight:bold; color:#444; padding-left:5px;">Vimshottari Sequence</div>
            <div id="dashaList" class="dasha-list"></div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <style>
    /* Modal Mobile Animation */
    .chart-modal-content {
      background: #F3F4F6;
      width: 100%;
      height: 90vh;
      border-top-left-radius: 25px;
      border-top-right-radius: 25px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2);
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(100%);
      }

      to {
        transform: translateY(0);
      }
    }

    .chart-header {
      padding: 20px;
      background: white;
      font-weight: 700;
      font-size: 1.2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e5e5e5;
      color: #1F2937;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.4rem;
      color: #6B7280;
      cursor: pointer;
    }

    .chart-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      position: relative;
    }

    .input-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
    }

    .input-row {
      display: flex;
      gap: 15px;
    }

    .input-row label {
      display: block;
      font-size: 0.85rem;
      color: #4B5563;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .app-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #D1D5DB;
      border-radius: 10px;
      font-size: 1rem;
      color: #111827;
      background: #F9FAFB;
      transition: 0.2s;
    }

    .app-input:focus {
      border-color: var(--primary);
      background: white;
    }

    .generate-btn {
      font-size: 1.1rem;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 10px 15px -3px rgba(4, 120, 87, 0.2);
    }

    /* Tabs */
    .chart-tabs {
      display: flex;
      gap: 5px;
      background: white;
      padding: 5px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .c-tab {
      flex: 1;
      background: none;
      border: none;
      padding: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #6B7280;
      border-radius: 8px;
      cursor: pointer;
    }

    .c-tab.active {
      background: var(--border);
      color: #064E3B;
    }

    /* CHART VISUALIZATION - Real Rasi Kadam */
    .rasi-container {
      position: relative;
      width: 100%;
      max-width: 360px;
      margin: 0 auto;
    }

    .south-indian-chart {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 0;
      border: 2px solid #D97706;
      /* Traditional Dark Gold/Orange Border */
      background: #FEF3C7;
      /* Light Yellow Parchment Background */
      width: 100%;
      aspect-ratio: 1/1;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .SouthChartBox {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      position: relative;
      border: 1px solid #D97706;
      /* Inner borders */
      overflow: hidden;
    }

    /* Center "Kovil" (Empty Space) */
    .SouthChartBox[data-center="true"] {
      background: white;
      border: none;
    }

    /* Ensure borders don't double up awkwardly - handled by grid spacing 0 and proper border assignment, or use outline. Simple border on box works well for classic look. */

    .s-sign-label {
      position: absolute;
      top: 1px;
      left: 2px;
      font-size: 0.6rem;
      font-weight: bold;
      color: #D97706;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .s-planet-text {
      font-size: 0.75rem;
      font-weight: 700;
      color: #111;
      line-height: 1.2;
      z-index: 2;
    }

    .asc-badge {
      color: #DC2626 !important;
    }

    .chart-center-label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-weight: 900;
      color: #F59E0B;
      opacity: 0.2;
      font-size: 2rem;
      pointer-events: none;
    }

    /* Lists */
    .planet-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .planet-item {
      background: white;
      padding: 12px;
      border-radius: 10px;
      border-left: 4px solid var(--secondary);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    /* Panchangam Grid - Restored */
    .panchangam-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      overflow: hidden;
      margin-top: 10px;
    }

    .panchangam-grid>div {
      background: white;
      padding: 8px 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 70px;
    }

    @media (max-width: 600px) {
      .panchangam-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .panchangam-grid>div:last-child:nth-child(odd) {
        grid-column: span 2;
      }
    }

    .dasha-card-highlight {
      background: white;
      padding: 20px;
      border-radius: 15px;
      border-left: 5px solid var(--primary);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .dasha-list>div {
      background: white;
      margin-bottom: 8px;
      padding: 12px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
    }

    .spinner-astro {
      width: 50px;
      height: 50px;
      border: 5px solid var(--border);
      border-top: 5px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
  </style>

  <!-- Screen: Super Admin Dashboard -->
  <div id="screen-admin" class="dashboard-container hidden">
    <div class="app-header" style="background:#1e3a8a; color:white;">
      <div style="font-weight: bold; font-size: 1.2rem;">Super Admin</div>
      <div>
        <i class="fas fa-sign-out-alt" style="margin-left: 10px; cursor: pointer;" onclick="clearSession()"></i>
      </div>
    </div>
    <div class="content-area">
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <div
          style="flex:1; background:linear-gradient(135deg, #3b82f6, #2563eb); padding:15px; border-radius:12px; color:white;">
          <div style="font-size:0.8rem; opacity:0.8;">Total Users</div>
          <div style="font-size:1.5rem; font-weight:bold;" id="adminTotalUsers">0</div>
        </div>
        <div
          style="flex:1; background:linear-gradient(135deg, #10b981, #059669); padding:15px; border-radius:12px; color:white;">
          <div style="font-size:0.8rem; opacity:0.8;">Active Now</div>
          <div style="font-size:1.5rem; font-weight:bold;" id="adminActiveUsers">0</div>
        </div>
      </div>

      <h3 style="margin:10px 0;">User Management</h3>
      <div id="adminUserList">
        <!-- Dynamic User Cards -->
      </div>
    </div>
  </div>

  <!-- Screen: Admin Role Change Modal -->
  <div id="screen-admin-role-modal" class="modal-overlay hidden">
    <div class="call-popup" style="text-align: left;">
      <h3>Change User Role</h3>
      <p style="color:#666; font-size:0.9rem;">Select new role handler for this user.</p>

      <select id="adminRoleSelect" class="cosmic-input" style="color:black; background:white;">
        <option value="client">Client</option>
        <option value="astrologer">Astrologer</option>
        <option value="superadmin">Super Admin</option>
      </select>

      <div style="margin-top:20px; text-align:right;">
        <button onclick="document.getElementById('screen-admin-role-modal').classList.add('hidden')"
          style="padding:8px 15px; border:none; background:#eee; border-radius:5px; cursor:pointer;">Cancel</button>
        <button onclick="submitAdminRoleChange()"
          style="padding:8px 15px; border:none; background:#3b82f6; color:white; border-radius:5px; cursor:pointer; margin-left:10px;">Save
          Role</button>
      </div>
    </div>
  </div>

  <!-- Screen: Incoming Call Modal -->
  <div id="screen-incoming" class="modal-overlay hidden">
    <div class="call-popup">
      <img src="https://ui-avatars.com/api/?name=User&background=random" class="caller-avatar">
      <h3 style="margin: 0;">Incoming Call</h3>
      <p style="color: #666; margin-bottom: 20px;" id="callerName">Client Name</p>
      <div>
        <button class="btn-reject" id="btnReject">Reject</button>
        <button class="btn-accept" id="btnAccept">Accept</button>
      </div>
    </div>
  </div>

  <!-- Screen: History -->
  <div id="screen-history" class="modal-overlay hidden">
    <div
      style="background: white; width: 90%; max-width: 400px; height: 80%; border-radius: 20px; display: flex; flex-direction: column; overflow: hidden;">
      <div
        style="padding: 15px; background: var(--bg-body); font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
        <span>Chat History</span>
        <button onclick="document.getElementById('screen-history').classList.add('hidden')"
          style="background: none; border: none; font-size: 1.2rem;"><i class="fas fa-times"></i></button>
      </div>
      <div id="historyList" style="flex: 1; overflow-y: auto; padding: 15px;">
        <!-- History Items -->
      </div>
    </div>
  </div>

  <!-- Screen: Chart Helper -->
  <div id="screen-chart-helper" class="modal-overlay hidden" style="z-index: 3100 !important;">
    <div
      style="background: white; width: 95%; max-width: 500px; height: 90vh; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; overflow: hidden;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="font-weight: bold; font-size: 1.2rem; color: var(--primary);">Birth Chart Calculator</div>
        <i class="fas fa-times" style="font-size: 1.2rem; cursor: pointer;"
          onclick="document.getElementById('screen-chart-helper').classList.add('hidden')"></i>
      </div>
      <!-- Chart content will go here -->
    </div>
  </div>

  <!-- Screen: Profile -->
  <div id="screen-profile" class="modal-overlay hidden">
    <div style="background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 20px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h3 style="margin:0;">Edit Profile</h3>
        <i class="fas fa-times" onclick="document.getElementById('screen-profile').classList.add('hidden')"
          style="cursor:pointer; font-size:1.2rem;"></i>
      </div>

      <div style="text-align:center; margin-bottom:20px;">
        <img id="editAvatar" src=""
          style="width:80px; height:80px; border-radius:50%; object-fit:cover; border:2px solid #ddd; margin-bottom:10px;">
        <br>
        <input type="file" id="fileAvatar" style="display:none" onchange="uploadAvatar(this)">
        <button onclick="document.getElementById('fileAvatar').click()"
          style="padding:5px 10px; font-size:0.8rem; border-radius:5px; border:1px solid #ddd; background:white;">Change
          Photo</button>
      </div>

      <label style="display:block; margin-bottom:5px; font-size:0.9rem; color:#666;">Call Price (â‚¹/min)</label>
      <input id="editPrice" type="number" class="cosmic-input"
        style="background:#f9f9f9; color:black; border:1px solid #ddd;">

      <label style="display:block; margin-bottom:5px; margin-top:15px; font-size:0.9rem; color:#666;">Experience
        (Years)</label>
      <input id="editExp" type="number" class="cosmic-input"
        style="background:#f9f9f9; color:black; border:1px solid #ddd;">

      <button class="cosmic-btn" onclick="saveProfile()">Save Changes</button>
    </div>
  </div>

  <!-- Screen: Session -->
  <div id="screen-session" class="hidden">
    <div class="video-area">
      <video id="remoteVideo" autoplay playsinline></video>
      <video id="localVideo" autoplay muted playsinline></video>
      <div id="sessionInfo" style="position: absolute; top: 20px; left: 20px; color: white;">
        <span id="recIndicator" style="background: red; padding: 2px 8px; border-radius: 4px;">REC</span> <span
          id="sessionTimer">00:00</span>
      </div>
      <div class="controls">
        <button class="circle-btn" style="background: #333;"><i class="fas fa-video"></i></button>
        <button class="circle-btn" style="background: #333;"><i class="fas fa-microphone"></i></button>
        <button class="circle-btn" style="background: #EF4444;" id="btnEnd"><i class="fas fa-phone-slash"></i></button>
      </div>
    </div>

    <!-- Chat Overlay (Visible in all modes, but dominant in Chat Mode) -->
    <div class="chat-overlay"
      style="flex: 1; display:flex; flex-direction:column; background: white; border-top:1px solid #eee;">
      <div id="messagesList" style="flex:1; overflow-y:auto; padding:15px; background:#f9fafb;"></div>
      <div class="chat-input" style="padding:10px; border-top:1px solid #eee; display:flex; gap:10px;">
        <button id="btnChatChart" onclick="showChartHelper()"
          style="display:none; padding:0 12px; height:40px; border-radius:20px; background:#fff; border:1px solid #ddd; color:#d97706; font-weight:600; white-space:nowrap; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
          <i class="fas fa-chart-pie"></i> Birth Chart
        </button>
        <input id="msgInput" style="flex:1; padding:10px; border:1px solid #ddd; border-radius:20px;"
          placeholder="Type Message...">
        <button id="btnSend" style="width:40px; height:40px; border-radius:50%; background:#FFD700; border:none;"><i
            class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
  <script>
    // State
    const state = { me: null, socket: null, session: null, peer: null };

    // Test Sound Function
    window.testSound = () => {
      const audio = new Audio('sound.mpeg');
      audio.volume = 1.0;
      const btn = document.querySelector('button[onclick="testSound()"]');
      const originalText = btn.innerHTML;

      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Playing...';

      audio.play()
        .then(() => {
          setTimeout(() => {
            audio.pause();
            btn.innerHTML = originalText;
          }, 5000);
        })
        .catch(e => {
          alert('Sound Error: ' + e.message + '\nEnsure sound.mpeg is on server.');
          btn.innerHTML = originalText;
        });
    };
    const socket = io();
    state.socket = socket;

    // --- Automatic Reconnection Handling ---
    // If the app disconnects (internet lost, backgrounded), we must re-register on reconnect.
    socket.on('connect', () => {
      console.log('Socket Connected:', socket.id);
      if (state.me) {
        console.log('Re-registering session on reconnect...');
        socket.emit('register', {
          name: state.me.name,
          phone: state.me.phone,
          userId: state.me.userId
        });
      }
    });

    // --- DOM ---
    const sLogin = document.getElementById('screen-login');
    const sClient = document.getElementById('screen-client');
    const sAstro = document.getElementById('screen-astro');
    const sAdmin = document.getElementById('screen-admin');
    const sInc = document.getElementById('screen-incoming');
    const sSes = document.getElementById('screen-session');

    // Login
    document.getElementById('btnSendOtp').onclick = async () => {
      const phone = document.getElementById('inputPhone').value;
      if (!phone) { alert('Enter Phone'); return; }

      const btn = document.getElementById('btnSendOtp');
      const original = btn.textContent;
      btn.textContent = 'Sending...';
      btn.disabled = true;

      try {
        const res = await fetch('/api/send-otp', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone })
        }).then(r => r.json());

        if (res.ok) {
          document.getElementById('step-phone').classList.add('hidden');
          document.getElementById('step-otp').classList.remove('hidden');
        } else {
          alert(res.error || 'Failed');
        }
      } catch (e) { alert('Network Error'); }

      btn.textContent = original;
      btn.disabled = false;
    };
    // Persistent Session Helper
    const SESSION_KEY = 'astro_session';
    const TWO_MONTHS = 60 * 24 * 60 * 60 * 1000;

    function saveSession(user) {
      const session = { ...user, expiresAt: Date.now() + TWO_MONTHS };
      localStorage.setItem(SESSION_KEY, JSON.stringify(session));
    }

    function clearSession() {
      localStorage.removeItem(SESSION_KEY);
      window.location.reload();
    }

    function checkSession() {
      try {
        const saved = localStorage.getItem(SESSION_KEY);
        if (!saved) return;

        const session = JSON.parse(saved);
        if (Date.now() > session.expiresAt) {
          localStorage.removeItem(SESSION_KEY);
          return;
        }

        // Auto Login
        console.log('Restoring session for:', session.name);
        state.me = session;
        // We emit register again to ensure server knows we are online/connected socket-wise
        socket.emit('register', { name: session.name, phone: session.phone, userId: session.userId }, (ack) => {
          sLogin.classList.add('hidden');
          if (session.role === 'astrologer') loadAstroDash(session);
          else if (session.role === 'superadmin') loadAdminDash(session);
          else loadClientDash(session);
        });

      } catch (e) { console.error('Session Error', e); }
    }

    // Auto-check on load (after socket connects usually, but here is fine immediately)
    // We wait for socket connect actually? No, we can emit register, it buffers if not connected,
    // BUT socket.id is needed in some server logic.
    // Best to call checkSession inside socket.on('connect')?
    // Let's call it immediately; socket.io client buffers packets.

    // --- Login Handlers ---
    document.getElementById('btnVerifyOtp').onclick = async () => {
      const phone = document.getElementById('inputPhone').value;
      const otp = document.getElementById('inputOtp').value;
      const res = await fetch('/api/verify-otp', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone, otp })
      }).then(r => r.json());

      if (res.ok) {
        state.me = res;
        saveSession(res); // Save to LocalStorage

        socket.emit('register', { name: res.name, phone: phone }, (ack) => {
          sLogin.classList.add('hidden');
          if (res.role === 'astrologer') {
            loadAstroDash(res);
          } else if (res.role === 'superadmin') {
            loadAdminDash(res);
          } else {
            loadClientDash(res);
          }
        });
      } else {
        alert('Invalid Login');
      }
    };

    // Call Check Session
    checkSession();

    // --- Astrologer Dash Logic ---
    function loadAstroDash(user) {
      sAstro.classList.remove('hidden');
      document.getElementById('astroName').textContent = user.name;
      document.getElementById('astroId').textContent = user.userId.slice(0, 6);
      document.getElementById('astroAvatar').src = `https://ui-avatars.com/api/?name=${user.name}&background=random`;

      // Setup Toggles
      setupToggle('toggleChat', 'chat');
      setupToggle('toggleCall', 'audio');
      setupToggle('toggleVideo', 'video');

      if (user.image) {
        document.getElementById('astroAvatar').src = user.image;
        document.getElementById('astroAvatar').onerror = function () {
          this.onerror = null;
          this.src = `https://ui-avatars.com/api/?name=${user.name}&background=random`;
        };
      }
    }

    // --- Profile Logic ---
    let tempAvatarUrl = '';

    function showProfile() {
      const u = state.me;
      document.getElementById('editAvatar').src = u.image || `https://ui-avatars.com/api/?name=${u.name}&background=random`;
      document.getElementById('editPrice').value = u.price || 20;
      document.getElementById('editExp').value = u.experience || 0;
      document.getElementById('screen-profile').classList.remove('hidden');
    }

    async function uploadAvatar(input) {
      if (!input.files[0]) return;
      const formData = new FormData();
      formData.append('file', input.files[0]);

      const btn = input.nextElementSibling; // The button
      const oldText = btn.textContent;
      btn.textContent = 'Uploading...';

      try {
        const res = await fetch('/upload', { method: 'POST', body: formData }).then(r => r.json());
        if (res.ok) {
          tempAvatarUrl = res.url;
          document.getElementById('editAvatar').src = res.url;
          btn.textContent = 'Uploaded';
          setTimeout(() => btn.textContent = 'Change Photo', 2000);
        } else {
          alert('Upload Failed');
          btn.textContent = oldText;
        }
      } catch (e) {
        alert('Error uploading');
        btn.textContent = oldText;
      }
    }

    function saveProfile() {
      const price = document.getElementById('editPrice').value;
      const exp = document.getElementById('editExp').value;

      const update = { price, experience: exp };
      if (tempAvatarUrl) update.image = tempAvatarUrl;

      socket.emit('update-profile', update, (res) => {
        if (res.ok) {
          state.me = res.user;
          saveSession(res.user); // Update local storage
          alert('Saved!');
          document.getElementById('screen-profile').classList.add('hidden');
          // Update Dash
          if (state.me.image) document.getElementById('astroAvatar').src = state.me.image;
        } else {
          alert(res.error || 'Failed');
        }
      });
    }

    // --- History Logic ---
    function showHistory() {
      const modal = document.getElementById('screen-history');
      const list = document.getElementById('historyList');
      list.innerHTML = '<div style="text-align:center; margin-top:20px;">Loading...</div>';
      modal.classList.remove('hidden');

      socket.emit('get-history', (res) => {
        if (!res.ok || !res.sessions) {
          list.innerHTML = '<div style="text-align:center; color:red;">Failed to load.</div>';
          return;
        }

        if (res.sessions.length === 0) {
          list.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">No History Found</div>';
          return;
        }

        list.innerHTML = '';
        res.sessions.forEach(s => {
          const date = new Date(s.startTime).toLocaleString();
          const dura = s.duration ? Math.round(s.duration / 1000) + 's' : 'Ongoing/Failed';
          const isMe = s.fromUserId === state.me.userId;
          const otherId = isMe ? s.toUserId : s.fromUserId;

          const item = document.createElement('div');
          item.style = 'background: #f9f9f9; padding: 10px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #FFD700;';
          item.innerHTML = `
                <div style="font-weight:bold; font-size:0.9rem;">${s.type.toUpperCase()}</div>
                <div style="font-size:0.8rem; color:#555;">ID: ${otherId ? otherId.slice(0, 6) : 'Unknown'}</div>
                <div style="font-size:0.75rem; color:#999; display:flex; justify-content:space-between; margin-top:5px;">
                   <span>${date}</span>
                   <span>${dura}</span>
                </div>
             `;
          list.appendChild(item);
        });
      });
    }

    function setupToggle(id, type) {
      const el = document.getElementById(id);
      el.onclick = () => {
        el.classList.toggle('active');
        const isOnline = el.classList.contains('active');
        // Update Server
        socket.emit('toggle-status', { online: isOnline, type: type });
      };
    }

    // --- Client Dash Logic ---
    function loadClientDash(user) {
      sClient.classList.remove('hidden');
      document.getElementById('clientWallet').innerText = user.walletBalance || 0;

      fetchAstrologers();

      socket.on('astrologer-update', (list) => {
        renderAstroList(list);
      });

      socket.on('wallet-update', (data) => {
        document.getElementById('clientWallet').innerText = data.balance;
        state.me.walletBalance = data.balance;
        saveSession(state.me); // Update persistent session
      });
    }

    function fetchAstrologers() {
      socket.emit('get-astrologers', (res) => {
        renderAstroList(res.astrologers);
      });
    }

    function renderAstroList(list) {
      const container = document.getElementById('astroList');
      container.innerHTML = '';
      list.forEach(a => {
        const div = document.createElement('div');
        div.className = 'astro-card';
        // Style for action buttons
        const btnStyle = (active, color) => `
             background: ${active ? 'white' : '#f3f4f6'};
             border: 1px solid ${active ? color : '#ddd'};
             color: ${active ? color : '#999'};
             width: 35px; height: 35px; border-radius: 8px; cursor: pointer;
             display: flex; align-items: center; justify-content: center;
             pointer-events: ${active ? 'auto' : 'none'};
             opacity: ${active ? '1' : '0.5'};
          `;

        div.innerHTML = `
             <div style="position: relative;">
               <img src="${a.image || 'https://ui-avatars.com/api/?name=' + a.name + '&background=random'}" class="astro-img" style="object-fit:cover;">
               <div class="status-dot ${a.isOnline ? 'online' : ''}"></div>
             </div>
             <div style="flex: 1;">
               <div style="display:flex; justify-content:space-between;">
                 <div style="font-weight: bold;">${a.name}</div>
                 <div style="font-size:0.8rem; font-weight:bold;">â‚¹${a.price}/min</div>
               </div>
               <div style="font-size: 0.8rem; color: #666; margin-bottom: 2px;">${a.skills.join(', ')}</div>
               <div style="font-size: 0.75rem; color: #888; margin-bottom: 8px;">
                 ${a.experience ? `Exp: ${a.experience} Yrs` : 'New Astrologer'}
               </div>

               <div style="display:flex; gap: 10px;">
                  <button onclick="requestSession('${a.userId}', 'chat')" style="${btnStyle(a.isChatOnline, '#3B82F6')}">
                     <i class="fas fa-comment-alt"></i>
                  </button>
                  <button onclick="requestSession('${a.userId}', 'audio')" style="${btnStyle(a.isAudioOnline, '#22C55E')}">
                     <i class="fas fa-phone-alt"></i>
                  </button>
                  <button onclick="requestSession('${a.userId}', 'video')" style="${btnStyle(a.isVideoOnline, '#F59E0B')}">
                     <i class="fas fa-video"></i>
                  </button>
               </div>
             </div>
          `;
        container.appendChild(div);
      });
    }

    // --- P2P / Call Logic ---
    window.requestSession = (targetId, type) => {
      const titles = { chat: 'Chat', audio: 'Audio Call', video: 'Video Call' };
      // Show Modal
      const modal = document.createElement('div');
      modal.id = 'calling-modal';
      modal.className = 'modal-overlay';
      modal.innerHTML = `
          <div class="call-popup" style="background:white; padding:20px; border-radius:15px; text-align:center;">
             ${type !== 'chat' ? `<div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid ${type === 'chat' ? '#3B82F6' : type === 'audio' ? '#22C55E' : '#F59E0B'}; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 15px;"></div>` : ''}
             <h3>Requesting ${titles[type]}...</h3>
             <button onclick="document.getElementById('calling-modal').remove()" style="margin-top:10px; padding:8px 20px; border-radius:8px; border:none; background:#ccc;">Cancel</button>
          </div>
       `;
      document.body.appendChild(modal);

      socket.emit('request-session', { toUserId: targetId, type }, (res) => {
        if (res.ok) {
          initSession(res.sessionId, targetId, type, true);
          document.getElementById('calling-modal').remove();
        } else {
          document.getElementById('calling-modal').remove();
          alert('Request failed: ' + res.error);
        }
      });
    };

    socket.on('incoming-session', (data) => {
      if (state.session) {
        socket.emit('answer-session', { sessionId: data.sessionId, toUserId: data.fromUserId, accept: false });
        return;
      }
      sInc.classList.remove('hidden');
      const titles = { chat: 'Chat Request', audio: 'Incoming Call', video: 'Incoming Video Call' };
      document.getElementById('callerName').innerHTML = `
           <strong>${titles[data.type]}</strong><br>Client ${data.fromUserId.slice(0, 4)}
       `;

      // Play Sound
      try {
        if (window.incomingAudio) { window.incomingAudio.pause(); window.incomingAudio = null; }
        const soundUrl = 'sound.mpeg';
        window.incomingAudio = new Audio(soundUrl);
        window.incomingAudio.loop = true;
        window.incomingAudio.play().catch(e => console.log('Autoplay blocked:', e));
      } catch (e) { console.error('Sound Error', e); }

      document.getElementById('btnAccept').onclick = () => {
        if (window.incomingAudio) { window.incomingAudio.pause(); window.incomingAudio = null; }
        sInc.classList.add('hidden');
        socket.emit('answer-session', { sessionId: data.sessionId, toUserId: data.fromUserId, type: data.type, accept: true });
        initSession(data.sessionId, data.fromUserId, data.type, false);
      };
      document.getElementById('btnReject').onclick = () => {
        if (window.incomingAudio) { window.incomingAudio.pause(); window.incomingAudio = null; }
        sInc.classList.add('hidden');
        socket.emit('answer-session', { sessionId: data.sessionId, toUserId: data.fromUserId, accept: false });
      };
    });

    socket.on('session-answered', (data) => {
      if (data.accept) {
        if (state.session.type === 'chat') {
          startTimer();
        } else {
          startWebRTC(true);
        }
      } else {
        alert('Request Rejected');
        sSes.classList.add('hidden');
        state.session = null;
      }
    });

    // --- Timer Logic ---
    let timerInt = null;
    let timerSec = 0;

    function startTimer() {
      if (timerInt) return;
      timerSec = 0;
      updateTimerDisplay();
      timerInt = setInterval(() => {
        timerSec++;
        updateTimerDisplay();
      }, 1000);
    }

    function stopTimer() {
      if (timerInt) {
        clearInterval(timerInt);
        timerInt = null;
      }
    }

    function updateTimerDisplay() {
      const m = Math.floor(timerSec / 60).toString().padStart(2, '0');
      const s = (timerSec % 60).toString().padStart(2, '0');
      document.getElementById('sessionTimer').innerText = `${m}:${s}`;
    }

    // --- Session / WebRTC ---
    function initSession(sid, pid, type, isInit) {
      // Clear previous chat
      document.getElementById('messagesList').innerHTML = '';

      state.session = { id: sid, partnerId: pid, type };
      sSes.classList.remove('hidden');

      // NEW: Show Chat Chart Button for Astrologer
      if (state.me && state.me.role === 'astrologer') {
        const btn = document.getElementById('btnChatChart');
        if (btn) btn.style.display = 'block';
      } else {
        const btn = document.getElementById('btnChatChart');
        if (btn) btn.style.display = 'none';
      }

      if (type !== 'chat') {
        if (document.getElementById('connectionStatus')) {
          document.getElementById('connectionStatus').classList.remove('hidden');
        } else {
          const d = document.createElement('div');
          d.id = 'connectionStatus';
          d.style = 'position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,0.7); z-index:1001; backdrop-filter:blur(5px);';
          d.innerHTML = `
          <div class="loader-spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
            <div style="margin-top:15px; color:white; font-size:1.1rem; font-weight:500;">Connecting...</div>
            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
        `;
          sSes.appendChild(d);
        }
      } else {
        // Ensure loader is hidden for chat
        if (document.getElementById('connectionStatus')) {
          document.getElementById('connectionStatus').classList.add('hidden');
        }
      }

      // Start timer if Receiver AND Chat.
      // For A/V, we wait for stream connection (handled in startWebRTC -> stream event)
      if (!isInit && type === 'chat') {
        startTimer();
      }

      // UI Mode
      const vArea = document.querySelector('.video-area');
      const localV = document.getElementById('localVideo');
      const remoteV = document.getElementById('remoteVideo');
      const controls = document.querySelector('.controls');

      const sessionInfo = document.getElementById('sessionInfo');
      const recInd = document.getElementById('recIndicator');
      const timer = document.getElementById('sessionTimer');

      // Reset Timer UI immediately
      timer.innerText = '00:00';
      timerSec = 0;

      // Reset Styles first
      vArea.style = '';
      localV.style.display = '';
      remoteV.style.display = '';
      controls.style.display = '';

      // Reset Info Bar
      sessionInfo.style.position = 'absolute';
      sessionInfo.style.top = '20px';
      sessionInfo.style.left = '20px';
      sessionInfo.style.display = 'block';
      sessionInfo.style.color = 'white';
      recInd.style.display = 'inline';
      timer.style.color = 'white';


      if (type === 'chat') {
        // === CHAT MODE ===
        vArea.style.height = '60px';
        vArea.style.flex = '0 0 60px';
        vArea.style.background = '#FFFFFF';
        vArea.style.borderBottom = '1px solid #ddd';
        vArea.style.display = 'flex';
        vArea.style.alignItems = 'center';
        vArea.style.justifyContent = 'space-between';
        vArea.style.padding = '0 15px';

        localV.style.display = 'none';
        remoteV.style.display = 'none';
        controls.classList.add('hidden');

        // Hide REC
        recInd.style.display = 'none';

        // Style Info Bar for Header
        sessionInfo.style.position = 'static';
        sessionInfo.style.color = 'black';
        timer.style.color = 'black';
        timer.style.fontWeight = 'bold';
        timer.style.fontSize = '1.1rem';

        // Ensure End Button Exists
        let btnEndTitle = document.getElementById('btnEndChat');
        if (!btnEndTitle) {
          const btn = document.createElement('button');
          btn.id = 'btnEndChat';
          btn.innerHTML = 'End Chat';
          btn.style = 'background:#EF4444; color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:bold; cursor:pointer; font-size:0.9rem;';
          btn.onclick = () => document.getElementById('btnEnd').click();
          vArea.appendChild(btn);
        } else {
          btnEndTitle.style.display = 'block';
        }

      } else {
        // === AUDIO / VIDEO MODE ===
        if (document.getElementById('btnEndChat')) document.getElementById('btnEndChat').style.display = 'none';
        controls.classList.remove('hidden');

        if (type === 'audio') {
          vArea.style.height = '250px';
          vArea.style.flex = '0 0 250px';
          vArea.style.background = '#1F2937';
          localV.style.display = 'none';
          remoteV.style.display = 'none';
          timer.style.color = 'white';
        } else {
          vArea.style.flex = '1';
          vArea.style.background = 'black';
          localV.style.display = 'block';
          remoteV.style.display = 'block';
          timer.style.color = 'white';
        }
      }

      if (!isInit && type !== 'chat') startWebRTC(false);
    }

    async function startWebRTC(initiator) {
      if (state.session.type === 'chat') return; // No AV for chat only mode in this demo

      // Check for MediaDevices support (Secure Context required)
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Camera/Mic access failed. \n\nIMPORTANT: Browsers block camera access on insecure connections (HTTP).\n\nPlease try:\n1. Use 'localhost' instead of IP address.\n2. Or set up HTTPS.");
        const loader = document.getElementById('connectionStatus');
        if (loader) loader.classList.add('hidden');
        return;
      }

      try {
        const constraints = {
          audio: true,
          video: state.session.type === 'video'
        };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);

        // UI Feedback
        if (state.session.type === 'video') {
          document.getElementById('localVideo').srcObject = stream;
        }

        const p = new SimplePeer({ initiator, stream, trickle: false });
        // Emit signal when generated
        p.on('signal', d => {
          if (state.session) {
            socket.emit('signal', { sessionId: state.session.id, toUserId: state.session.partnerId, signal: d });
          }
        });

        p.on('stream', s => {
          // Remove Connecting UI
          const loader = document.getElementById('connectionStatus');
          if (loader) loader.classList.add('hidden');

          const rv = document.getElementById('remoteVideo');
          rv.srcObject = s;
          if (state.session.type === 'audio') {
            rv.style.opacity = 0; // Hide video element but keep audio
          } else {
            rv.style.opacity = 1;
          }
          startTimer(); // Start Timer when stream is received/connected
        });

        // Error handling
        p.on('error', err => {
          console.error('Peer Error', err);
          // alert('Connection Failed: ' + err.message);
        });

        // Do NOT add socket.on('signal') here. Defined globally.
        state.peer = p;
        state.localStream = stream;
      } catch (e) {
        console.error(e);
        alert('Device Error: ' + e.message);
        const loader = document.getElementById('connectionStatus');
        if (loader) loader.textContent = 'Error: ' + e.message;
      }
    }

    // --- Global Signal Listener ---
    // Moved outside to prevent duplicate listeners on multiple calls
    socket.on('signal', d => {
      if (state.session && d.sessionId === state.session.id && state.peer) {
        state.peer.signal(d.signal);
      }
    });




    // End session button: notify server, set astrologer online, and clean up
    // End session button: notify server and clean up
    document.getElementById('btnEnd').onclick = () => {
      // Notify server that the session has ended
      if (state.session) {
        socket.emit('session-ended', { sessionId: state.session.id, toUserId: state.session.partnerId });
      }
      // Clean up local resources and UI
      endLocal();
    };
    // Listen for session-ended events from server
    socket.on('session-ended', endLocal);

    // Update endLocal to stop timer and reset status
    function endLocal() {
      // Ensure Astrologer is marked as available when session ends
      if (state.me && state.me.role === 'astrologer') {
        socket.emit('toggle-status', { online: true, type: 'online' });
      }
      stopTimer(); // STOP TIMER
      if (state.peer) { state.peer.destroy(); state.peer = null; }
      if (state.localStream) {
        state.localStream.getTracks().forEach(t => t.stop());
        state.localStream = null;
        document.getElementById('localVideo').srcObject = null;
      }
      sSes.classList.add('hidden');
      state.session = null;
      // ... existing resets
      document.querySelector('.video-area').style = '';
      document.getElementById('localVideo').srcObject = null;
      document.querySelector('.controls').classList.remove('hidden');
    }

    // --- Chat Logic ---
    const appendMsg = (txt, isMe) => {
      const div = document.createElement('div');
      div.style.maxWidth = '80%';
      div.style.padding = '8px 12px';
      div.style.borderRadius = '12px';
      div.style.marginBottom = '8px';
      div.style.fontSize = '0.9rem';
      div.style.alignSelf = isMe ? 'flex-end' : 'flex-start';
      div.style.background = isMe ? '#FFD700' : 'white';
      div.style.border = isMe ? 'none' : '1px solid #eee';
      div.style.color = 'black';
      div.style.marginLeft = isMe ? 'auto' : '0';
      div.textContent = txt;
      document.getElementById('messagesList').appendChild(div);
      document.getElementById('messagesList').scrollTop = document.getElementById('messagesList').scrollHeight;
    };

    document.getElementById('btnSend').onclick = () => {
      const txt = document.getElementById('msgInput').value.trim();
      if (!txt) return;
      socket.emit('chat-message', {
        toUserId: state.session.partnerId, sessionId: state.session.id,
        content: { type: 'text', text: txt }, messageId: Date.now()
      });
      appendMsg(txt, true);
      document.getElementById('msgInput').value = '';
    };

    socket.on('chat-message', d => {
      if (state.session && d.fromUserId === state.session.partnerId) {
        appendMsg(d.content.text || 'Message', false);
      }
    });

    // --- Admin Dashboard Logic ---
    let adminUsersCache = [];

    function loadAdminDash(user) {
      sAdmin.classList.remove('hidden');
      refreshAdminData();
    }

    function refreshAdminData() {
      socket.emit('get-all-users', (res) => {
        if (res.ok) {
          adminUsersCache = res.users;
          renderAdminUsers(res.users);
          updateAdminStats(res.users);
        } else {
          alert('Failed to load users');
        }
      });
    }

    function updateAdminStats(users) {
      document.getElementById('adminTotalUsers').textContent = users.length;
      const active = users.filter(u => u.isOnline).length;
      document.getElementById('adminActiveUsers').textContent = active;
    }

    function renderAdminUsers(users) {
      const list = document.getElementById('adminUserList');
      list.innerHTML = '';

      users.forEach(u => {
        const div = document.createElement('div');
        div.className = 'admin-card';
        div.innerHTML = `
          < div class="admin-user-header" >
            <div style="font-weight:bold;">
              ${u.name} <span class="user-pill">${u.role}</span>
              ${u.isBanned ? '<span class="user-pill" style="background:#fee2e2; color:#b91c1c;">Banned</span>' : ''}
            </div>
            <div style="font-size:0.8rem;">â‚¹${u.walletBalance}</div>
          </div >
          <div style="font-size:0.8rem; color:#666;">
            Phone: ${u.phone || 'N/A'}<br>
            ID: ${u.userId.slice(0, 8)}...
          </div>
          <div class="admin-actions">
            <button class="btn-admin btn-wallet" onclick="adminWallet('${u.userId}')">Add â‚¹</button>
            <button class="btn-admin btn-role" onclick="adminRole('${u.userId}', '${u.role}')">Role</button>
            <button class="btn-admin btn-block" onclick="adminBan('${u.userId}', ${!u.isBanned})">
              ${u.isBanned ? 'Unblock' : 'Block'}
            </button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    window.adminWallet = (uid) => {
      const amt = prompt("Enter amount to ADD (e.g., 100):");
      if (amt && !isNaN(amt)) {
        socket.emit('admin-add-wallet', { userId: uid, amount: amt }, (res) => {
          if (res.ok) { alert('Wallet Updated'); refreshAdminData(); }
          else alert('Failed');
        });
      }
    };

    // Role Change State
    let roleChangeTargetId = null;

    window.adminRole = (uid, currentRole) => {
      roleChangeTargetId = uid;
      document.getElementById('adminRoleSelect').value = currentRole;
      document.getElementById('screen-admin-role-modal').classList.remove('hidden');
    };

    window.submitAdminRoleChange = () => {
      if (!roleChangeTargetId) return;
      const newRole = document.getElementById('adminRoleSelect').value;

      socket.emit('admin-update-role', { userId: roleChangeTargetId, role: newRole }, (res) => {
        if (res.ok) {
          alert('Role Updated');
          document.getElementById('screen-admin-role-modal').classList.add('hidden');
          refreshAdminData();
        } else {
          alert('Failed to update role');
        }
      });
    };

    window.adminBan = (uid, doBan) => {
      if (confirm(doBan ? 'Block this user?' : 'Unblock this user?')) {
        socket.emit('admin-toggle-ban', { userId: uid, isBanned: doBan }, (res) => {
          if (res.ok) { alert(doBan ? 'User Blocked' : 'User Unblocked'); refreshAdminData(); }
          else alert('Failed');
        });
      }
    };

    // Force Logout Listener
    socket.on('force-logout', () => {
      alert('Your account has been suspended by Admin.');
      clearSession();
    });


    // --- Geolocation & City Search Logic ---
    window.useCurrentLocation = function () {
      if (!navigator.geolocation) return alert("Geolocation not supported");

      const btn = document.querySelector('button[onclick="useCurrentLocation()"]');
      const icon = btn.querySelector('i');
      const oldClass = icon.className;

      icon.className = "fas fa-spinner fa-spin";

      navigator.geolocation.getCurrentPosition(async (Pos) => {
        const lat = Pos.coords.latitude;
        const lon = Pos.coords.longitude;

        document.getElementById('chartLat').value = lat.toFixed(4);
        document.getElementById('chartLon').value = lon.toFixed(4);

        // Reverse Geocode
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
          const data = await res.json();
          if (data && data.display_name) {
            const parts = data.display_name.split(',');
            document.getElementById('citySearch').value = parts[0] + (parts[1] ? ',' + parts[1] : '');
          } else {
            document.getElementById('citySearch').value = "Current Location";
          }
        } catch (e) {
          document.getElementById('citySearch').value = "Ky Coordinates";
        }

        icon.className = "fas fa-check";
        setTimeout(() => icon.className = oldClass, 2000);

      }, (err) => {
        alert("Location Access Denied: " + err.message);
        icon.className = oldClass;
      });
    };

    // City Search Auto-Complete
    (function () {
      const inp = document.getElementById('citySearch');
      const res = document.getElementById('cityResults');
      let t;
      if (inp) {
        inp.addEventListener('input', e => {
          const v = e.target.value.trim();
          if (v.length < 3) { res.style.display = 'none'; return; }
          clearTimeout(t);
          t = setTimeout(async () => {
            res.innerHTML = '<div style="padding:10px; color:#666;">Searching...</div>';
            res.style.display = 'block';
            try {
              const req = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=15&q=${encodeURIComponent(v)}`);
              const data = await req.json();
              res.innerHTML = '';
              if (!data.length) { res.innerHTML = '<div style="padding:10px; color:#999;">No results</div>'; return; }

              // SORT LOGIC
              data.sort((a, b) => {
                const nA = a.display_name.toLowerCase();
                const nB = b.display_name.toLowerCase();
                let sA = 0; if (nA.includes("tamil nadu")) sA += 100; else if (nA.includes("india")) sA += 50;
                let sB = 0; if (nB.includes("tamil nadu")) sB += 100; else if (nB.includes("india")) sB += 50;
                return sB - sA;
              });

              data.forEach(p => {
                const d = document.createElement('div');
                d.innerText = p.display_name;
                d.style.padding = '10px';
                d.style.borderBottom = '1px solid #f0f0f0';
                d.style.cursor = 'pointer';
                d.style.fontSize = '0.85rem';
                d.onmouseover = () => d.style.background = '#f3f4f6';
                d.onmouseout = () => d.style.background = 'white';
                d.onclick = () => {
                  document.getElementById('chartLat').value = p.lat;
                  document.getElementById('chartLon').value = p.lon;
                  const parts = p.display_name.split(',');
                  inp.value = parts[0] + (parts[1] ? ',' + parts[1] : '');
                  res.style.display = 'none';
                };
                res.appendChild(d);
              });
            } catch (e) { res.style.display = 'none'; }
          }, 500);
        });
        document.addEventListener('click', e => { if (e.target !== inp && e.target !== res) res.style.display = 'none'; });
      }
    })();

    // --- Chart Logic ---
    function showChartHelper() {
      document.getElementById('screen-chart-helper').classList.remove('hidden');
      // Set default date/time now
      const now = new Date();
      document.getElementById('chartDate').value = now.toISOString().split('T')[0];
      document.getElementById('chartTime').value = now.toTimeString().slice(0, 5);
    }

    function switchChartTab(tab) {
      document.querySelectorAll('.chart-tab-content').forEach(d => d.classList.add('hidden'));
      document.querySelectorAll('.c-tab').forEach(b => b.classList.remove('active'));

      document.getElementById('content-' + tab).classList.remove('hidden');
      document.getElementById('tab-' + tab).classList.add('active');
    }

    function resetChart() {
      document.getElementById('chartInputSection').style.display = 'block';
      document.getElementById('chartResults').style.display = 'none';
      document.getElementById('chartLoading').style.display = 'none';
    }

    async function fetchChart() {
      const date = document.getElementById('chartDate').value;
      const time = document.getElementById('chartTime').value;
      const lat = document.getElementById('chartLat').value;
      const lon = document.getElementById('chartLon').value;

      if (!date || !time) return alert("Select Date & Time");

      document.getElementById('chartInputSection').style.display = 'none';
      document.getElementById('chartLoading').style.display = 'block';
      document.getElementById('chartResults').style.display = 'none';

      const [y, m, d] = date.split('-');
      const [h, min] = time.split(':');

      try {
        const res = await fetch('/api/astrology/complete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            year: y, month: m, day: d, hour: h, minute: min, lat, lon
          })
        }).then(r => r.json());

        if (res.error) throw new Error(res.error);

        // Wait a sec for effect
        setTimeout(() => {
          renderChartResults(res);
          document.getElementById('chartLoading').style.display = 'none';
          document.getElementById('chartResults').style.display = 'flex'; // Flex for vertical layout
        }, 800);

      } catch (e) {
        alert("Error: " + e.message);
        document.getElementById('chartLoading').style.display = 'none';
        document.getElementById('chartInputSection').style.display = 'block';
      }
    }

    function renderChartResults(data) {
      // 1. Basic Planets
      const pList = document.getElementById('planetList');
      pList.innerHTML = '';
      const planets = data.planetaryPositions.detailed;

      for (let p in planets) {
        const info = planets[p];
        const div = document.createElement('div');
        div.className = 'planet-item';
        div.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center">
    <b>${p}</b>
    <span style="background:#e5e7eb; padding:2px 8px; border-radius:10px; font-size:0.75rem;">${info.sign}</span>
  </div>
          <div style="margin-top:5px; font-size:0.85rem; color:#555;">
            ${info.degree.toFixed(2)}Â° | ${info.nakshatra}
          </div>`;
        pList.appendChild(div);
      }

      // 2. Rasi Charts (D1 & D9)
      function renderSouthGrid(containerId, planetDataKey) {
        const chartData = data[planetDataKey].planets;

        // Aggregate planets by sign
        const signs = ['Aries', 'Taurus', 'Gemini', 'Cancer', 'Leo', 'Virgo', 'Libra', 'Scorpio', 'Sagittarius', 'Capricorn',
          'Aquarius', 'Pisces'];
        const signPlanets = {};
        signs.forEach(s => signPlanets[s] = []);

        for (let p in chartData) {
          // Determine sign from planet object
          const pObj = chartData[p];
          if (pObj && pObj.sign) {
            signPlanets[pObj.sign].push(p.substr(0, 2));
          }
        }

        // For Rasi D1, add Ascendant if available
        if (planetDataKey === 'rasiChart' && data.ascendant) {
          signPlanets[data.ascendant.sign].push("<span class='asc-badge'>ASC</span>");
        }

        const grid = document.getElementById(containerId);
        grid.innerHTML = '';
        // className is already set in HTML to 'south-indian-chart'

        // Static South Indian Mapping (Row-Major index 0-15)
        // 0: Pisces, 1: Aries, 2: Taurus, 3: Gemini
        // 4: Aquarius, 7: Cancer
        // 8: Capricorn, 11: Leo
        // 12: Sagittarius, 13: Scorpio, 14: Libra, 15: Virgo
        // Center : 5, 6, 9, 10 -> Null/Empty

        const cellMap = [
          'Pisces', 'Aries', 'Taurus', 'Gemini',
          'Aquarius', null, null, 'Cancer',
          'Capricorn', null, null, 'Leo',
          'Sagittarius', 'Scorpio', 'Libra', 'Virgo'
        ];
        // Tamil Sign Mapping
        const tamilSigns = {
          'Aries': 'à®®à¯‡à®·à®®à¯ (Mesham)',
          'Taurus': 'à®°à®¿à®·à®ªà®®à¯ (Rishabam)',
          'Gemini': 'à®®à®¿à®¤à¯à®©à®®à¯ (Mithunam)',
          'Cancer': 'à®•à®Ÿà®•à®®à¯ (Katagam)',
          'Leo': 'à®šà®¿à®®à¯à®®à®®à¯ (Simmam)',
          'Virgo': 'à®•à®©à¯à®©à®¿ (Kanni)',
          'Libra': 'à®¤à¯à®²à®¾à®®à¯ (Thulaam)',
          'Scorpio': 'à®µà®¿à®°à¯à®šà¯à®šà®¿à®•à®®à¯ (Virul)',
          'Sagittarius': 'à®¤à®©à¯à®šà¯ (Dhanusu)',
          'Capricorn': 'à®®à®•à®°à®®à¯ (Makaram)',
          'Aquarius': 'à®•à¯à®®à¯à®ªà®®à¯ (Kumbam)',
          'Pisces': 'à®®à¯€à®©à®®à¯ (Meenum)'
        };

        const tamilPlanets = {
          'Sun': 'à®šà¯‚à®°à®¿à®¯à®©à¯', 'Moon': 'à®šà®¨à¯à®¤à®¿à®°à®©à¯', 'Mars': 'à®šà¯†à®µà¯à®µà®¾à®¯à¯',
          'Mercury': 'à®ªà¯à®¤à®©à¯', 'Jupiter': 'à®•à¯à®°à¯', 'Venus': 'à®šà¯à®•à¯à®•à®¿à®°à®©à¯',
          'Saturn': 'à®šà®©à®¿', 'Rahu': 'à®°à®¾à®•à¯', 'Ketu': 'à®•à¯‡à®¤à¯', 'Ascendant': 'à®²à®•à¯à®©à®®à¯', 'ASC': 'à®²à®•à¯à®©à®®à¯'
        };

        cellMap.forEach((sign, idx) => {
          const div = document.createElement('div');
          div.className = 'SouthChartBox';

          if (!sign) {
            // Center box
            div.setAttribute('data-center', 'true');
            div.style.border = 'none';
            div.style.background = 'transparent';

            if (idx === 5) {
              div.style.gridColumn = "2 / span 2";
              div.style.gridRow = "2 / span 2";
              div.style.display = "flex";
              div.style.alignItems = "center";
              div.style.justifyContent = "center";
              div.innerHTML = '<img src="/images/ganesha.png" style="width:80%; height:auto;" alt="Pillayar">';
            } else if (idx === 6 || idx === 9 || idx === 10) {
              div.style.display = 'none';
            }

          } else {
            const rawPlanets = signPlanets[sign];

            const codeMap = {
              'Su': 'à®šà¯‚à®°à®¿à®¯à®©à¯', 'Mo': 'à®šà®¨à¯à®¤à®¿à®°à®©à¯', 'Ma': 'à®šà¯†à®µà¯à®µà®¾à®¯à¯', 'Me': 'à®ªà¯à®¤à®©à¯',
              'Ju': 'à®•à¯à®°à¯', 'Ve': 'à®šà¯à®•à¯à®•à®¿à®°à®©à¯', 'Sa': 'à®šà®©à®¿', 'Ra': 'à®°à®¾à®•à¯', 'ke': 'à®•à¯‡à®¤à¯', 'Ke': 'à®•à¯‡à®¤à¯'
            };

            const tamilContent = rawPlanets.map(p => {
              if (p.includes('badge')) return "<span class='asc-badge'>à®²à®•à¯à®©à®®à¯</span>";
              return codeMap[p] || tamilPlanets[p] || p;
            }).join('<br>');

            const tamilName = tamilSigns[sign] || sign;

            div.innerHTML = `<span class="s-sign-label" title="${tamilSigns[sign] || sign}" style="font-size:0.7rem; color:#d97706; font-weight:bold;">${tamilName.split(' ')[0]}</span>
          <div class="s-planet-text" style="font-size:0.85rem; line-height:1.4;">${tamilContent}</div>`;
          }
          if (div.style.display !== 'none') grid.appendChild(div);
        });
      }


      renderSouthGrid('southChart', 'rasiChart');
      renderSouthGrid('navamsaChart', 'navamsaChart');

      // Initialize jQuery UI Tooltips
      try {
        $('.s-sign-label').tooltip({
          position: { my: "center bottom-10", at: "center top" },
          show: { effect: "fade", duration: 200 },
          hide: { effect: "fade", duration: 100 }
        });
      } catch (e) { console.warn("jQuery Tooltip failed", e); }

      // 3. Dasha
      const curr = data.dashaSystem.current;
      document.getElementById('currentDashaInfo').innerHTML =
        `<div style="font-size:0.8rem; text-transform:uppercase; color:#888; letter-spacing:1px; margin-bottom:5px;">Current
    Period</div>
  <div style="font-size:1.4rem; font-weight:bold; color:var(--primary); margin-bottom:5px;">
    ${curr.mahadasha.lord} <span style="color:#ccc;">/</span> ${curr.bhukti.lord}
  </div>
  <div style="font-size:0.9rem; color:#555;">
    <i class="fas fa-hourglass-end"></i> Ends: <b>${curr.bhukti.end}</b>
  </div>`;

      const dList = document.getElementById('dashaList');
      dList.innerHTML = '';
      data.dashaSystem.sequence.forEach(m => {
        const row = document.createElement('div');
        // Check if current
        if (m.lord === curr.mahadasha.lord) {
          row.style.background = '#ECFDF5';
          row.style.border = '1px solid var(--border)';
        }

        row.innerHTML = `<div>
    <div style='font-weight:bold; color:#1F2937;'>${m.lord}</div>
    <div style='font-size:0.75rem; color:#9CA3AF;'>${m.years} Years</div>
  </div>
          <div style='text-align:right; font-size:0.85rem; color:#4B5563;'>
            ${m.start.split('-')[0]} - ${m.end.split('-')[0]}
          </div>`;
        dList.appendChild(row);
      });

      // 4. Panchangam (Restored & Styled)
      const pan = data.panchangam && data.panchangam.data;
      const pContainer = document.getElementById('panchangamList');
      if (pan && pContainer) {
        // Tamil Translations
        const tithis = ["à®ªà®¿à®°à®¤à®®à¯ˆ", "à®¤à¯à®µà®¿à®¤à®¿à®¯à¯ˆ", "à®¤à¯à®°à®¿à®¤à®¿à®¯à¯ˆ", "à®šà®¤à¯à®°à¯à®¤à¯à®¤à®¿", "à®ªà®žà¯à®šà®®à®¿", "à®šà®·à¯à®Ÿà®¿", "à®šà®ªà¯à®¤à®®à®¿", "à®…à®·à¯à®Ÿà®®à®¿", "à®¨à®µà®®à®¿", "à®¤à®šà®®à®¿", "à®à®•à®¾à®¤à®šà®¿", "à®¤à¯à®µà®¾à®¤à®šà®¿", "à®¤à®¿à®°à®¯à¯‹à®¤à®šà®¿", "à®šà®¤à¯à®°à¯à®¤à¯à®¤à®šà®¿", "à®ªà¯Œà®°à¯à®£à®®à®¿/à®…à®®à®¾à®µà®¾à®šà¯ˆ"];
        const getTamilTithi = (str) => {
          const num = parseInt(str.replace(/[^0-9]/g, ''));
          if (isNaN(num)) return str;
          const idx = (num - 1) % 15;
          const paksha = num <= 15 ? 'à®šà¯à®•à¯à®²' : 'à®•à®¿à®°à¯à®·à¯à®£'; // Shukla / Krishna
          if (num === 15) return "à®ªà¯Œà®°à¯à®£à®®à®¿ (à®šà¯à®•à¯à®²)";
          if (num === 30) return "à®…à®®à®¾à®µà®¾à®šà¯ˆ (à®•à®¿à®°à¯à®·à¯à®£)";
          return `${tithis[idx] || str} (${paksha})`;
        };

        const nakshatras = {
          "Ashwini": "à®…à®¸à¯à®µà®¿à®©à®¿", "Bharani": "à®ªà®°à®£à®¿", "Krittika": "à®•à®¾à®°à¯à®¤à¯à®¤à®¿à®•à¯ˆ", "Rohini": "à®°à¯‹à®•à®¿à®£à®¿", "Mrigashirsha": "à®®à®¿à®°à¯à®•à®šà¯€à®°à®¿à®Ÿà®®à¯", "Ardra": "à®¤à®¿à®°à¯à®µà®¾à®¤à®¿à®°à¯ˆ",
          "Punarvasu": "à®ªà¯à®©à®°à¯à®ªà¯‚à®šà®®à¯", "Pushya": "à®ªà¯‚à®šà®®à¯", "Ashlesha": "à®†à®¯à®¿à®²à¯à®¯à®®à¯", "Magha": "à®®à®•à®®à¯", "Purva Phalguni": "à®ªà¯‚à®°à®®à¯", "Uttara Phalguni": "à®‰à®¤à¯à®¤à®¿à®°à®®à¯",
          "Hasta": "à®¹à®¸à¯à®¤à®®à¯", "Chitra": "à®šà®¿à®¤à¯à®¤à®¿à®°à¯ˆ", "Swati": "à®šà¯à®µà®¾à®¤à®¿", "Vishakha": "à®µà®¿à®šà®¾à®•à®®à¯", "Anuradha": "à®…à®©à¯à®·à®®à¯", "Jyeshtha": "à®•à¯‡à®Ÿà¯à®Ÿà¯ˆ",
          "Mula": "à®®à¯‚à®²à®®à¯", "Purva Ashadha": "à®ªà¯‚à®°à®¾à®Ÿà®®à¯", "Uttara Ashadha": "à®‰à®¤à¯à®¤à®¿à®°à®¾à®Ÿà®®à¯", "Shravana": "à®¤à®¿à®°à¯à®µà¯‹à®£à®®à¯", "Dhanishta": "à®…à®µà®¿à®Ÿà¯à®Ÿà®®à¯", "Shatabhisha": "à®šà®¤à®¯à®®à¯",
          "Purva Bhadrapada": "à®ªà¯‚à®°à®Ÿà¯à®Ÿà®¾à®¤à®¿", "Uttara Bhadrapada": "à®‰à®¤à¯à®¤à®¿à®°à®Ÿà¯à®Ÿà®¾à®¤à®¿", "Revati": "à®°à¯‡à®µà®¤à®¿"
        };

        const yogas = ["à®µà®¿à®·à¯à®•à®®à¯à®ªà®®à¯", "à®ªà¯à®°à¯€à®¤à®¿", "à®†à®¯à¯à®·à¯à®®à®¾à®©à¯", "à®šà¯Œà®ªà®¾à®•à¯à®¯à®®à¯", "à®·à¯‹à®ªà®©à®®à¯", "à®…à®¤à®¿à®•à®£à¯à®Ÿà®®à¯", "à®šà¯à®•à®°à¯à®®à®®à¯", "à®¤à®¿à®°à¯à®¤à®¿", "à®šà¯‚à®²à®®à¯", "à®•à®£à¯à®Ÿà®®à¯", "à®µà®¿à®°à¯à®¤à¯à®¤à®¿", "à®¤à¯à®°à¯à®µà®®à¯", "à®µà¯à®¯à®¾à®•à®¾à®¤à®®à¯", "à®¹à®°à¯à®·à®£à®®à¯", "à®µà®œà¯à®°à®®à¯", "à®šà®¿à®¤à¯à®¤à®¿", "à®µà¯à®¯à®¤à¯€à®ªà®¾à®¤à®®à¯", "à®µà®°à®¿à®¯à®¾à®©à¯", "à®ªà®°à®¿à®•à®®à¯", "à®šà®¿à®µà®®à¯", "à®šà®¿à®¤à¯à®¤à®®à¯", "à®šà®¾à®¤à¯à®¯à®®à¯", "à®šà¯à®ªà®®à¯", "à®šà¯à®ªà¯à®ªà®¿à®°à®®à¯", "à®ªà®¿à®°à®¾à®®à¯à®®à®®à¯", "à®à®¨à¯à®¤à®¿à®°à®®à¯", "à®µà¯ˆà®¤à®¿à®°à¯à®¤à®¿"];
        const getTamilYoga = (str) => {
          const num = parseInt(str.replace(/[^0-9]/g, ''));
          return yogas[num - 1] || str;
        };

        // Karana Logic (1..60 mapping to 11 names)
        const karanasMobile = ["à®ªà®µà®®à¯", "à®ªà®¾à®²à®µà®®à¯", "à®•à¯Œà®²à®µà®®à¯", "à®¤à¯ˆà®¤à¯à®²à®®à¯", "à®•à®°à®šà¯ˆ", "à®µà®©à®šà¯ˆ", "à®ªà®¤à¯à®°à¯ˆ"];
        const karanasFixed = { 58: "à®šà®•à¯à®©à®¿", 59: "à®šà®¤à¯à®·à¯à®ªà®¾à®¤à®®à¯", 60: "à®¨à®¾à®•à®µà®®à¯", 1: "à®•à®¿à®®à¯à®¸à¯à®¤à¯à®•à¯à®©à®®à¯" };

        const getTamilKarana = (str) => {
          const num = parseInt(str.replace(/[^0-9]/g, ''));
          if (isNaN(num)) return str;
          if (karanasFixed[num]) return karanasFixed[num];
          // Cycle of 7 starting from 2
          if (num > 1 && num < 58) {
            const idx = (num - 2) % 7;
            return karanasMobile[idx];
          }
          return str;
        };

        const weekdays = { "Sunday": "à®žà®¾à®¯à®¿à®±à¯", "Monday": "à®¤à®¿à®™à¯à®•à®³à¯", "Tuesday": "à®šà¯†à®µà¯à®µà®¾à®¯à¯", "Wednesday": "à®ªà¯à®¤à®©à¯", "Thursday": "à®µà®¿à®¯à®¾à®´à®©à¯", "Friday": "à®µà¯†à®³à¯à®³à®¿", "Saturday": "à®šà®©à®¿" };

        const labels = { 'Tithi': 'à®¤à®¿à®¤à®¿', 'Nakshatra': 'à®¨à®Ÿà¯à®šà®¤à¯à®¤à®¿à®°à®®à¯', 'Yoga': 'à®¯à¯‹à®•à®®à¯', 'Karana': 'à®•à®°à®£à®®à¯', 'Day': 'à®•à®¿à®´à®®à¯ˆ' };

        // Milk Colors (Pastel)
        const colors = ['#ecfdf5', '#eff6ff', '#fff7ed', '#faf5ff', '#fdf2f8']; // Green, Blue, Orange, Purple, Pink

        const tVal = getTamilTithi(pan.tithiName || '');
        const nVal = nakshatras[pan.nakshatra] || pan.nakshatra || '-';
        const yVal = getTamilYoga(pan.yoga || '');
        const kVal = getTamilKarana(pan.karana || ''); // Use New Function
        const dVal = weekdays[pan.vara] || pan.vara || '-';

        const items = [
          { l: labels.Tithi, v: tVal, c: colors[0] },
          { l: labels.Nakshatra, v: nVal, c: colors[1] },
          { l: labels.Yoga, v: yVal, c: colors[2] },
          { l: labels.Karana, v: kVal, c: colors[3] },
          { l: labels.Day, v: dVal, c: colors[4] }
        ];

        pContainer.className = 'panchangam-grid';
        // Clear conflicting styles
        pContainer.style.display = '';
        pContainer.style.flexDirection = '';


        pContainer.innerHTML = items.map(item => `
          <div style="background: ${item.c};">
            <div style="font-size:0.7rem; color:#666; font-weight:bold; margin-bottom:4px;">${item.l}</div>
            <div style="font-size:0.85rem; color:#333; font-weight:600; line-height:1.2;">${item.v}</div>
          </div>
        `).join('');

        // ==========================================
        // 5) Render Planets List (Tamil)
        // ==========================================
        const planetList = document.getElementById('planetList');
        if (planetList && data.planetaryPositions && data.planetaryPositions.detailed) {

          const planetTam = {
            "Sun": "à®šà¯‚à®°à®¿à®¯à®©à¯", "Moon": "à®šà®¨à¯à®¤à®¿à®°à®©à¯", "Mars": "à®šà¯†à®µà¯à®µà®¾à®¯à¯", "Mercury": "à®ªà¯à®¤à®©à¯",
            "Jupiter": "à®•à¯à®°à¯", "Venus": "à®šà¯à®•à¯à®•à®¿à®°à®©à¯", "Saturn": "à®šà®©à®¿", "Rahu": "à®°à®¾à®•à¯", "Ketu": "à®•à¯‡à®¤à¯",
            "Ascendant": "à®²à®•à¯à®©à®®à¯", "Uranus": "à®¯à¯à®°à¯‡à®©à®¸à¯", "Neptune": "à®¨à¯†à®ªà¯à®Ÿà®¿à®¯à¯‚à®©à¯", "Pluto": "à®ªà¯à®³à¯‚à®Ÿà¯à®Ÿà¯‹"
          };

          const signsTam = {
            "Aries": "à®®à¯‡à®·à®®à¯", "Taurus": "à®°à®¿à®·à®ªà®®à¯", "Gemini": "à®®à®¿à®¤à¯à®©à®®à¯", "Cancer": "à®•à®Ÿà®•à®®à¯",
            "Leo": "à®šà®¿à®®à¯à®®à®®à¯", "Virgo": "à®•à®©à¯à®©à®¿", "Libra": "à®¤à¯à®²à®¾à®®à¯", "Scorpio": "à®µà®¿à®°à¯à®šà¯à®šà®¿à®•à®®à¯",
            "Sagittarius": "à®¤à®©à¯à®šà¯", "Capricorn": "à®®à®•à®°à®®à¯", "Aquarius": "à®•à¯à®®à¯à®ªà®®à¯", "Pisces": "à®®à¯€à®©à®®à¯"
          };

          const pOrder = ["Ascendant", "Sun", "Moon", "Mars", "Mercury", "Jupiter", "Venus", "Saturn", "Rahu", "Ketu"];

          let pHtml = '';
          pOrder.forEach(key => {
            const p = data.planetaryPositions.detailed[key];
            if (!p && key !== 'Ascendant') return;

            // Handle Ascendant special case if not in detailed list but in root
            let info = p;
            if (key === 'Ascendant' && data.ascendant) {
              // normalize to match structure
              info = {
                sign: data.ascendant.sign,
                degree: data.ascendant.degree,
                minute: data.ascendant.minute || 0,
                nakshatra: '-', // Ascendant nakshatra might not be calculated in simple object
                nakshatraPada: '-'
              };
              // Try to find if ascendant details are computed
              // If not, we skip Nakshatra for Ascendant for now or basic calc
            }

            if (!info) return;

            const pName = planetTam[key] || key;
            const signName = signsTam[info.sign] || info.sign;
            const degStr = `${Math.floor(info.degree)}Â° ${info.minute}'`;
            const nakName = nakshatras[info.nakshatra] || info.nakshatra || '-';

            pHtml += `
                <div class="planet-item" style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:white; margin-bottom:8px; border-radius:8px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                  <div style="display:flex; align-items:center; gap:10px;">
                    <div style="width:36px; height:36px; background:${getColorBg(key)}; color:white; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:0.8rem;">
                      ${key.substring(0, 2)}
                    </div>
                    <div>
                      <div style="font-weight:700; color:#374151;">${pName}</div>
                      <div style="font-size:0.75rem; color:#6B7280;">${signName} | ${degStr}</div>
                    </div>
                  </div>
                  <div style="text-align:right;">
                     <div style="font-size:0.8rem; font-weight:600; color:#4B5563;">${nakName}</div>
                     <div style="font-size:0.7rem; color:#9CA3AF;">à®ªà®¾à®¤à®®à¯: ${info.nakshatraPada || 1}</div>
                  </div>
                </div>
               `;
          });
          planetList.innerHTML = pHtml;
        }

        // ==========================================
        // 6) Render Dasha (Tamil)
        // ==========================================
        const dashaList = document.getElementById('dashaList');
        const dashaInfo = document.getElementById('currentDashaInfo');

        if (data.dashaSystem) {
          const planetTamM = {
            "Ketu": "à®•à¯‡à®¤à¯", "Venus": "à®šà¯à®•à¯à®•à®¿à®°à®©à¯", "Sun": "à®šà¯‚à®°à®¿à®¯à®©à¯", "Moon": "à®šà®¨à¯à®¤à®¿à®°à®©à¯",
            "Mars": "à®šà¯†à®µà¯à®µà®¾à®¯à¯", "Rahu": "à®°à®¾à®•à¯", "Jupiter": "à®•à¯à®°à¯", "Saturn": "à®šà®©à®¿", "Mercury": "à®ªà¯à®¤à®©à¯"
          };

          // Current Dasha
          const curr = data.dashaSystem.current;
          if (curr && dashaInfo) {
            const mName = planetTamM[curr.mahadasha?.lord] || curr.mahadasha?.lord || '-';
            const bName = planetTamM[curr.bhukti?.lord] || curr.bhukti?.lord || '-';
            const aName = planetTamM[curr.pratyantar?.lord] || curr.pratyantar?.lord || '-'; // Assuming API sends pratyantar or antaram
            // Note: API sends 'pratyantar' key as level 3 usually.

            dashaInfo.innerHTML = `
                <div style="background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
                   <div style="font-size:0.75rem; opacity:0.9; text-transform:uppercase; letter-spacing:1px; margin-bottom:5px;">à®¤à®±à¯à®ªà¯‹à®¤à¯ˆà®¯ à®¤à®šà¯ˆ</div>
                   <div style="font-size:1.1rem; font-weight:bold;">${mName} à®®à®•à®¾à®¤à®¿à®šà¯ˆ</div>
                   <div style="display:flex; margin-top:10px; gap:10px;">
                      <span style="background:rgba(255,255,255,0.2); padding:4px 8px; border-radius:6px; font-size:0.8rem;">à®ªà¯à®•à¯à®¤à®¿: ${bName}</span>
                      <span style="background:rgba(255,255,255,0.2); padding:4px 8px; border-radius:6px; font-size:0.8rem;">à®…à®¨à¯à®¤à®°à®®à¯: ${aName}</span>
                   </div>
                   <div style="margin-top:8px; font-size:0.75rem; opacity:0.8;">à®®à¯à®Ÿà®¿à®µà¯: ${curr.mahadasha?.end || '-'}</div>
                </div>
              `;
          }

          // Sequence
          if (data.dashaSystem.sequence && dashaList) {
            dashaList.innerHTML = data.dashaSystem.sequence.map(d => {
              const dName = planetTamM[d.lord] || d.lord;
              return `
                     <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; align-items:center;">
                        <div style="font-weight:600; color:#333;">${dName}</div>
                        <div style="font-size:0.8rem; color:#666;">
                           ${d.start.split('-').reverse().join('-')}  à®®à¯à®¤à®²à¯  ${d.end.split('-').reverse().join('-')}
                        </div>
                     </div>
                   `;
            }).join('');
          }
        }

        // Helper for color
        function getColorBg(p) {
          const map = { 'Sun': '#ef4444', 'Moon': '#3b82f6', 'Mars': '#b91c1c', 'Mercury': '#10b981', 'Jupiter': '#f59e0b', 'Venus': '#ec4899', 'Saturn': '#374151', 'Rahu': '#1f2937', 'Ketu': '#4b5563', 'Ascendant': '#8b5cf6' };
          return map[p] || '#6b7280';
        }

      }
    }

  </script>
</body>

</html>